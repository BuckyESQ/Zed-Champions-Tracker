<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StableFields ZED Champions Tracker</title>
    <meta name="description" content="Track your ZED Champions horses, races, and breeding operations with this comprehensive management tool.">
    <meta name="keywords" content="ZED Champions, horse tracker, racing tracker, breeding tracker">
    <meta property="og:title" content="StableFields ZED Champions Tracker">
    <meta property="og:description" content="Complete management tool for ZED Champions players">
    <meta property="og:image" content="https://stablefields.com/path/to/preview-image.jpg">
    <meta property="og:url" content="https://stablefields.com/">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20stroke%3D%22%2303dac6%22%20stroke-width%3D%222%22%3E%3Cpolyline%20points%3D%222%2C14%206%2C8%2010%2C10%2014%2C4%22%2F%3E%3C%2Fsvg%3E">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Exo+2:ital,wght@0,100..900;1,100..900&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&family=Segoe+UI&display=swap" rel="stylesheet">
    
    <!-- External libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin=anonymous referrerpolicy=no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        /* Theme Colors and Variables */
        :root {
            --primary-color: #2e86c1;
            --secondary-color: #3498db;
            --accent-color: #0EB3E3;
            --background-color: #1a1a1a;
            --text-color: #f0f0f0;
            --muted-text: #8e9ea9;
            --border-color: #444;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FFC107;
            --tab-bg: #2c3e50;
            --tab-active-bg: #34495e;
            --section-bg: rgba(45, 52, 54, 0.8);
            --input-bg: rgba(255, 255, 255, 0.1);
        }
        
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-color);
            margin-top: 0;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Layout Components */
        .section {
            background-color: var(--section-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: 1px solid #3a3a3a;
        }
        
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        /* Tab Navigation */
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .tab-button {
            background-color: var(--tab-bg);
            border: none;
            color: var(--text-color);
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .tab-button:hover {
            background-color: var(--tab-active-bg);
        }
        
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Form Elements */
        input, select, textarea {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px 12px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(14, 179, 227, 0.15);
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--muted-text);
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background-color: rgba(0,0,0,0.15);
            border-radius: 4px;
            overflow: hidden;
        }
        
        th {
            text-align: left;
            background-color: var(--tab-bg);
            color: var(--secondary-color);
            padding: 12px 8px;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        tbody tr:hover {
            background-color: rgba(255,255,255,0.05);
        }
        
        /* Welcome Banner */
        #welcome-banner {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(14, 179, 227, 0.1) 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid rgba(46, 134, 193, 0.3);
        }
        
        #welcome-banner h2 {
            margin-top: 0;
        }
        
        #welcome-banner a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        #welcome-banner a:hover {
            text-decoration: underline;
        }
        
        /* Import Status */
        .import-status {
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        /* Emergency Reset */
        #emergency-reset-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 12px;
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Augment styles from ZedSight */
        .augment-empty {
            color: var(--muted-text);
            font-style: italic;
        }
        .augment-gx {
            color: #4CAF50;
            font-weight: bold;
        }
        .augment-crimson {
            color: #F44336;
            font-weight: bold;
        }
        .augment-midnight {
            color: #3F51B5;
            font-weight: bold;
        }
        .augment-darklight {
            color: #FF9800;
            font-weight: bold;
        }
        .augment-void {
            color: #9C27B0;
            font-weight: bold;
        }
        
        /* Enhanced import UI */
        .import-success {
            background-color: rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .horse-preview {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .horse-image {
            width: 80px;
            height: 80px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--accent-color);
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style for star ratings */
        .star-rating {
            color: #ffc107;
            font-size: 16px;
        }

        .star-rating .fa-star-half-alt {
            margin-left: -4px;
        }

        .star-rating .far.fa-star {
            color: rgba(255, 193, 7, 0.3);
        }

        .rating-value {
            color: var(--text-color);
            margin-left: 5px;
        }
        
        /* Horse search section */
        .horse-search-container {
            margin-top: 20px;
        }

        .search-field-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-input-wrapper {
            flex: 1;
            min-width: 200px;
        }

        .search-input-wrapper label {
            display: block;
            margin-bottom: 5px;
        }

        .horse-search-input, .horse-id-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-color);
            border-radius: 4px;
        }

        .horse-results {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .horse-result-item {
            padding: 15px;
            border-radius: 4px;
            background-color: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .horse-result-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .horse-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .horse-details {
            color: var(--muted-text);
            font-size: 14px;
        }

        .horse-result-bloodline {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 10px;
            display: inline-block;
        }

        .bloodline-nakamoto {
            background-color: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        .bloodline-szabo {
            background-color: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }

        .bloodline-finney {
            background-color: rgba(255, 193, 7, 0.2);
            color: #FFC107;
        }

        .bloodline-buterin {
            background-color: rgba(156, 39, 176, 0.2);
            color: #9C27B0;
        }

        .import-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* API Import Section */
        .import-section {
            margin-bottom: 25px;
        }
        
        .import-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        
        #api-connection-status {
            display: none;
            margin-top: 15px;
        }
        
        .token-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .token-input-container input {
            flex: 1;
            min-width: 300px;
        }
        
        /* Tables and Grids */
        #horses-table {
            max-width: 2200px; /* Increase from 1500px */
            min-width: 1200px; /* Ensure minimum width */
            width: 100%;
            table-layout: fixed;
        }

        /* Subtle Border Colors for Field Types */
        /* Stars (Racing, Breeding, External Sire) */
        #horse-stars, #horse-speed-stars, #horse-sprint-stars, #horse-endurance-stars,
        #breeding-horse-stars, #breeding-horse-speed-stars, #breeding-horse-sprint-stars, #breeding-horse-endurance-stars,
        #bred-overall-stars, #bred-speed-stars, #bred-sprint-stars, #bred-endurance-stars,
        #external-sire-overall-stars, #external-sire-speed-stars, #external-sire-sprint-stars, #external-sire-endurance-stars {
            border-left: 3px solid rgba(255, 193, 7, 0.4);
        }
        
        /* Parent Selects */
        #bred-sire, #bred-dam {
            border-left: 3px solid rgba(76, 175, 80, 0.4);
        }
        
        /* Financial Fields */
        #horse-zed-balance, #race-zed-change, #bred-stud-fee {
            border-left: 3px solid rgba(0, 188, 212, 0.4);
        }

        /* Ensure focus state overrides subtle borders */
        #horse-stars:focus, #horse-speed-stars:focus, #horse-sprint-stars:focus, #horse-endurance-stars:focus,
        #breeding-horse-stars:focus, #breeding-horse-speed-stars:focus, #breeding-horse-sprint-stars:focus, #breeding-horse-endurance-stars:focus,
        #bred-overall-stars:focus, #bred-speed-stars:focus, #bred-sprint-stars:focus, #bred-endurance-stars:focus,
        #external-sire-overall-stars:focus, #external-sire-speed-stars:focus, #external-sire-sprint-stars:focus, #external-sire-endurance-stars:focus,
        #bred-sire:focus, #bred-dam:focus,
        #horse-zed-balance:focus, #race-zed-change:focus, #bred-stud-fee:focus {
            border-left-color: var(--accent-color);
        }
        
        /* Default Form Grid Layouts */
        #add-horse-form .form-grid {
            grid-template-columns: repeat(4, 1fr);
        }
        
        #add-race-form .form-grid {
            grid-template-columns: repeat(4, 1fr);
        }
        
        #add-breeding-horse-form .form-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        #add-bred-horse-form .form-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        #add-augment-form .form-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        /* --- Responsive Design --- */

        /* Medium Screens (Tablets, smaller laptops) */
        @media (max-width: 992px) {
            #add-race-form .form-grid {
                grid-template-columns: repeat(3, 1fr); /* Adjust to 3 columns */
            }
            #add-breeding-horse-form .form-grid,
            #add-bred-horse-form .form-grid {
                grid-template-columns: repeat(2, 1fr); /* Adjust to 2 columns */
            }
            #add-augment-form .form-grid {
                grid-template-columns: 1fr; /* Stack augment fields */
                gap: 15px;
            }
            #add-augment-form .form-grid div:last-child {
                justify-self: start; /* Align button to start */
            }
            #augments-list ul {
                 column-count: 2; /* Use 2 columns for augments list */
            }
        }

        /* Small Screens (Phones) */
        @media (max-width: 600px) {
            body {
                padding: 15px; /* Reduce body padding */
            }
            .section {
                padding: 15px; /* Reduce section padding */
            }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }
            h3 { font-size: 1.2em; }

            /* Stack all form grids to 1 column */
            .form-grid {
                grid-template-columns: 1fr !important; /* Override specific form grids */
            }
            #add-augment-form .form-grid {
                 grid-template-columns: 1fr !important; /* Ensure override */
            }
            #augments-list ul {
                column-count: 1; /* Use 1 column for augments list */
            }
            .tab-button {
                padding: 8px 12px; /* Smaller tab buttons */
                font-size: 0.9em;
            }
            .modal-content {
                 width: 90%; /* Wider modal on small screens */
                 margin: 5% auto;
                 padding: 20px;
            }
        }
        
        /* Content Wrapper for constraining width */
        .content-wrapper {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* Control Name column width */
        #horses-table th:nth-child(1), /* Name */
        #horses-table td:nth-child(1) {
            width: 200px;
            max-width: 200px;
        }
        
        /* --- Breeding Tab Table Styles --- */

        /* Add space above breeding history title */
        #add-bred-horse-form + h3 {
            margin-top: 30px;
        }

        /* Registered Breeding Horses Table */
        #breeding-horses-table {
            min-width: 800px;
            width: 100%;
        }
        
        #breeding-horses-table th:nth-child(1), /* Name */
        #breeding-horses-table td:nth-child(1) {
            width: 20%;
        }
        
        #breeding-horses-table th:nth-child(3), /* Gender */
        #breeding-horses-table td:nth-child(3) {
            width: 10%;
        }
        
        #breeding-horses-table th:nth-child(4), /* Stars */
        #breeding-horses-table td:nth-child(4) {
            width: 10%;
        }
        
        #breeding-horses-table th:nth-child(5), /* Actions */
        #breeding-horses-table td:nth-child(5) {
            width: 15%;
        }
        
        /* Bred Horse History Table */
        #bred-horses-table {
            min-width: 1100px;
        }
        
        #bred-horses-table th {
            white-space: nowrap;
        }
        
        #bred-horses-table th:nth-child(1), /* Bred Date */
        #bred-horses-table td:nth-child(1) {
            width: 90px;
        }
        
        #bred-horses-table th:nth-child(2), /* Name */
        #bred-horses-table td:nth-child(2) {
            width: 140px;
        }
        
        #bred-horses-table th:nth-child(3), /* Bloodline */
        #bred-horses-table td:nth-child(3) {
            width: 100px;
        }
        
        #bred-horses-table th:nth-child(4), /* Gender */
        #bred-horses-table td:nth-child(4) {
            width: 70px;
        }
        
        #bred-horses-table th:nth-child(5), /* Sire */
        #bred-horses-table td:nth-child(5),
        #bred-horses-table th:nth-child(6), /* Dam */
        #bred-horses-table td:nth-child(6) {
            width: 140px;
        }
        
        #bred-horses-table th:nth-child(7), /* Overall */
        #bred-horses-table td:nth-child(7),
        #bred-horses-table th:nth-child(8), /* Speed */
        #bred-horses-table td:nth-child(8),
        #bred-horses-table th:nth-child(9), /* Sprint */
        #bred-horses-table td:nth-child(9),
        #bred-horses-table th:nth-child(10), /* Endurance */
        #bred-horses-table td:nth-child(10) {
            width: 70px;
        }
        
        #bred-horses-table th:nth-child(11), /* Stud Fee */
        #bred-horses-table td:nth-child(11) {
            width: 90px;
        }
        
        #bred-horses-table th:nth-child(12), /* Actions */
        #bred-horses-table td:nth-child(12) {
            width: 100px;
        }
        
        /* --- Race History Table Styles --- */
        #races-table {
            min-width: 1100px;
        }
        
        #races-table th:nth-child(9), /* Actions */
        #races-table td:nth-child(9) {
            width: 100px;
        }

        /* New CSS for Net / ROI column */
        #horses-table th:nth-child(8), /* Net / ROI */
        #horses-table td:nth-child(8) {
            width: 110px;
        }
        
        #horses-table th:nth-child(9), /* Win % (shifted) */
        #horses-table td:nth-child(9) {
            width: 80px;
        }
        
        /* --- Pagination Styles --- */
        .pagination-button {
            padding: 5px 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .pagination-button:disabled {
            background-color: #666;
            cursor: default;
        }

        /* Enhanced pagination controls alignment */
        .pagination-controls {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-controls select,
        .pagination-controls button,
        .pagination-controls span {
            height: 32px;
            line-height: 32px;
            display: inline-flex;
            align-items: center;
        }

        .pagination-controls select,
        .pagination-select {
            padding-top: 0;
            padding-bottom: 0;
            text-align: center; /* Center the text */
            padding-left: 8px; /* Adjust padding to center visually */
            padding-right: 18px; /* Add extra space for the dropdown arrow */
            height: 32px; /* Ensure consistent height */
        }

        .pagination-controls label {
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
            height: 32px;
        }

        .pagination-controls div {
            display: inline-flex;
            align-items: center;
            height: 32px;
        }

        .pagination-controls span[id$='-page-info'] {
            margin: 0 5px;
        }

        /* --- Filter Controls --- */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(5, minmax(120px, 180px)); /* 5 columns with min/max width */
            grid-gap: 10px;
            margin-bottom: 15px;
            max-width: 100%; /* Allow full width */
            justify-content: start; /* Align grid to the start */
        }

        .filter-item {
            padding: 8px 10px;
            height: 38px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9em;
            width: 100%; /* Take full width of grid cell */
            max-width: 180px; /* But no wider than this */
        }
        
        .filter-item:focus {
            border-color: var(--accent-color);
        }
        
        /* Specific widths */
        #horse-search-input {
            min-width: 200px;
        }
        
        .filter-item-small { /* Class for smaller inputs like MMR range */
            width: 80px;
            min-width: 80px;
        }
        
        /* --- Augment Analysis Per Horse (Racing Tab) --- */
        #augment-analysis-content table {
            min-width: 800px;
        }
        
        #augment-analysis-content th,
        #augment-analysis-content td {
            text-align: center;
        }
        
        #augment-analysis-content th:nth-child(1),
        #augment-analysis-content td:nth-child(1) { /* Augment Combo */
            text-align: left;
            width: 40%;
        }
        
        #augment-analysis-content th:nth-child(2), /* Races */
        #augment-analysis-content td:nth-child(2) {
            width: 10%;
        }
        
        #augment-analysis-content th:nth-child(3), /* Win % */
        #augment-analysis-content td:nth-child(3) {
            width: 10%;
        }
        
        #augment-analysis-content th:nth-child(4), /* Avg Place */
        #augment-analysis-content td:nth-child(4) {
            width: 12%;
        }
        
        #augment-analysis-content th:nth-child(5), /* Avg Odds */
        #augment-analysis-content td:nth-child(5) {
            width: 12%;
        }
        
        /* --- Analysis Tab Table Styles --- */
        #bloodline-analysis-table,
        #individual-augment-table,
        #augment-pair-table,
        #augment-triple-table {
            min-width: 800px;
        }
        
        /* --- Shared Analysis Table Column Styles (Excluding Bloodline) --- */
        #individual-augment-table th:not(:nth-child(1)):not(:nth-child(2)),
        #individual-augment-table td:not(:nth-child(1)):not(:nth-child(2)),
        #augment-pair-table th:not(:nth-child(1)),
        #augment-pair-table td:not(:nth-child(1)),
        #augment-triple-table th:not(:nth-child(1)),
        #augment-triple-table td:not(:nth-child(1)) {
            width: 12%;
            text-align: center;
        }
        
        /* --- Individual Augment Table Specifics --- */
        #individual-augment-table th:nth-child(1),
        #individual-augment-table td:nth-child(1) { /* Augment Name */
            width: 30%;
            text-align: left;
        }
        
        #individual-augment-table th:nth-child(2),
        #individual-augment-table td:nth-child(2) { /* Type */
            width: 10%;
            text-align: left;
        }
        
        /* --- Augment Pair Table Specifics --- */
        #augment-pair-table th:nth-child(1),
        #augment-pair-table td:nth-child(1) { /* Augment Pair */
            width: 40%;
            text-align: left;
        }
        
        /* --- Triple Augment Table Specifics --- */
        #augment-triple-table th:nth-child(1),
        #augment-triple-table td:nth-child(1) { /* Augment Combination */
            width: 40%;
            text-align: left;
        }
        
        /* Column Widths for Bloodline Table */
        #bloodline-analysis-table {
            min-width: 700px;
        }
        
        #bloodline-analysis-table th:nth-child(1),
        #bloodline-analysis-table td:nth-child(1) { /* Bloodline */
            width: 20%;
            text-align: left;
        }
        
        #bloodline-analysis-table th:nth-child(2),
        #bloodline-analysis-table td:nth-child(2) { /* Races */
            width: 10%;
            text-align: center;
        }
        
        #bloodline-analysis-table th:nth-child(3),
        #bloodline-analysis-table td:nth-child(3) { /* Win % */
            width: 10%;
            text-align: center;
        }
        
        #bloodline-analysis-table th:nth-child(4),
        #bloodline-analysis-table td:nth-child(4) { /* Avg Place */
            width: 10%;
            text-align: center;
        }
        
        #bloodline-analysis-table th:nth-child(5),
        #bloodline-analysis-table td:nth-child(5) { /* Avg Odds */
            width: 10%;
            text-align: center;
        }
        
        /* --- Analysis Tab Filter Alignment --- */
        .analysis-filter-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        /* Reset all special positioning */
        .analysis-filter-controls > div,
        .analysis-filter-controls label,
        .analysis-filter-controls select,
        .analysis-filter-controls input,
        .analysis-filter-controls button {
            margin: 0;
            line-height: normal;
        }
        
        /* Create a special class just for the button to force alignment */
        #augment-analysis-refresh {
            align-self: flex-end;
        }
        
        /* Remove any specific adjustments from previous attempts */
        #augment-analysis-bloodline-filter,
        #augment-analysis-min-races {
            margin: 0;
            vertical-align: middle;
        }
        
        .analysis-filter-controls label {
            margin-bottom: 5px;
            display: block;
        }
        
        /* Specific adjustments for the bloodline select */
        #augment-analysis-bloodline-filter.pagination-select {
            height: 38px;
            padding: 0 10px;
        }
        
        /* Specific adjustments for the min races input */
        #augment-analysis-min-races.filter-item {
            height: 38px;
            padding: 0 10px;
            width: 70px;
            text-align: center;
        }
        
        /* Refresh button specific styles - ensure consistency */
        .analysis-filter-controls button,
        #augment-analysis-refresh.button {
            height: 38px;
            padding: 0 15px;
            margin-top: 21px;
        }
        
        /* Ensure all elements in the filter row have the same visual grouping */
        #augment-analysis-bloodline-filter,
        #augment-analysis-min-races,
        #augment-analysis-refresh {
            border-radius: 4px;
        }
        
        /* Create a completely new container for perfect alignment */
        .analysis-filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .analysis-filter-item {
            display: flex;
            flex-direction: column;
        }
        
        .analysis-filter-item label {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        /* Style the button specifically */
        #augment-analysis-refresh {
            align-self: flex-end;
        }
        
        /* Match heights of all interactive elements */
        .analysis-filter-row select,
        .analysis-filter-row input,
        .analysis-filter-row button {
            height: 38px;
        }
        
        /* Ensure action buttons display inline and have spacing */
        .action-button {
            display: inline-block;
            margin-right: 5px;
        }
        
        /* Make sure augment combo cells don't wrap to multiple lines */
        /* Target tables where the first column displays augment combinations */
        #augment-analysis-content table td:first-child,
        #augment-triple-table td:first-child,
        #augment-pair-table td:first-child,
        #modal-analysis-content table td:first-child,
        #comboTable td:first-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Adjust width for MMR column */
        #augment-analysis-content table td:nth-child(6),
        #augment-analysis-content table th:nth-child(6) {
            width: 10%;
        }
    </style>
</head>
    <style>
        /* Add these styles for the enhanced import UI */
        .import-success {
          padding: 12px;
        }

        .horse-preview {
          display: flex;
          gap: 20px;
          margin-top: 15px;
        }

        .horse-image {
          width: 80px;
          height: 80px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .spinner {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(255,255,255,.3);
          border-radius: 50%;
          border-top-color: var(--highlight-color);
          animation: spin 1s ease-in-out infinite;
          margin-right: 10px;
          vertical-align: middle;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        /* Style for star ratings */
        .star-rating {
          display: inline-block;
          color: gold;
          font-size: 0.9em;
        }

        .star-rating .fa-star-half-alt {
          color: gold;
        }

        .star-rating .far.fa-star {
          color: var(--muted-text);
        }

        .rating-value {
          color: var(--muted-text);
          font-size: 0.85em;
          margin-left: 4px;
        }

        /* Import status message styling */
        .import-status {
            display: none;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        /* Add to your style section */
        .horse-search-container {
          margin-bottom: 20px;
        }

        .search-field-group {
          display: flex;
          flex-direction: column;
          gap: 10px;
          margin-bottom: 15px;
        }

        .search-row {
          display: flex;
          gap: 10px;
          align-items: flex-end;
        }

        .search-input-wrapper {
          display: flex;
          flex-direction: column;
          flex: 1;
        }

        .search-input-wrapper label {
          margin-bottom: 5px;
          color: var(--text-color);
        }

        .horse-search-input, .horse-id-input {
          padding: 8px 12px;
          border-radius: 4px;
          border: 1px solid var(--border-color);
          background-color: var(--input-bg);
          color: var(--text-color);
          font-size: 14px;
          width: 100%;
        }

        .horse-results {
          max-height: 400px;
          overflow-y: auto;
          display: none;
          margin-top: 15px;
          border-radius: 8px;
          border: 1px solid var(--border-color);
          background-color: var(--section-bg);
        }

        .horse-result-item {
          padding: 12px 15px;
          border-bottom: 1px solid var(--border-color);
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .horse-result-item:hover {
          background-color: rgba(187, 134, 252, 0.1);
        }

        .horse-name {
          font-weight: 700;
          font-size: 16px;
        }

        .horse-details {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 10px;
          margin-top: 8px;
        }

        .horse-result-bloodline {
          color: var(--muted-text);
          margin-left: 10px;
        }

        .bloodline-nakamoto {
          border-left: 3px solid rgba(207, 102, 121, 0.8);
        }

        .bloodline-szabo {
          border-left: 3px solid rgba(3, 218, 198, 0.8);
        }

        .bloodline-finney {
          border-left: 3px solid rgba(187, 134, 252, 0.8);
        }

        .bloodline-buterin {
          border-left: 3px solid rgba(255, 235, 59, 0.8);
        }

        .import-actions {
          margin-top: 10px;
          display: flex;
          gap: 8px;
        }

        /* Add this to your style section */
        .import-section {
          margin-bottom: 30px;
          padding: 20px;
          background-color: var(--section-bg);
          border-radius: 8px;
        }
        
        .import-status {
          margin-top: 10px;
          padding: 10px;
          border-radius: 4px;
          display: none;
        }
        
        #api-connection-status {
          margin-top: 15px;
          padding: 12px;
          border-radius: 4px;
        }
        
        .token-input-container {
          display: flex;
          gap: 10px;
          align-items: center;
          margin-bottom: 15px;
        }
        
        .token-input-container input {
          flex-grow: 1;
        }

        /* Basic Reset & Variables */
       :root {
        --bg-color: #1a1a1a;
        --text-color: #f0f0f0;
        --text-muted-color: #a0a0a0;
        --border-color: #444; /* Default border */
        --border-color-stars: #7d681f; /* Subtle gold/yellow for stars */
        --border-color-parent: #5e5570; /* Subtle purple for lineage */
        --border-color-money: #2a704a;  /* Subtle green for currency */
        --accent-color: #3498db; /* Brighter Blue accent (Used for focus) */
        --link-color: #85c1e9;  /* Brighter Light Blue link */
        --input-bg: #333;
        --button-bg: #2e86c1;  /* Brighter Button Blue */
        --button-hover-bg: #2471a3; /* Deeper blue for hover */
        --tab-bg: #2a2a2a;
        --tab-active-bg: #3a3a3a;
        --section-bg: #252525; /* Slightly darker section background */
        --error-color: #f44336;
        --success-color: #4caf50;
        --title-font: 'Orbitron', sans-serif;
        --body-font: 'Inter', sans-serif;
        --text-highlight-bg: var(--bg-color); /* Use main bg for TH text highlight */
        }

        body {
            font-family: var(--body-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: var(--accent-color);
            padding-bottom: 0.3em;
            margin-top: 1.5em;
            margin-bottom: 1em;
        }
        h1 {
            font-size: 2.2em; /* Slightly larger */
            font-family: var(--title-font);
            font-weight: 700; /* Boldness for Orbitron */
            letter-spacing: 1px; /* Slight spacing */
        }
        h2 { 
            font-size: 1.6em; 
            border-bottom: 1px solid var(--border-color); /* Restore original border */
            padding-bottom: 0.3em; /* Restore original padding */
        }
        h3 { 
            font-size: 1.3em; 
            margin-top: 1em; 
            border-bottom: none; /* Explicitly no border */
        }

        .swatch {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid #bbb;
            vertical-align: middle;
            margin-right: 6px;
        }
        /* Layout & Sections */
        .section {
            background-color: var(--section-bg);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            transition: all 0.2s ease-in-out;
            margin-bottom: 30px; /* Increased space between sections */
        }

        /* Forms */
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 5px; /* Subtle padding */
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
            gap: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-muted-color);
            font-size: 0.9em; /* Slightly smaller for refinement */
            letter-spacing: 0.5px; /* Subtle letter spacing */
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            box-sizing: border-box; /* Include padding in width */
            transition: all 0.2s ease;
            height: 42px; /* Standardize height */
            outline: none; /* Remove default focus outline */
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); /* Subtle glow effect */
        }
        select {
            appearance: none; /* Custom dropdown arrow styling might be needed */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px; /* Space for the arrow */
        }
        button[type="submit"], .button {
            background-color: var(--button-bg);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
            align-self: flex-start; /* Align button to the start */
            height: 44px; /* Standardize height */
            font-weight: 500; /* Slightly bolder */
            letter-spacing: 0.5px; /* Subtle letter spacing */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Subtle drop shadow */
            transition: all 0.2s ease;
        }
        button[type="submit"]:hover, .button:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.25); /* Enhanced shadow on hover */
            transform: translateY(-1px); /* Subtle lift effect */
        }
        button[type="submit"]:active, .button:active {
            transform: translateY(1px); /* Subtle press effect */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15); /* Reduced shadow when pressed */
        }
        .action-button {
            padding: 6px;
            font-size: 0.9em;
            /* margin-right: 5px; REMOVED - using margin: 0 2px instead */
            min-width: auto;
            width: 32px;
            height: 32px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            vertical-align: middle; /* Align buttons vertically */
            margin: 1px 2px; /* Add small vertical and horizontal margin */
        }
        .action-button svg {
            width: 16px; /* Icon size */
            height: 16px; /* Icon size */
            stroke-width: 2px; /* Consistent stroke */
            vertical-align: middle; /* Align icon */
        }
        .delete-button {
            background-color: var(--error-color);
        }
        .delete-button:hover {
            background-color: #d32f2f; /* Darker red */
        }

        /* Style for visually grouping star inputs */
        .star-input-field {
            background-color: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px; /* Add some space above the group */
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle shadow for depth */
            overflow: hidden; /* Ensures the border-radius is respected */
            border-radius: 4px; /* Rounded corners */
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            transition: background-color 0.15s ease; /* Smooth transition */
        }
        th {
            background-color: var(--tab-active-bg);
            color: var(--accent-color);
            font-weight: bold;
            /* Apply highlight effect */
            background-color: var(--text-highlight-bg); /* Keep main bg color for TH */
            padding: 8px 12px; /* Adjust padding for highlight */
            border-radius: 3px 3px 0 0; /* Round top corners */
            /* We might need to adjust border styles if this looks odd */
            letter-spacing: 0.7px; /* Slightly increase letter spacing */
            text-transform: uppercase; /* UPPERCASE for headers */
            font-size: 0.85em; /* Slightly smaller text */
        }
        tbody tr:nth-child(odd) {
            background-color: var(--section-bg); /* Slightly different for striping */
        }
        tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.08); /* Subtle blue highlight on hover */
            cursor: default; /* Show this is interactive */
        }
        /* Adding subtle animation for buttons within tables */
        tbody tr td button {
            transition: all 0.2s ease;
        }
        tbody tr:hover td button {
            transform: translateX(2px); /* Subtle shift on row hover */
        }

        /* Tabs */
        #tab-buttons {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px; /* More space below tabs */
            padding-bottom: 2px; /* Subtle padding below tabs */
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: var(--tab-bg);
            color: var(--text-muted-color);
            border-radius: 5px 5px 0 0;
            font-size: 1em;
            transition: all 0.2s ease; /* Smooth transition */
            position: relative; /* For indicator */
            letter-spacing: 0.5px; /* Subtle spacing */
        }
        .tab-button.active {
            background-color: var(--section-bg); /* Match active tab content bg */
            color: var(--accent-color);
            font-weight: bold;
            border: 1px solid var(--border-color);
            border-bottom: 1px solid var(--section-bg); /* Hide bottom border */
            position: relative;
            top: 1px; /* Align with content area */
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1); /* Subtle shadow on active tab */
        }
        /* Add subtle hover effect for non-active tabs */
        .tab-button:not(.active):hover {
            background-color: rgba(52, 152, 219, 0.1); /* Very subtle blue hover */
            color: var(--link-color); /* Lighter blue on hover */
        }
        .tab-content {
            display: none;
        }
        /* Make sure inactive tabs are truly hidden */
        .tab-content:not(.active) {
          display: none !important;
        }

        /* Clear display styles */
        .tab-content.active {
          display: block !important;
          animation: fadeIn 0.3s ease-in-out; /* Subtle fade in animation */
        }

        /* Fix tab buttons */
        .tab-button {
          position: relative;
          cursor: pointer;
          padding: 10px 15px;
          background-color: var(--tab-bg);
          border: none;
          color: var(--text-color);
          transition: all 0.2s ease;
        }

        .tab-button.active {
          background-color: var(--tab-active-bg);
          color: var(--link-color);
          font-weight: bold;
        }

        /* API connection status */
        #api-connection-status {
          margin-top: 10px;
          padding: 10px;
          border-radius: 4px;
          display: none;
        }

        /* Import status */
        .import-status {
          margin-top: 10px;
          padding: 10px;
          border-radius: 4px;
          display: none;
        }

        /* Add animation keyframes */
        @keyframes fadeIn {
            from { opacity: 0.85; }
            to { opacity: 1; }
        }

        /* Augments List Specific */
        #augments-list ul {
            list-style: none;
            padding: 0;
            column-count: 3; /* Display in columns */
            column-gap: 20px;
            margin-top: 10px; /* Add some space below the heading */
        }
        #augments-list li {
            margin-bottom: 8px;
            background-color: var(--input-bg);
            padding: 8px 12px; /* Slightly adjust padding */
            border-radius: 4px; /* Match other elements */
            transition: all 0.2s ease; /* Added smooth transition */
            display: flex; /* Use flexbox */
            justify-content: space-between; /* Push button to the right */
            align-items: center; /* Vertically align items */
        }
        #augments-list li span { /* Target the text span */
            flex-grow: 1; /* Allow text to take available space */
            margin-right: 10px; /* Space between text and button */
        }
        #augments-list li:hover {
            transform: translateX(2px); /* Subtle shift on hover */
            background-color: var(--tab-active-bg); /* Use tab active bg for hover */
        }
        /* Styling for the delete button within the augment list */
        .augment-manage-list button {
            padding: 4px; /* Reduce padding */
            width: auto; /* Let icon size dictate width */
            height: auto; /* Let icon size dictate height */
            background: none; /* Remove default background */
            border: none; /* Remove border */
            box-shadow: none; /* Remove shadow */
            cursor: pointer;
            opacity: 0.6; /* Make it less prominent initially */
            transition: all 0.2s ease;
        }
        .augment-manage-list button svg {
            stroke: var(--text-muted-color); /* Muted icon color */
            width: 18px; /* Slightly larger icon */
            height: 18px;
        }
        /* Enhance button on list item hover */
        #augments-list li:hover button {
            opacity: 1;
        }
        #augments-list li:hover button svg {
            stroke: var(--error-color); /* Red icon on hover */
        }

        /* Stats Specific */
        #overall-stats p {
            font-size: 1.1em;
            background-color: var(--input-bg);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            transition: all 0.2s ease; /* Added smooth transition */
        }
        #overall-stats p:hover {
            background-color: rgba(52, 152, 219, 0.08); /* Subtle highlight on hover */
        }
        #overall-stats strong {
            color: var(--accent-color);
            min-width: 180px;
            display: inline-block;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Darker backdrop */
            backdrop-filter: blur(2px); /* Subtle blur effect (works in modern browsers) */
        }
        .modal-content {
            background-color: var(--section-bg);
            margin: 10% auto; /* Centered */
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 700px; /* Max width */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            animation: modalIn 0.3s ease-out; /* Modal entry animation */
        }
        /* Modal animation keyframes */
        @keyframes modalIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-close {
            color: var(--text-muted-color);
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: var(--text-color);
            transform: scale(1.1); /* Slight grow effect */
        }
        .modal-content h3 {
            color: var(--accent-color);
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5em;
        }
         .modal-stats p {
             margin: 0.5em 0;
             font-size: 1.1em;
         }
         .modal-stats strong {
             color: var(--text-muted-color);
             min-width: 100px;
             display: inline-block;
         }
         .modal-content table {
             margin-top: 1.5em;
         }

        /* Sortable Table Header Styling */
        #horses-table th[data-sort-key] {
            cursor: pointer;
            position: relative;
        }
        #horses-table th[data-sort-key]::after {
            content: '\00a0\2195'; /* Up/Down arrow, non-breaking space */
            opacity: 0.3;
            position: absolute;
            right: 0.5em;
            top: 50%;
            transform: translateY(-50%);
        }
        #horses-table th.sort-asc[data-sort-key]::after,
        #horses-table th.sort-desc[data-sort-key]::after {
            opacity: 1;
        }
        #horses-table th.sort-asc[data-sort-key]::after {
            content: '\00a0\25B2'; /* Up arrow */
        }
        #horses-table th.sort-desc[data-sort-key]::after {
            content: '\00a0\25BC'; /* Down arrow */
        }

        /* Specific Column Widths for Racing Table */
        #horses-table th:nth-child(3), /* Gender */
        #horses-table td:nth-child(3) {
            width: 80px;
            text-align: center;
        }

        #horses-table th:nth-child(5), /* MMR */
        #horses-table td:nth-child(5) {
            width: 70px;
            text-align: center;
        }

        #horses-table th:nth-child(6), /* $ZED Bal */
        #horses-table td:nth-child(6) {
            width: 80px;
            text-align: center;
        }

        #horses-table th:nth-child(7), /* W-P-S */
        #horses-table td:nth-child(7) {
            width: 80px;
            text-align: center;
        }

        #horses-table th:nth-child(8), /* Avg Odds */
        #horses-table td:nth-child(8) {
            width: 70px;
            text-align: center;
        }

        #horses-table th:nth-child(9), /* Net / ROI */
        #horses-table td:nth-child(9) {
            width: 90px;
            text-align: center;
        }

        #horses-table th:nth-child(10), /* Win % */
        #horses-table td:nth-child(10) {
            width: 70px;
            text-align: center;
        }

        #horses-table th:nth-child(11), /* Races */
        #horses-table td:nth-child(11) {
            width: 70px;
            text-align: center;
        }

        /* Action buttons container for the racing horses table */
        .action-buttons-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            width: 100%;
            flex-wrap: nowrap; /* Prevent wrapping to next line */
        }

        /* Make the Actions column a bit wider */
        #horses-table th:nth-child(12), /* Actions Header */
        #horses-table td:nth-child(12) /* Actions Cell */ {
            width: 160px; /* Increased width further */
            padding: 5px; /* Reduce padding to fit more content */
        }

        /* Make buttons more compact */
        .action-button {
            padding: 4px; /* Slightly smaller padding */
            font-size: 0.9em;
            margin: 0 1px; /* Minimal margins */
            width: 28px; /* Slightly smaller width */
            height: 28px; /* Slightly smaller height */
            min-width: auto;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px; /* Slightly smaller radius */
            vertical-align: middle;
        }

        /* Explicitly center some specific columns */
        #horses-table th:nth-child(3), /* Gender */
        #horses-table td:nth-child(3),
        #horses-table th:nth-child(5), /* MMR */
        #horses-table td:nth-child(5),
        #horses-table th:nth-child(7), /* W-P-S */
        #horses-table td:nth-child(7),
        #horses-table th:nth-child(8), /* Avg Odds */
        #horses-table td:nth-child(8),
        #horses-table th:nth-child(9), /* Net / ROI */
        #horses-table td:nth-child(9),
        #horses-table th:nth-child(10), /* Win % */
        #horses-table td:nth-child(10),
        #horses-table th:nth-child(11) /* Races */
        #horses-table td:nth-child(11) {
             text-align: center;
        }

        #horses-table th:nth-child(4), /* Stars */
        #horses-table td:nth-child(4)
        {
             text-align: center;
             width: 120px;
        }

        #horses-table th:nth-child(2), /* Bloodline */
        #horses-table td:nth-child(2)
        {
             width: 120px;
             text-align: left; /* Keep bloodline left-aligned */
        }

        /* General table styles */
       #horses-table {
            max-width: 2200px; /* Increase from 1500px */
            min-width: 1200px; /* Ensure minimum width */
            width: 100%;
            table-layout: fixed;
        }

        /* Subtle Border Colors for Field Types */
        /* Stars (Racing, Breeding, External Sire) */
        #horse-stars, #horse-speed-stars, #horse-sprint-stars, #horse-endurance-stars,
        #breeding-horse-stars, #breeding-horse-speed-stars, #breeding-horse-sprint-stars, #breeding-horse-endurance-stars,
        #bred-overall-stars, #bred-speed-stars, #bred-sprint-stars, #bred-endurance-stars,
        #external-sire-overall-stars, #external-sire-speed-stars, #external-sire-sprint-stars, #external-sire-endurance-stars {
            border-color: var(--border-color-stars);
        }
        /* Parent Selects */
        #bred-sire, #bred-dam {
            border-color: var(--border-color-parent);
        }
        /* Financial Fields */
        #horse-zed-balance, #race-zed-change, #bred-stud-fee {
            border-color: var(--border-color-money);
        }

        /* Ensure focus state overrides subtle borders */
        #horse-stars:focus, #horse-speed-stars:focus, #horse-sprint-stars:focus, #horse-endurance-stars:focus,
        #breeding-horse-stars:focus, #breeding-horse-speed-stars:focus, #breeding-horse-sprint-stars:focus, #breeding-horse-endurance-stars:focus,
        #bred-overall-stars:focus, #bred-speed-stars:focus, #bred-sprint-stars:focus, #bred-endurance-stars:focus,
        #external-sire-overall-stars:focus, #external-sire-speed-stars:focus, #external-sire-sprint-stars:focus, #external-sire-endurance-stars:focus,
        #bred-sire:focus, #bred-dam:focus,
        #horse-zed-balance:focus, #race-zed-change:focus, #bred-stud-fee:focus {
            border-color: var(--accent-color); /* Use standard focus color */
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); /* Restore standard glow */
        }

        /* Default Form Grid Layouts */
        #add-horse-form .form-grid {
            grid-template-columns: repeat(5, 1fr);
            align-items: end;
        }
        #add-race-form .form-grid {
            grid-template-columns: repeat(6, 1fr);
            align-items: end;
        }
        #add-breeding-horse-form .form-grid {
            grid-template-columns: repeat(4, 1fr);
            align-items: end;
        }
        #add-bred-horse-form .form-grid {
            grid-template-columns: repeat(4, 1fr);
            align-items: end;
        }
        #add-augment-form .form-grid {
            grid-template-columns: 2fr 1fr auto; /* Keep this specific layout */
            align-items: end;
        }

        /* --- Responsive Design --- */

        /* Medium Screens (Tablets, smaller laptops) */
        @media (max-width: 992px) {
            #add-horse-form .form-grid {
                grid-template-columns: repeat(3, 1fr); /* Adjust to 3 columns */
            }
            #add-race-form .form-grid {
                grid-template-columns: repeat(3, 1fr); /* Adjust to 3 columns */
            }
            #add-breeding-horse-form .form-grid,
            #add-bred-horse-form .form-grid {
                grid-template-columns: repeat(2, 1fr); /* Adjust to 2 columns */
            }
            #add-augment-form .form-grid {
                grid-template-columns: 1fr; /* Stack augment fields */
                gap: 15px;
            }
            #add-augment-form .form-grid div:last-child {
                justify-self: start; /* Align button to start */
            }
            #augments-list ul {
                 column-count: 2; /* Use 2 columns for augments list */
            }
        }

        /* Small Screens (Phones) */
        @media (max-width: 600px) {
            body {
                padding: 15px; /* Reduce body padding */
            }
            .section {
                padding: 15px; /* Reduce section padding */
            }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }
            h3 { font-size: 1.2em; }

            /* Stack all form grids to 1 column */
            .form-grid {
                grid-template-columns: 1fr !important; /* Override specific form grids */
            }
            #add-augment-form .form-grid {
                 grid-template-columns: 1fr !important; /* Ensure override */
            }
            #augments-list ul {
                column-count: 1; /* Use 1 column for augments list */
            }
            .tab-button {
                padding: 8px 12px; /* Smaller tab buttons */
                font-size: 0.9em;
            }
            .modal-content {
                 width: 90%; /* Wider modal on small screens */
                 margin: 5% auto;
                 padding: 20px;
            }
            /* Ensure table scroll containers work */
            div[style*="overflow-x:auto"] {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
            }
        }

        /* Content Wrapper for constraining width */
        .content-wrapper {
            max-width: 1000px; /* Max width for the content */
            margin-left: 0; /* Align to left */
            margin-right: 0; /* Override potential inherited auto */
        }

        /* Control Name column width */
        #horses-table th:nth-child(1), /* Name */
        #horses-table td:nth-child(1) {
             /* Remove min-width to allow more flexibility with table-layout:fixed */
             max-width: 160px; /* Reduced max width */
             overflow: hidden; /* Needed for text-overflow */
             text-overflow: ellipsis; /* Add ... for long names */
             white-space: nowrap; /* Prevent wrapping */
        }
        
        /* --- Breeding Tab Table Styles --- */

        /* Add space above breeding history title */
        #add-bred-horse-form + h3 {
            margin-top: 2.5em; /* Adjust as needed */
        }

        /* Registered Breeding Horses Table */
        #breeding-horses-table {
            table-layout: fixed;
            width: 100%;
        }
        #breeding-horses-table th:nth-child(1), /* Name */
        #breeding-horses-table td:nth-child(1) {
            min-width: 150px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #breeding-horses-table th:nth-child(3), /* Gender */
        #breeding-horses-table td:nth-child(3) {
            width: 80px;
            text-align: center;
        }
        #breeding-horses-table th:nth-child(4), /* Stars */
        #breeding-horses-table td:nth-child(4) {
            width: 190px; /* Increased width for combined stars */
            text-align: center;
        }
        #breeding-horses-table th:nth-child(5), /* Actions */
        #breeding-horses-table td:nth-child(5) {
            width: 120px; /* Increased width for 3 buttons */
            text-align: center;
        }

        /* Bred Horse History Table */
        #bred-horses-table {
            table-layout: fixed;
            width: 100%;
        }
        #bred-horses-table th {
            text-align: center; /* Center all headers in this table */
        }
        #bred-horses-table th:nth-child(1), /* Bred Date */
        #bred-horses-table td:nth-child(1) {
            width: 100px;
            text-align: center;
        }
        #bred-horses-table th:nth-child(2), /* Name */
        #bred-horses-table td:nth-child(2) {
            min-width: 120px;
            max-width: 220px; /* Reduced max-width */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #bred-horses-table th:nth-child(3), /* Bloodline */
        #bred-horses-table td:nth-child(3) {
            width: 100px;
            text-align: center;
        }
        #bred-horses-table th:nth-child(4), /* Gender */
        #bred-horses-table td:nth-child(4) {
            width: 80px;
            text-align: center;
        }
        #bred-horses-table th:nth-child(5), /* Sire */
        #bred-horses-table td:nth-child(5),
        #bred-horses-table th:nth-child(6), /* Dam */
        #bred-horses-table td:nth-child(6) {
             width: 220px; /* Increased width */
              overflow: hidden; /* May need text-overflow if parent names get long */
              text-overflow: ellipsis;
              white-space: nowrap;
        }
        #bred-horses-table th:nth-child(7), /* Overall */
        #bred-horses-table td:nth-child(7),
        #bred-horses-table th:nth-child(8), /* Speed */
        #bred-horses-table td:nth-child(8),
        #bred-horses-table th:nth-child(9), /* Sprint */
        #bred-horses-table td:nth-child(9),
        #bred-horses-table th:nth-child(10), /* Endurance */
        #bred-horses-table td:nth-child(10) {
            width: 75px; /* Slightly increased width */
            text-align: center;
        }
        #bred-horses-table th:nth-child(11), /* Stud Fee */
        #bred-horses-table td:nth-child(11) {
            width: 80px;
            text-align: right; /* Align currency right */
        }
        #bred-horses-table th:nth-child(12), /* Actions */
        #bred-horses-table td:nth-child(12) {
            width: 80px;
            text-align: center;
        }

        /* --- Race History Table Styles --- */
        #races-table {
            table-layout: fixed;
            width: 100%; /* Allow race history to use full width if needed */
            max-width: 1300px; /* But cap it */
            margin-top: 20px;
        }
        #races-table th:nth-child(9), /* Actions */
        #races-table td:nth-child(9) {
            width: 80px; /* Explicit width for 2 buttons */
            text-align: center;
        }

        /* New CSS for Net / ROI column */
        #horses-table th:nth-child(8), /* Net / ROI */
        #horses-table td:nth-child(8) {
            width: 90px;
            text-align: center;
        }
        
        #horses-table th:nth-child(9), /* Win % (shifted) */
        #horses-table td:nth-child(9) {
            width: 70px;
            text-align: center;
        }

        /* --- Pagination Styles --- */
        .pagination-button {
            padding: 6px 12px; /* Smaller padding */
            font-size: 0.9em;
            height: auto; /* Override standard button height */
            min-width: 80px;
        }
        .pagination-button:disabled {
            background-color: var(--input-bg);
            color: var(--text-muted-color);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Enhanced pagination controls alignment */
        .pagination-controls {
            margin-top: 15px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-controls select,
        .pagination-controls button,
        .pagination-controls span {
            height: 32px;
            line-height: 32px;
            display: inline-flex;
            align-items: center;
        }

        .pagination-controls select,
        .pagination-select {
            padding-top: 0;
            padding-bottom: 0;
            text-align: center; /* Center the text */
            padding-left: 8px; /* Adjust padding to center visually */
            padding-right: 18px; /* Add extra space for the dropdown arrow */
            height: 32px; /* Ensure consistent height */
        }

        .pagination-controls label {
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
            height: 32px;
        }

        .pagination-controls div {
            display: inline-flex;
            align-items: center;
            height: 32px;
        }

        .pagination-controls span[id$='-page-info'] {
            margin: 0 5px;
        }

        /* --- Filter Controls --- */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(5, minmax(120px, 180px)); /* 5 columns with min/max width */
            grid-gap: 10px;
            margin-bottom: 15px;
            max-width: 100%; /* Allow full width */
            justify-content: start; /* Align grid to the start */
        }

        .filter-item {
            padding: 8px 10px;
            height: 38px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9em;
            width: 100%; /* Take full width of grid cell */
            max-width: 180px; /* But no wider than this */
        }

        .filter-item:focus {
             border-color: var(--accent-color);
             box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
             outline: none;
        }

        /* Specific widths */
        #horse-search-input {
            flex-grow: 1; /* Allow search to take more space */
            min-width: 180px;
        }

        .filter-item-small { /* Class for smaller inputs like MMR range */
            width: 100px;
        }

        /* --- Augment Analysis Per Horse (Racing Tab) --- */
        #augment-analysis-content table {
            table-layout: fixed; /* Help control widths */
            width: 100%; /* Allow table to use space */
            max-width: 800px; /* INCREASED max width */
            margin-bottom: 20px; /* Space between horse tables */
        }
        #augment-analysis-content th,
        #augment-analysis-content td {
            text-align: center; /* Center most columns */
        }
        #augment-analysis-content th:nth-child(1),
        #augment-analysis-content td:nth-child(1) { /* Augment Combo */
            text-align: left;
            width: auto; /* Let this column take remaining space */
            /* REMOVED overflow, text-overflow, white-space */
        }
        #augment-analysis-content th:nth-child(2), /* Races */
        #augment-analysis-content td:nth-child(2) {
            width: 70px;
        }
        #augment-analysis-content th:nth-child(3), /* Win % */
        #augment-analysis-content td:nth-child(3) {
            width: 80px;
        }
        #augment-analysis-content th:nth-child(4), /* Avg Place */
        #augment-analysis-content td:nth-child(4) {
            width: 80px;
        }
        #augment-analysis-content th:nth-child(5), /* Avg Odds */
        #augment-analysis-content td:nth-child(5) {
            width: 80px;
        }

        /* --- Analysis Tab Table Styles --- */
        #bloodline-analysis-table,
        #individual-augment-table,
        #augment-pair-table,
        #augment-triple-table {
            table-layout: fixed;
            width: 100%;
            max-width: 900px; /* Increased Max width for analysis tables */
            margin-bottom: 30px; /* Space below tables */
        }

        /* --- Shared Analysis Table Column Styles (Excluding Bloodline) --- */
        #individual-augment-table th:not(:nth-child(1)):not(:nth-child(2)),
        #individual-augment-table td:not(:nth-child(1)):not(:nth-child(2)),
        #augment-pair-table th:not(:nth-child(1)),
        #augment-pair-table td:not(:nth-child(1)),
        #augment-triple-table th:not(:nth-child(1)),
        #augment-triple-table td:not(:nth-child(1)) {
            width: 80px; /* Compact width for stats columns */
            text-align: center;
        }

        /* --- Individual Augment Table Specifics --- */
        #individual-augment-table th:nth-child(1),
        #individual-augment-table td:nth-child(1) { /* Augment Name */
            width: 250px; /* Wider column */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #individual-augment-table th:nth-child(2),
        #individual-augment-table td:nth-child(2) { /* Type */
            width: 70px;
            text-align: center;
        }

        /* --- Augment Pair Table Specifics --- */
        #augment-pair-table th:nth-child(1),
        #augment-pair-table td:nth-child(1) { /* Augment Pair */
            width: 350px; /* Wider column */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Triple Augment Table Specifics --- */
        #augment-triple-table th:nth-child(1),
        #augment-triple-table td:nth-child(1) { /* Augment Combination */
            width: 400px; /* Wider column */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Column Widths for Bloodline Table */
        #bloodline-analysis-table {
             max-width: 600px; /* Keep bloodline table narrower */
        }
        #bloodline-analysis-table th:nth-child(1),
        #bloodline-analysis-table td:nth-child(1) { /* Bloodline */
            width: auto;
            text-align: left;
        }
        #bloodline-analysis-table th:nth-child(2),
        #bloodline-analysis-table td:nth-child(2) { /* Races */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(3),
        #bloodline-analysis-table td:nth-child(3) { /* Win % */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(4),
        #bloodline-analysis-table td:nth-child(4) { /* Avg Place */
            width: 100px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(5),
        #bloodline-analysis-table td:nth-child(5) { /* Avg Odds */
            width: 100px;
            text-align: center;
        }

        /* --- Augment Analysis Per Horse (Racing Tab) --- */

        /* --- Analysis Tab Table Styles --- */
        #bloodline-analysis-table,
        #individual-augment-table,
        #augment-pair-table,
        #augment-triple-table {
            table-layout: fixed;
            width: 100%;
            max-width: 600px; /* Max width for analysis tables */
            margin-bottom: 30px; /* Space below tables */
        }

        /* Column Widths for Bloodline Table */
        #bloodline-analysis-table th:nth-child(1),
        #bloodline-analysis-table td:nth-child(1) { /* Bloodline */
            width: auto;
            text-align: left;
        }
        #bloodline-analysis-table th:nth-child(2),
        #bloodline-analysis-table td:nth-child(2) { /* Races */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(3),
        #bloodline-analysis-table td:nth-child(3) { /* Win % */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(4),
        #bloodline-analysis-table td:nth-child(4) { /* Avg Place */
            width: 100px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(5),
        #bloodline-analysis-table td:nth-child(5) { /* Avg Odds */
            width: 100px;
            text-align: center;
        }

        /* --- Analysis Tab Filter Alignment --- */
        .analysis-filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        /* Reset all special positioning */
        .analysis-filter-controls > div,
        .analysis-filter-controls label,
        .analysis-filter-controls select,
        .analysis-filter-controls input,
        .analysis-filter-controls button {
            position: static;
            top: auto;
            margin: 0;
            vertical-align: middle;
        }

        /* Create a special class just for the button to force alignment */
        #augment-analysis-refresh {
            /* CSS technique that's more reliable than positioning */
            transform: translateY(4px); /* Increased to 4px to move it lower */
            display: inline-block;
            margin: 0;
            line-height: 32px;
            height: 32px;
            padding: 0 20px;
            /* Remove any other positioning that might interfere */
            position: static;
            top: auto;
            bottom: auto;
            vertical-align: baseline;
        }

        /* Remove any specific adjustments from previous attempts */
        #augment-analysis-bloodline-filter,
        #augment-analysis-min-races {
            box-sizing: border-box;
            height: 32px;
        }

        .analysis-filter-controls label {
            margin-right: 10px;
            margin-bottom: 0;
            display: inline-flex;
            align-items: center; /* Vertically center label text */
            height: 32px; /* Match control height */
        }

        /* Specific adjustments for the bloodline select */
        #augment-analysis-bloodline-filter.pagination-select {
            padding: 4px 18px 4px 8px; /* top/bottom 4px, keep existing L/R */
            text-align: left; /* Override pagination center align */
        }

        /* Specific adjustments for the min races input */
        #augment-analysis-min-races.filter-item {
            padding: 4px 10px; /* Match other inputs */
            height: 32px; /* Override the default .filter-item height */
        }

        /* Refresh button specific styles - ensure consistency */
        .analysis-filter-controls button,
        #augment-analysis-refresh.button {
            padding: 0 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 32px; /* Consistent height */
            line-height: 1; /* Control text alignment */
            margin: 0;
            position: relative; /* Allow for small adjustments */
            top: 1px; /* Slight downward adjustment to match other elements */
        }

        /* Ensure all elements in the filter row have the same visual grouping */
        #augment-analysis-bloodline-filter,
        #augment-analysis-min-races,
        #augment-analysis-refresh {
            margin-top: 0;
            margin-bottom: 0;
            vertical-align: middle;
        }

        /* Column Widths for Bloodline Table */
        #bloodline-analysis-table th:nth-child(1),
        #bloodline-analysis-table td:nth-child(1) { /* Bloodline */
            width: auto;
            text-align: left;
        }
        #bloodline-analysis-table th:nth-child(2),
        #bloodline-analysis-table td:nth-child(2) { /* Races */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(3),
        #bloodline-analysis-table td:nth-child(3) { /* Win % */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(4),
        #bloodline-analysis-table td:nth-child(4) { /* Avg Place */
            width: 100px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(5),
        #bloodline-analysis-table td:nth-child(5) { /* Avg Odds */
            width: 100px;
            text-align: center;
        }

        /* Create a completely new container for perfect alignment */
        .analysis-filter-row {
            display: flex;
            flex-direction: row;
            align-items: center; /* Vertically align all items */
            gap: 15px;
            margin-bottom: 20px;
        }

        .analysis-filter-item {
            display: flex;
            align-items: center;
        }

        .analysis-filter-item label {
            margin-right: 10px;
            margin-bottom: 0;
        }

        /* Style the button specifically */
        #augment-analysis-refresh {
            height: 32px;
            padding: 0 20px;
            margin: 0;
            /* Override button styles */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            /* Move button up by 1px */
            transform: translateY(-1px);
        }

        /* Match heights of all interactive elements */
        .analysis-filter-row select,
        .analysis-filter-row input,
        .analysis-filter-row button {
            height: 32px;
            box-sizing: border-box;
        }

        /* Ensure action buttons display inline and have spacing */
        .action-button {
            padding: 6px;
            font-size: 0.9em;
            /* margin-right: 5px; REMOVED - using margin: 0 2px instead */
            min-width: auto;
            width: 32px;
            height: 32px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            vertical-align: middle; /* Align buttons vertically */
            margin: 1px 2px; /* Add small vertical and horizontal margin */
        }
        
        /* Make sure augment combo cells don't wrap to multiple lines */
        /* Target tables where the first column displays augment combinations */
        #augment-analysis-content table td:first-child,
        #augment-triple-table td:first-child,
        #augment-pair-table td:first-child,
        #modal-analysis-content table td:first-child,
        #comboTable td:first-child {
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            min-width: 240px !important; /* Set minimum width for augment combo column */
            max-width: 280px !important; /* Limit maximum width */
        }
        
        /* Adjust width for MMR column */
        #augment-analysis-content table td:nth-child(6),
        #augment-analysis-content table th:nth-child(6) {
            width: 80px !important; /* Make MMR column narrower */
        }
        
        /* Increase overall table width for augment analysis */
        #augment-analysis-content table {
            max-width: 900px !important; /* Increase from default */
        }
    </style>
</head>
<body>

    <div class="featured-app">
      <h3>New: ZED Champions Tracker</h3>
      <p>Track and analyze your ZED horses with our new tool!</p>
      <a href="/champion-predictor.html">Try it now </a>
    </div>

     <h1>Zed Champions Tracker</h1>

        <!-- Tab Navigation -->
       <div id="tab-buttons"></div>
        <script src="tabs-fix.js"></script>
        
        <!-- Tab Content -->
        <div id="tab-content">
           <!-- Racing Tab Content -->
        <div id="tab-content-racing" class="tab-content active">
        <!-- Racing Horses section -->
        <div class="section" id="horses-section">
            <h2>Racing Horses</h2>
            <div class="content-wrapper">
                <h3>Add New Racing Horse</h3>
                <form id="add-horse-form">
                    <div class="form-grid">
                        <!-- Horse name -->
                        <div>
                            <label for="horse-name">Name:</label>
                            <input type="text" id="horse-name" required>
                        </div>
                        <!-- Bloodline -->
                        <div>
                            <label for="horse-bloodline">Bloodline:</label>
                            <select id="horse-bloodline" required>
                                <option value="">--Select--</option>
                                <option value="Nakamoto">Nakamoto</option>
                                <option value="Szabo">Szabo</option>
                                <option value="Finney">Finney</option>
                                <option value="Buterin">Buterin</option>
                            </select>
                        </div>
                        <!-- Color -->
                        <div>
                            <label for="horse-color">Color:</label>
                            <select id="horse-color" required>
                                <option value="">--Select Color--</option>
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                        <!-- TRAITS / ATTRIBUTE DISPLAY -->
                        <div style="margin-top:8px;">
                            <label style="color:#77ffe7;font-weight:600;">Traits:</label>
                            <ul id="horse-traits" style="display:none;"></ul>
                            <label style="color:#f6b600;font-weight:600;">Attribute:</label>
                            <ul id="horse-attributes" style="display:none;"></ul>
                        </div>
                        <!-- Gender -->
                        <div>
                            <label for="horse-gender">Gender:</label>
                            <select id="horse-gender" required>
                                <option value="">--Select--</option>
                                <option value="Female">Female</option>
                                <option value="Male">Male</option>
                            </select>
                        </div>
                        <!-- Overall Stars -->
                        <div>
                            <label for="horse-stars">Overall Stars:</label>
                            <input type="number" id="horse-stars" step="0.1" min="1" required>
                        </div>
                        <!-- Initial $ZED Balance -->
                        <div>
                            <label for="horse-zed-balance">Initial $ZED Balance:</label>
                            <input type="number" id="horse-zed-balance" step="any" value="0" required>
                        </div>
                        <!-- Initial Matchmaking Rating -->
                        <div>
                            <label for="horse-mm-rating">Initial Matchmaking Rating:</label>
                            <input type="number" id="horse-mm-rating" step="1" value="1000" required>
                        </div>
                        <!-- Speed Stars -->
                        <div>
                            <label for="horse-speed-stars">Speed Stars:</label>
                            <input type="number" id="horse-speed-stars" step="0.1" min="0" placeholder="Optional">
                        </div>
                        <!-- Sprint Stars -->
                        <div>
                            <label for="horse-sprint-stars">Sprint Stars:</label>
                            <input type="number" id="horse-sprint-stars" step="0.1" min="0" placeholder="Optional">
                        </div>
                        <!-- Endurance Stars -->
                        <div>
                            <label for="horse-endurance-stars">Endurance Stars:</label>
                            <input type="number" id="horse-endurance-stars" step="0.1" min="0" placeholder="Optional">
                        </div>
                        <!-- Submit -->
                        <div>
                            <button type="submit">Add Racing Horse</button>
                        </div>
                    </div>
                </form>

                <!-- Filter controls -->
                <div class="filter-controls">
                    <select id="horse-filter-bloodline" class="filter-item">
                        <option value="">All Bloodlines</option>
                        <option value="Nakamoto">Nakamoto</option>
                        <option value="Szabo">Szabo</option>
                        <option value="Finney">Finney</option>
                        <option value="Buterin">Buterin</option>
                    </select>
                    <select id="horse-filter-gender" class="filter-item">
                        <option value="">All Genders</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input type="number" step="0.1" id="horse-filter-min-stars" placeholder="Min Overall" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-max-stars" placeholder="Max Overall" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-min-speed" placeholder="Min Speed" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-max-speed" placeholder="Max Speed" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-min-sprint" placeholder="Min Sprint" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-max-sprint" placeholder="Max Sprint" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-min-endurance" placeholder="Min Endur" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-max-endurance" placeholder="Max Endur" class="filter-item">
                </div>

                <!-- Horses table -->
                <div style="overflow-x:auto; width: 100vw; min-width: 1200px;">
                    <table id="horses-table">
                        <thead>
                            <tr>
                                <th data-sort-key="name">Name</th>
                                <th data-sort-key="bloodline">Bloodline</th>
                                <th data-sort-key="color">Color</th>
                                <th data-sort-key="gender">Gender</th>
                                <th data-sort-key="stars">Stars (O/Sp/Sr/E)</th>
                                <th data-sort-key="mmr">MMR</th>
                                <th data-sort-key="zed">$ZED Bal</th>
                                <th data-sort-key="wins">W-P-S</th>
                                <th data-sort-key="avgOdds">Avg Odds</th>
                                <th data-sort-key="netProfit">Net / ROI</th>
                                <th data-sort-key="winRate">Win %</th>
                                <th data-sort-key="races">Races</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="horses-table-body">
                            <!-- Horse data populated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls for Horses Table -->
                <div id="horses-pagination-controls" class="pagination-controls">
                    <div style="display: inline-flex; align-items: center; gap: 5px;">
                        <label for="horses-items-per-page" style="margin-right: 5px;">Show:</label>
                        <select id="horses-items-per-page" class="pagination-select">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <button id="horses-prev-page" class="button pagination-button">&lt; Previous</button>
                    <span id="horses-page-info">Page 1 of 1</span>
                    <button id="horses-next-page" class="button pagination-button">Next &gt;</button>
                </div>
            </div>
        </div>

        <!-- Section for Adding Race Results -->
        <div class="section" id="races-section">
            <h2>Record Race Result</h2>
            <div class="content-wrapper">
                <h3>Record New Race</h3>
                <form id="add-race-form">
                    <div class="form-grid">
                        <!-- Form fields for races -->
                        <div>
                            <label for="race-horse">Select Horse:</label>
                            <select id="race-horse" required>
                                <option value="">--Select Racing Horse--</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="race-name">Race Name:</label>
                            <input type="text" id="race-name" placeholder="Optional">
                        </div>
                        <div>
                            <label for="race-date">Race Date:</label>
                            <input type="date" id="race-date">
                        </div>
                        <div>
                            <label for="race-split-1">Split 1 (0-250m):</label>
                            <input type="number" id="race-split-1" step="any" min="0" placeholder="Seconds">
                        </div>
                        <div>
                            <label for="race-split-2">Split 2 (250-500m):</label>
                            <input type="number" id="race-split-2" step="any" min="0" placeholder="Seconds">
                        </div>
                        <div>
                            <label for="race-split-3">Split 3 (500-750m):</label>
                            <input type="number" id="race-split-3" step="any" min="0" placeholder="Seconds">
                        </div>
                        <div>
                            <label for="race-split-4">Split 4 (750-1000m):</label>
                            <input type="number" id="race-split-4" step="any" min="0" placeholder="Seconds">
                        </div>
                        <div>
                            <label for="race-position">Place:</label>
                            <input type="number" id="race-position" min="1" step="1" required>
                        </div>
                        <div>
                            <label for="race-odds">Odds:</label>
                            <input type="number" id="race-odds" min="1" step="any" required>
                        </div>
                        <div>
                            <label for="race-finish-time">Time:</label>
                            <input type="number" id="race-finish-time" step="any" min="0" placeholder="Seconds">
                        </div>
                        <div>
                            <label for="race-zed-change">$ZED Won/Lost:</label>
                            <input type="number" id="race-zed-change" step="any" required placeholder="e.g., 1200, -350">
                        </div>
                        <div>
                            <label for="race-rating-change">MM Change:</label>
                            <input type="number" id="race-rating-change" step="1" placeholder="Matchmaking Change (e.g., 15, -8)">
                        </div>
                        <div>
                            <label for="race-cpu-augment">CPU Augment Used:</label>
                            <select id="race-cpu-augment" required>
                                <option value="None">None</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="race-ram-augment">RAM Augment Used:</label>
                            <select id="race-ram-augment" required>
                                <option value="None">None</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="race-hydraulic-augment">Hydraulic Augment Used:</label>
                            <select id="race-hydraulic-augment" required>
                                <option value="None">None</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <button type="submit">Record Race</button>
                        </div>
                    </div>
                </form>
            </div>

            <h3>Race History</h3>
            <div style="overflow-x:auto;">
                <table id="races-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Race Name</th>
                            <th>Horse</th>
                            <th>Pos</th>
                            <th>Odds</th>
                            <th>Time</th>
                            <th>Split 1</th>
                            <th>Split 2</th>
                            <th>Split 3</th>
                            <th>Split 4</th>
                            <th>ZED +/-</th>
                            <th>MM +/-</th>
                            <th>Augs (C/R/H)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="races-table-body">
                        <!-- Race results populated by JS -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls for Races Table -->
            <div id="races-pagination-controls" class="pagination-controls">
                <div style="display: inline-flex; align-items: center; gap: 5px;">
                    <label for="races-items-per-page" style="margin-right: 5px;">Show:</label>
                    <select id="races-items-per-page" class="pagination-select">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="races-prev-page" class="button pagination-button">&lt; Previous</button>
                <span id="races-page-info">Page 1 of 1</span>
                <button id="races-next-page" class="button pagination-button">Next &gt;</button>
            </div>
        </div>

        <!-- Section for Augment Performance Analysis -->
        <div class="section" id="augment-analysis-section">
            <h2>Augment Performance Analysis</h2>
            <p>Shows performance statistics grouped by unique augment combinations for each racing horse.</p>
            
            <!-- Horse Filter for Augment Analysis -->
            <div style="margin-bottom: 15px; display: flex; align-items: center;">
                <label for="augment-analysis-horse-filter" style="margin-right: 10px;">Filter by Horse:</label>
                <select id="augment-analysis-horse-filter" style="width: 180px; max-width: 250px; padding: 8px;" class="pagination-select">
                    <option value="">All Horses</option>
                    <!-- Options populated by JS -->
                </select>
            </div>
            
            <!-- Augment Analysis for Lineage and Colors -->
            <label for="augment-trait-filter">Trait:</label>
            <select id="augment-trait-filter">
                <option value="">All</option>
            </select>
            
            <div id="augment-analysis-content">
                <!-- Analysis tables will be generated here by JS -->
            </div>
        </div>
    </div>
            <!-- Breeding Tab Content -->
            <div id="tab-content-breeding" class="tab-content">
    <!-- Section for Breeding Horses -->
    <div class="section" id="breeding-horses-section">
        <div class="content-wrapper">
            <h2>Breeding Horses</h2>
            <form id="add-breeding-horse-form">
                <h3>Add New Breeding Horse</h3>
                <div class="form-grid">
                    <div>
                        <label for="breeding-horse-name">Name:</label>
                        <input type="text" id="breeding-horse-name" required>
                    </div>
                    <div>
                        <label for="breeding-horse-bloodline">Bloodline:</label>
                        <select id="breeding-horse-bloodline" required>
                            <option value="">--Select--</option>
                            <option value="Nakamoto">Nakamoto</option>
                            <option value="Szabo">Szabo</option>
                            <option value="Finney">Finney</option>
                            <option value="Buterin">Buterin</option>
                        </select>
                    </div>
                    <div>
                        <label for="breeding-horse-color">Color:</label>
                        <select id="breeding-horse-color" required>
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div>
                        <label for="breeding-horse-gender">Gender:</label>
                        <select id="breeding-horse-gender" required>
                            <option value="">--Select--</option>
                            <option value="Female">Female</option>
                            <option value="Male">Male</option>
                        </select>
                    </div>
                    <div>
                        <label for="breeding-horse-stars">Overall Stars:</label>
                        <input type="number" id="breeding-horse-stars" step="0.1" min="1" placeholder="Optional">
                    </div>
                    <div>
                        <label for="breeding-horse-speed-stars">Speed Stars:</label>
                        <input type="number" id="breeding-horse-speed-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div>
                        <label for="breeding-horse-sprint-stars">Sprint Stars:</label>
                        <input type="number" id="breeding-horse-sprint-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div>
                        <label for="breeding-horse-endurance-stars">Endurance Stars:</label>
                        <input type="number" id="breeding-horse-endurance-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div>
                        <button type="submit">Add Breeding Horse</button>
                    </div>
                </div>
            </form>

            <h3>Predict Foal Quality</h3>
            <div class="form-grid" id="foal-predictor">
                <div>
                    <label for="predict-sire">Sire:</label>
                    <select id="predict-sire"><option>--Select--</option></select>
                </div>
                <div>
                    <label for="predict-dam">Dam:</label>
                    <select id="predict-dam"><option>--Select--</option></select>
                </div>
                <div>
                    <button id="predict-foal-btn" class="button">Predict</button>
                </div>
                <div id="foal-prediction-result" style="grid-column:1/-1; margin-top:1em;"></div>
            </div>

            <hr style="margin: 2em 0; border-color: var(--border-color);">

            <h3>Registered Breeding Horses</h3>
            <div style="overflow-x:auto;">
                <table id="breeding-horses-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Bloodline</th>
                            <th>Color</th>
                            <th>Gender</th>
                            <th>Stars (O/Sp/Sr/E)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="breeding-horses-table-body">
                        <!-- Breeding horse data populated by JS -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls for Breeding Horses Table -->
            <div id="breeding-horses-pagination-controls" class="pagination-controls">
                <div style="display: inline-flex; align-items: center; gap: 5px;">
                    <label for="breeding-horses-items-per-page" style="margin-right: 5px;">Show:</label>
                    <select id="breeding-horses-items-per-page" class="pagination-select">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="breeding-horses-prev-page" class="button pagination-button">&lt; Previous</button>
                <span id="breeding-horses-page-info">Page 1 of 1</span>
                <button id="breeding-horses-next-page" class="button pagination-button">Next &gt;</button>
            </div>
        </div>
    </div>

    <!-- New Section for Recording Stud Auction Income -->
    <div class="section" id="stud-auction-section">
        <div class="content-wrapper">
            <h2>Stud Auction Income</h2>
            <p>Record 5% commission income from stud auctions.</p>
            
            <form id="add-stud-auction-form">
                <h3>Record Stud Auction Income</h3>
                <div class="form-grid">
                    <div>
                        <label for="stud-auction-horse">Select Stud:</label>
                        <select id="stud-auction-horse" required>
                            <option value="">--Select Male Breeding Horse--</option>
                            <!-- Male breeding horses populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="stud-auction-price">Auction Sale Price:</label>
                        <input type="number" id="stud-auction-price" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label for="stud-auction-date">Auction Date:</label>
                        <input type="date" id="stud-auction-date">
                    </div>
                    <div>
                        <label for="stud-auction-commission">Commission (5%):</label>
                        <input type="number" id="stud-auction-commission" step="0.01" min="0" required>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button type="submit" style="height: 42px; margin-top: auto;">Record Income</button>
                    </div>
                </div>
            </form>
            
            <hr style="margin: 2em 0; border-color: var(--border-color);">
            
            <h3>Auction Income History</h3>
            <div style="overflow-x:auto;">
                <table id="stud-auction-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Stud Name</th>
                            <th>Auction Price</th>
                            <th>Commission (5%)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stud-auction-table-body">
                        <!-- Stud auction history populated by JS -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination controls for stud auction table -->
            <div id="stud-auction-pagination-controls" class="pagination-controls">
                <div style="display: inline-flex; align-items: center; gap: 5px;">
                    <label for="stud-auction-items-per-page" style="margin-right: 5px;">Show:</label>
                    <select id="stud-auction-items-per-page" class="pagination-select">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="stud-auction-prev-page" class="button pagination-button">&lt; Previous</button>
                <span id="stud-auction-page-info">Page 1 of 1</span>
                <button id="stud-auction-next-page" class="button pagination-button">Next &gt;</button>
            </div>
        </div>
    </div>

    <!-- Section for Recording Bred Horses -->
    <div class="section" id="bred-horses-section">
        <div class="content-wrapper">
            <h2>Bred Horses</h2>
            <form id="add-bred-horse-form">
                <h3>Record New Bred Horse</h3>
                <div class="form-grid">
                    <div>
                        <label for="bred-name">New Horse Name:</label>
                        <input type="text" id="bred-name" required>
                    </div>
                    <div>
                        <label for="bred-bloodline">Bloodline:</label>
                        <select id="bred-bloodline" required>
                            <option value="">--Select--</option>
                            <option value="Nakamoto">Nakamoto</option>
                            <option value="Szabo">Szabo</option>
                            <option value="Finney">Finney</option>
                            <option value="Buterin">Buterin</option>
                        </select>
                    </div>
                    <div>
                        <label for="bred-gender">Gender:</label>
                        <select id="bred-gender" required>
                            <option value="">--Select--</option>
                            <option value="Female">Female</option>
                            <option value="Male">Male</option>
                        </select>
                    </div>
                    <div>
                        <label for="bred-color">Color:</label>
                        <select id="bred-color" required>
                            <option value="">--Select--</option>
                        </select>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                            <label for="bred-sire" style="margin-bottom: 0;">Sire (Father):</label>
                            <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 0.9em;">
                                <input type="checkbox" id="use-external-sire" style="margin-right: 5px;">
                                External Sire
                            </label>
                        </div>
                        <select id="bred-sire" required>
                            <option value="">--Select Male Parent--</option>
                            <!-- Male horses populated by JS -->
                        </select>
                        <div id="sire-stats" class="parent-stats"></div>
                    </div>
                    <div class="external-sire-fields" style="display: none;">
                        <label for="external-sire-name">External Sire Name:</label>
                        <input type="text" id="external-sire-name">
                    </div>
                    <div class="external-sire-fields" style="display: none;">
                        <label for="external-sire-bloodline">External Sire Bloodline:</label>
                        <select id="external-sire-bloodline">
                            <option value="">--Select--</option>
                            <option value="Nakamoto">Nakamoto</option>
                            <option value="Szabo">Szabo</option>
                            <option value="Finney">Finney</option>
                            <option value="Buterin">Buterin</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="external-sire-fields" style="display: none;">
                        <label for="external-sire-color">External Sire Color:</label>
                        <select id="external-sire-color">
                            <option value="">--Select--</option>
                            <!-- Populated dynamically by JS -->
                        </select>
                    </div>
                    <div class="external-sire-fields" style="display: none;">
                        <label for="external-sire-overall-stars">Ext. Sire Overall Stars:</label>
                        <input type="number" id="external-sire-overall-stars" step="0.1" min="1" placeholder="Optional">
                    </div>
                    <div class="external-sire-fields" style="display: none;">
                        <label for="external-sire-speed-stars">Ext. Sire Speed Stars:</label>
                        <input type="number" id="external-sire-speed-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div class="external-sire-fields" style="display: none;">
                        <label for="external-sire-sprint-stars">Ext. Sire Sprint Stars:</label>
                        <input type="number" id="external-sire-sprint-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div class="external-sire-fields" style="display: none;">
                        <label for="external-sire-endurance-stars">Ext. Sire Endurance Stars:</label>
                        <input type="number" id="external-sire-endurance-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div>
                        <label for="bred-dam" style="margin-bottom: 0;">Dam (Mother):</label>
                        <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 0.9em;">
                            <input type="checkbox" id="use-external-dam" style="margin-right: 5px;">
                            External Dam
                        </label>
                    </div>
                    <div>
                        <label for="bred-dam">Dam (Mother):</label>
                        <select id="bred-dam" required>
                            <option value="">--Select Female Parent--</option>
                            <!-- Female horses populated by JS -->
                        </select>
                        <div id="dam-stats" class="parent-stats"></div>
                    </div>
                    <div>
                        <label for="bred-date">Date Bred:</label>
                        <input type="date" id="bred-date">
                    </div>
                    <div>
                        <label for="bred-stud-fee">Stud Fee Paid:</label>
                        <input type="number" id="bred-stud-fee" step="any" value="0" required>
                    </div>
                    <div>
                        <label for="bred-overall-stars">Overall Stars:</label>
                        <input type="number" id="bred-overall-stars" step="0.1" min="1" placeholder="Optional">
                    </div>
                    <div>
                        <label for="bred-speed-stars">Speed Stars:</label>
                        <input type="number" id="bred-speed-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div>
                        <label for="bred-sprint-stars">Sprint Stars:</label>
                        <input type="number" id="bred-sprint-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div>
                        <label for="bred-endurance-stars">Endurance Stars:</label>
                        <input type="number" id="bred-endurance-stars" step="0.1" min="0" placeholder="Optional">
                    </div>
                    <div>
                        <button type="submit">Record Bred Horse</button>
                    </div>
                </div>
            </form>
        </div>

        <h3>Bred Horse History</h3>
        <div style="overflow-x:auto;">
            <table id="bred-horses-table">
                <thead>
                    <tr>
                        <th>Bred Date</th>
                        <th>Name</th>
                        <th>Bloodline</th>
                        <th>Color</th>
                        <th>Gender</th>
                        <th>Sire</th>
                        <th>Dam</th>
                        <th>Overall</th>
                        <th>Speed</th>
                        <th>Sprint</th>
                        <th>Endurance</th>
                        <th>Stud Fee</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bred-horses-table-body">
                    <!-- Bred horse history populated by JS -->
                </tbody>
            </table>
        </div>
        <!-- Pagination Controls for Bred History Table -->
        <div id="bred-history-pagination-controls" class="pagination-controls">
            <div style="display: inline-flex; align-items: center; gap: 5px;">
                <label for="bred-history-items-per-page" style="margin-right: 5px;">Show:</label>
                <select id="bred-history-items-per-page" class="pagination-select">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <button id="bred-history-prev-page" class="button pagination-button">&lt; Previous</button>
            <span id="bred-history-page-info">Page 1 of 1</span>
            <button id="bred-history-next-page" class="button pagination-button">Next &gt;</button>
        </div>
    </div>
</div>

            <!-- Transactions Tab Content -->
            <div id="tab-content-transactions" class="tab-content">
                <div class="section" id="transactions-section">
                    <h2>Horse Transactions</h2>
                    <div class="content-wrapper">
                        <h3>Record Sale or Purchase</h3>
                        <form id="add-transaction-form">
                            <div class="form-grid">
                                <div>
                                    <label for="transaction-type">Transaction Type:</label>
                                    <select id="transaction-type" required>
                                        <option value="">--Select--</option>
                                        <option value="sale">Sale</option>
                                        <option value="purchase">Purchase</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="transaction-horse-name">Horse Name:</label>
                                    <input type="text" id="transaction-horse-name" required>
                                </div>
                                <div>
                                    <label for="transaction-date">Date:</label>
                                    <input type="date" id="transaction-date">
                                </div>
                                <div>
                                    <label for="transaction-amount">Amount:</label>
                                    <input type="number" id="transaction-amount" step="0.01" min="0" required>
                                </div>
                                <div>
                                    <label for="transaction-notes">Notes:</label>
                                    <input type="text" id="transaction-notes" placeholder="Optional details">
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <button type="submit">Record Transaction</button>
                                </div>                          
                            </div>
                        </form>
                    </div>

                    <h3>Transaction History</h3>
                    <div style="overflow-x:auto;">
                        <table id="transactions-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Horse Name</th>
                                    <th>Amount</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body">
                                <!-- Transaction data populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination Controls for Transactions Table -->
                    <div id="transactions-pagination-controls" class="pagination-controls">
                        <div style="display: inline-flex; align-items: center; gap: 5px;">
                            <label for="transactions-items-per-page" style="margin-right: 5px;">Show:</label>
                            <select id="transactions-items-per-page" class="pagination-select">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <button id="transactions-prev-page" class="button pagination-button">&lt; Previous</button>
                        <span id="transactions-page-info">Page 1 of 1</span>
                        <button id="transactions-next-page" class="button pagination-button">Next &gt;</button>
                    </div>
                </div>
            </div>

           <!-- Augments Tab Content -->
            <div id="tab-content-augments" class="tab-content">
                <div class="content-wrapper">
                    <!-- Section for Augments -->
                    <div class="section" id="augments-section">
                        <h2>Manage Augments</h2>
                        <p>Add or remove augments available in dropdowns.</p>

                        <!-- Add Augment Form -->
                        <form id="add-augment-form">
                            <h3>Add New Augment</h3>
                            <div class="form-grid">
                                <div>
                                    <label for="augment-name" class="label-required">Augment Name:</label>
                                    <input type="text" id="augment-name" required placeholder="e.g., Void C100">
                                </div>
                                <div>
                                    <label for="augment-type" class="label-required">Type:</label>
                                    <select id="augment-type" required>
                                        <option value="">--Select Type--</option>
                                        <option value="CPU">CPU</option>
                                        <option value="RAM">RAM</option>
                                        <option value="Hydraulic">Hydraulic</option>
                                    </select>
                                </div>
                                <div>
                                    <button type="submit">Add Augment</button>
                                </div>
                            </div>
                        </form>
                        
                        <hr style="margin: 2em 0; border-color: var(--border-color);">

                        <h3>Current Augments</h3>
                        <div class="form-grid">
                            <div>
                                <h3>CPU</h3>
                                <ul id="cpu-augment-list" class="augment-manage-list">
                                    <!-- Populated by JS -->
                                </ul>
                            </div>
                            <div>
                                <h3>RAM</h3>
                                <ul id="ram-augment-list" class="augment-manage-list">
                                    <!-- Populated by JS -->
                                </ul>
                            </div>
                            <div>
                                <h3>Hydraulic</h3>
                                <ul id="hydraulic-augment-list" class="augment-manage-list">
                                    <!-- Populated by JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Tab Content -->
            <div id="tab-content-analysis" class="tab-content">
                <div class="section" id="performance-by-bloodline-section">
                    <h2>Performance by Bloodline</h2>
                    <p>Average performance metrics broken down by bloodline.</p>
                    
                    <table id="bloodline-analysis-table">
                        <thead>
                            <tr>
                                <th>Bloodline</th>
                                <th>Color</th>
                                <th>Races</th>
                                <th>Win %</th>
                                <th>Avg Place</th>
                                <th>Avg Odds</th>
                            </tr>
                        </thead>
                        <tbody id="bloodline-analysis-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="section" id="augment-analysis-section">
                    <h2>Augment Performance Analysis</h2>
                    
                    <!-- Filters for augment analysis -->
                    <div class="analysis-filter-row">
                        <div class="analysis-filter-item">
                            <label for="augment-analysis-bloodline-filter">Bloodline:</label>
                            <select id="augment-analysis-bloodline-filter" class="pagination-select" style="width: 150px;">
                                <option value="">All Bloodlines</option>
                                <option value="Nakamoto">Nakamoto</option>
                                <option value="Szabo">Szabo</option>
                                <option value="Finney">Finney</option>
                                <option value="Buterin">Buterin</option>
                            </select>
                        </div>
                        <div class="analysis-filter-item">
                            <label for="augment-analysis-min-races">Min Races:</label>
                            <input type="number" id="augment-analysis-min-races" class="filter-item" style="width: 80px;" value="5">
                        </div>
                        <div class="analysis-filter-item">
                            <button id="augment-analysis-refresh" class="button">Refresh Analysis</button>
                        </div>
                    </div>
                    
                    <h3>Individual Augment Performance</h3>
                    <div style="overflow-x: auto; margin-bottom: 30px;">
                        <table id="individual-augment-table">
                            <thead>
                                <tr>
                                    <th>Augment</th>
                                    <th>Type</th>
                                    <th>Races</th>
                                    <th>Win %</th>
                                    <th>Avg Place</th>
                                    <th>Avg Odds</th>
                                </tr>
                            </thead>
                            <tbody id="individual-augment-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <h3>Augment Pair Performance</h3>
                    <div style="overflow-x: auto; margin-bottom: 30px;">
                        <table id="augment-pair-table">
                            <thead>
                                <tr>
                                    <th>Augment Pair</th>
                                    <th>Races</th>
                                    <th>Win %</th>
                                    <th>Avg Place</th>
                                    <th>Avg Odds</th>
                                </tr>
                            </thead>
                            <tbody id="augment-pair-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <h3>Triple Augment Performance</h3>
                    <div style="overflow-x: auto;">
                        <table id="augment-triple-table">
                            <thead>
                                <tr>
                                    <th>Augment Combination</th>
                                    <th>Races</th>
                                    <th>Win %</th>
                                    <th>Avg Place</th>
                                    <th>Avg Odds</th>
                                </tr>
                            </thead>
                            <tbody id="augment-triple-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

           <!-- Stats Tab Content -->
            <div id="tab-content-stats" class="tab-content">
                <div class="section" id="stats-section">
                    <h2>Overall Statistics</h2>
                    <div id="stats-content">
                        <p>Total Races Recorded: <span id="total-races"></span></p>
                        <p>$ZED Change for Active Racers: <span id="total-zed-change"></span></p>
                        <p>Current Balance of Active Racers: <span id="active-racers-balance"></span></p>
                        <hr style="border-color: var(--border-color); margin: 0.8em 0;">
                        <p>Total Retirement Earnings: <span id="total-retirement-earnings"></span></p>
                        <p>Total Stud Auction Income: <span id="total-stud-auction-income"></span></p>
                        <p>Total Stud Fees Paid: <span id="total-stud-fees"></span></p>
                        <p>Total Sales Income: <span id="total-sales-income"></span></p>
                        <p>Total Purchase Expenses: <span id="total-purchase-expenses"></span></p>
                        <hr style="border-color: var(--border-color); margin: 0.8em 0;">
                        <p><strong>Net Earnings (All Sources):</strong> <strong id="net-earnings" style="font-size: 1.1em;"></strong></p>
                    </div>
                </div>
            </div>

                        <!-- Import Tab Content -->
            <div id="tab-content-import" class="tab-content">
              <div id="api-import-container" class="section">
                <h2>ZED Champions API Authentication</h2>
                <p>Enter your API token to import horses directly from ZED Champions.</p>
                
                <div style="margin-top: 15px;">
                  <div class="form-grid" style="grid-template-columns: 1fr auto;">
                    <textarea id="zed-api-token" placeholder="Enter your ZED Champions API Bearer token" 
                      style="height: 60px; padding: 10px;" autocomplete="off"></textarea>
                    <button id="save-api-token-btn" class="button">Save Token</button>
                  </div>
                  
                  <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center;">
                    <button id="test-api-connection-btn" class="button">Test Connection</button>
                    <div id="test-api-connection-status" style="flex: 1;"></div>
                  </div>
                </div>
                
                <div style="margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                  <h3>Import Horses</h3>
                  <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="import-racing-stable-btn" class="button">Import Racing Stable</button>
                    <button id="import-breeding-stable-btn" class="button">Import Breeding Stable</button>
                  </div>
                  <div id="import-status" style="margin-top: 10px;"></div>
                  
                  <h4>Import Single Horse</h4>
                  <div style="display: flex; gap: 10px; margin-top: 10px; align-items: flex-end;">
                    <div>
                      <label for="zed-horse-id">Horse ID:</label>
                      <input type="text" id="zed-horse-id" placeholder="Enter horse ID">
                    </div>
                    <div>
                      <label for="import-horse-type">Import As:</label>
                      <select id="import-horse-type">
                        <option value="racing">Racing Horse</option>
                        <option value="breeding">Breeding Horse</option>
                      </select>
                    </div>
                    <button id="import-single-horse-btn" class="button">Import Horse</button>
                  </div>
                  <div id="single-import-status" class="import-status"></div>
                </div>
              </div>
            </div>
            <div id="api-import-container" class="section">
              <h2>ZED Champions API Authentication</h2>
              <p>Enter your Bearer token to connect to the ZED Champions API.</p>
              
              <div style="margin-top: 15px;">
                <div class="form-grid" style="grid-template-columns: 1fr auto;">
                  <textarea id="zed-api-token" placeholder="Enter your ZED Champions API Bearer token" 
                    style="height: 60px; padding: 10px;" autocomplete="off" data-lpignore="true"></textarea>
                  <button id="save-api-token-btn" class="button">Save Token</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center;">
                  <button id="test-api-connection-btn" class="button">Test Connection</button>
                  <div id="test-api-connection-status" style="flex: 1;"></div>
                </div>
              </div>
              
              <div style="margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <h3>Import Horses</h3>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                  <button id="import-racing-stable-btn" class="button">Import Racing Stable</button>
                  <button id="import-breeding-stable-btn" class="button">Import Breeding Stable</button>
                </div>
                <div id="import-status" style="margin-top: 10px;"></div>
                
                <h4>Import Single Horse</h4>
                <div style="display: flex; gap: 10px; margin-top: 10px; align-items: flex-end;">
                  <div>
                    <label for="zed-horse-id">Horse ID:</label>
                    <input type="text" id="zed-horse-id" placeholder="Enter horse ID">
                  </div>
                  <div>
                    <label for="import-horse-type">Import As:</label>
                    <select id="import-horse-type">
                      <option value="racing">Racing Horse</option>
                      <option value="breeding">Breeding Horse</option>
                    </select>
                  </div>
                  <button id="import-single-horse-btn" class="button">Import Horse</button>
                </div>
                <div id="single-import-status" class="import-status"></div>
              </div>
            </div>
            <!-- Horse Search Section -->
            <div class="section" id="horse-search-container">
                <h2>Search for Horses</h2>
                <p>Find a specific horse by name or ID to view detailed statistics and import to your stable.</p>
                
                <div class="search-field-group">
                    <div class="search-row">
                    <div class="search-input-wrapper">
                        <label for="horse-search-input">Search by name:</label>
                        <input class="horse-search-input" id="horse-search-input" placeholder="Enter horse name...">
                    </div>
                    <div class="search-input-wrapper">
                        <label for="horse-id-input">Or by ID:</label>
                        <input class="horse-id-input" id="horse-id-input" placeholder="Enter horse ID...">
                    </div>
                    <button type="button" class="button" id="horse-search-button">Search</button>
                    </div>
                </div>
                
                <div class="horse-results" id="horse-results"></div>
            </div>
                
                <hr style="margin: 2em 0; border-color: var(--border-color);">
                
                <div style="margin-top: 15px;">
                    <button id="import-data-button" class="button">Import Data from Backup</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    <p style="font-size: 0.9em; color: var(--text-muted-color); margin-top: 8px;">
                        Loads data from a previously exported JSON backup file.
                        <strong style="color: var(--error-color);">Warning: This will overwrite all current data in the tracker.</strong>
                    </p>
                </div>
                
                <hr style="margin: 2em 0; border-color: var(--border-color);">

                <!-- Add Stud Fee Section -->
                <h2>Manually Add Stud Fee</h2>
                <p>Use this if a stud fee wasn't properly recorded in the stats.</p>
                <div style="margin-top: 15px; display: flex; gap: 10px; align-items: flex-end;">
                    <div>
                        <label for="manual-stud-fee-bred-horse" style="display: block; margin-bottom: 5px;">Select Bred Horse:</label>
                        <select id="manual-stud-fee-bred-horse" style="width: 250px; padding: 10px; height: 42px; box-sizing: border-box;">
                            <option value="">--Select Bred Horse--</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="manual-stud-fee-amount" style="display: block; margin-bottom: 5px;">Stud Fee Amount:</label>
                        <input type="number" id="manual-stud-fee-amount" step="any" style="width: 120px; padding: 10px; height: 42px; box-sizing: border-box;">
                    </div>
                    <button id="update-stud-fee-button" class="button" style="height: 42px; margin-bottom: 0; align-self: flex-end; box-sizing: border-box;">Update Stud Fee</button>
                </div>
            </div>
            
            <!-- ZED Champions API Integration -->
            <script src="app.js"></script>

        <script>
        // Add to the beginning of your script section in index.html
        // Replace your broken initializeApiIntegration function with this complete version
        // Add to your script section
        function setupHorseSearch() {
            const searchInput = document.getElementById('horse-search-input');
            const idInput = document.getElementById('horse-id-input');
            const searchButton = document.getElementById('horse-search-button');
            const resultsContainer = document.getElementById('horse-results');
            
            if (!searchInput || !idInput || !searchButton || !resultsContainer) return;
            
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                idInput.value = '';
                performSearch();
                }
            });
            
            idInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                searchInput.value = '';
                performSearch();
                }
            });
            
            function performSearch() {
                const nameQuery = searchInput.value.trim();
                const idQuery = idInput.value.trim();
                
                if (!idQuery && (!nameQuery || nameQuery.length < 2)) {
                alert("Please enter a valid horse ID or a name with at least 2 characters");
                return;
                }
                
                // Show loading indicator
                resultsContainer.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div> Searching for horses...
                </div>
                `;
                resultsContainer.style.display = 'block';
                
                // Build the API URL
                let apiUrl = 'https://api.zedchampions.com/v1/';
                if (idQuery) {
                apiUrl += `horses/${encodeURIComponent(idQuery)}`;
                } else {
                apiUrl += `horses/search?q=${encodeURIComponent(nameQuery)}`;
                }
                
                // Make the API request
                fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${ZED_API.authToken}`,
                    'Content-Type': 'application/json'
                }
                })
                .then(response => {
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                return response.json();
                })
                .then(data => {
                if (idQuery) {
                    // Single horse result
                    displaySearchResults([data]); 
                } else {
                    // Search results array
                    displaySearchResults(data.results || []);
                }
                })
                .catch(error => {
                console.error("Horse search error:", error);
                resultsContainer.innerHTML = `
                    <div style="padding: 15px; color: var(--bad-color);">
                    Error: ${error.message || "Failed to fetch horse data"}
                    <p>Make sure your API token is valid and you have an active internet connection.</p>
                    </div>
                `;
                });
            }
            
            function displaySearchResults(horses) {
                if (horses.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 15px;">No horses found matching your search criteria.</div>';
                return;
                }
                
                resultsContainer.innerHTML = '';
                
                horses.forEach(horse => {
                const item = document.createElement('div');
                item.className = `horse-result-item ${horse.bloodline ? `bloodline-${horse.bloodline.toLowerCase()}` : ''}`;
                
                // Generate star ratings
                const overallStars = generateStarRating(parseFloat(horse.overall_rating));
                const speedStars = generateStarRating(parseFloat(horse.speed_rating));
                const sprintStars = generateStarRating(parseFloat(horse.sprint_rating));
                
                item.innerHTML = `
                    <div class="horse-name">${horse.name}
                    <span class="horse-result-bloodline">| ${horse.bloodline || "Unknown"} | Gen ${horse.genotype ?? "N/A"}</span>
                    </div>
                    <div class="horse-details">
                    <div><strong>Overall:</strong> ${overallStars}</div>
                    <div><strong>Speed:</strong> ${speedStars}</div>
                    <div><strong>Sprint:</strong> ${sprintStars}</div>
                    </div>
                    <div class="import-actions">
                    <button class="button import-as-racing" data-horse-id="${horse.id}">Import as Racing Horse</button>
                    <button class="button import-as-breeding" data-horse-id="${horse.id}">Import as Breeding Horse</button>
                    </div>
                `;
                
                resultsContainer.appendChild(item);
                });
                
                // Add event listeners for import buttons
                document.querySelectorAll('.import-as-racing').forEach(btn => {
                btn.addEventListener('click', function() {
                    const horseId = this.getAttribute('data-horse-id');
                    importSingleHorseById(horseId, 'racing');
                });
                });
                
                document.querySelectorAll('.import-as-breeding').forEach(btn => {
                btn.addEventListener('click', function() {
                    const horseId = this.getAttribute('data-horse-id');
                    importSingleHorseById(horseId, 'breeding');
                });
                });
            }
            
            function generateStarRating(rating) {
                if (isNaN(rating) || rating === null) return 'N/A';
                
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                
                let html = '<span class="star-rating">';
                
                // Full stars
                for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star"></i>';
                }
                
                // Half star if needed
                if (hasHalfStar) {
                html += '<i class="fas fa-star-half-alt"></i>';
                }
                
                // Empty stars
                for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star"></i>';
                }
                
                html += ` <span class="rating-value">(${rating.toFixed(1)})</span></span>`;
                return html;
            }
            
            function importSingleHorseById(horseId, type) {
                document.getElementById('zed-horse-id').value = horseId;
                document.getElementById('import-horse-type').value = type;
                
                // Trigger the import
                importSingleHorse();
                
                // Scroll to the import status
                document.getElementById('single-import-status').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
                });
            }
        }

        // Call this function on page load
        document.addEventListener('DOMContentLoaded', function() {
        setupHorseSearch();
        });

        function initializeApiIntegration() {
        // Create container for the ZED API UI
            const apiContainer = document.getElementById('api-import-container');
            if (!apiContainer) {
                console.error("API import container not found!");
                return;
            }
            
            // Create API token input section
            const tokenSection = document.createElement('div');
            tokenSection.className = 'section';
            tokenSection.innerHTML = `
                <h3>ZedChampions API Connection</h3>
                <p>To import horses from ZedChampions, you need to set your API token.</p>
                <div class="form-grid">
                <div>
                    <label for="zed-api-token">API Token:</label>
                    <input type="text" id="zed-api-token" placeholder="Enter your ZedChampions API token">
                </div>
                <div>
                    <button id="set-token-btn" class="button">Set Token</button>
                    <button id="test-connection-btn" class="button">Test Connection</button>
                </div>
                </div>
                <div id="api-connection-status" style="margin-top: 10px; display: none;"></div>
                
                <hr style="margin: 2em 0; border-color: var(--border-color);">
                
                <h3>Import Horses</h3>
                <div class="form-grid">
                <div>
                    <button id="import-racing-stable-btn" class="button">Import Racing Stable</button>
                    <div id="racing-import-status" class="import-status"></div>
                </div>
                <div>
                    <button id="import-breeding-stable-btn" class="button">Import Breeding Stable</button>
                    <div id="breeding-import-status" class="import-status"></div>
                </div>
                </div>
                
                <h3>Import Single Horse</h3>
                <div class="form-grid">
                <div>
                    <label for="zed-horse-id">Horse ID:</label>
                    <input type="text" id="zed-horse-id" placeholder="Enter ZedChampions horse ID">
                </div>
                <div>
                    <label for="import-horse-type">Import As:</label>
                    <select id="import-horse-type">
                    <option value="racing">Racing Horse</option>
                    <option value="breeding">Breeding Horse</option>
                    </select>
                </div>
                <div>
                    <button id="import-single-horse-btn" class="button">Import Horse</button>
                </div>
                </div>
                <div id="single-import-status" class="import-status"></div>
            `;
            
            apiContainer.innerHTML = ''; // Clear container first
            apiContainer.appendChild(tokenSection);
            
            // Set up event listeners
            document.getElementById('set-token-btn').addEventListener('click', function() {
                const token = document.getElementById('zed-api-token').value.trim();
                if (!token) {
                showConnectionStatus('Please enter a valid API token', false);
                return;
                }
                
                ZED_API.setAuthToken(token);
                showConnectionStatus('API token set successfully. Please test the connection.', true);
            });
            
            document.getElementById('test-connection-btn').addEventListener('click', async function() {
                showConnectionStatus('Testing connection...', null);
                
                try {
                const result = await ZED_API.testConnection();
                showConnectionStatus(result.message, result.success);
                } catch (error) {
                showConnectionStatus(`Error: ${error.message}`, false);
                }
            });
            
            document.getElementById('import-racing-stable-btn').addEventListener('click', importRacingStable);
            document.getElementById('import-breeding-stable-btn').addEventListener('click', importBreedingStable);
            document.getElementById('import-single-horse-btn').addEventListener('click', importSingleHorse);
            }

            // Make sure to call this function on page load
            document.addEventListener('DOMContentLoaded', function() {
            // Other initialization code...
            initializeApiIntegration();
            });
        // 1 Define your color palettes per bloodline.

        const breedColorOptions = {
        Nakamoto: {
            "normal": [
            { label:'crimson',hex:'#DC143C' },
            { label:'fire brick',hex:'#B22222' },
            { label:'red',hex:'#FF0000' },
            { label:'vermilion',hex:'#E34234' },
            { label:'bittersweet',hex:'#FE6F5E' },
            { label:'sun glow',hex:'#FFDD44' },
            { label:'burnt sienna',hex:'#E97451' },
            { label:'pomegranate',hex:'#F34723' },
            { label:'cinnabar',hex:'#E34234' },
            { label:'Alizarin crimson',hex:'#E32636' },
            { label:'mauvelous',hex:'#EF98AA' },
            { label:'fraley',hex:'#EE204D' },
            { label:'French rose',hex:'#F64A8A' },
            { label:'amaranth',hex:'#E52B50' },
            { label:'maroon flush',hex:'#C32148' },
            { label:'jazzberry jam',hex:'#A50B5E' }
            ],
            "rare": [
            { label:'torch red',hex:'#E25822' },
            { label:'razzmatazz',hex:'#E3256B' }
            ],
            "super rare": [
            { label:'guardsman red',hex:'#C41E3A' },
            { label:'black',hex:'#000000' }
            ]
        },
        Szabo: {
            "normal": [
                { label:'malibu',hex:'#7DC8F7' },
                { label:'Jordy blue',hex:'#8AB9F1' },
                { label:'dodger blue',hex:'#1E90FF' },
                { label:'cerulean',hex:'#007BA7' },
                { label:'curious blue',hex:'#4592AF' },
                { label:'lochmara',hex:'#2E8B57' },
                { label:'spray',hex:'#85C4CC' },
                { label:'turquoise blue',hex:'#40E0D0' },
                { label:'scooter',hex:'#3FD0B9' },
                { label:'Robins egg blue',hex:'#00CCCC' },
                { label:'Pacific blue',hex:'#1CA9C9' },
                { label:'Bondi blue',hex:'#0095B6' }
            ],
            "rare": [
                { label:'aqua',hex:'#00FFFF' },
                { label:'cyan',hex:'#00B7EB' }
            ],
            "super rare": [
                { label:'wild blue yonder',hex:'#A2ADD0' },
                { label:'boulder',hex:'#7A7F9A' }
            ]
        },
        Finney: {
            "normal": [
                { label:'light wisteria',hex:'#C9A0DC' },
                { label:'amethyst',hex:'#9966CC' },
                { label:'mamba',hex:'#4E5180' },
                { label:'sance',hex:'#6F00FF' },
                { label:'purple heart',hex:'#69359C' },
                { label:'eminence',hex:'#6C3082' },
                { label:'lavender',hex:'#E6E6FA' },
                { label:'lilac bush',hex:'#9874D3' },
                { label:'fuchsia blue',hex:'#7D26CD' },
                { label:'mischka',hex:'#D1C6B3' },
                { label:'manatee',hex:'#979AAA' },
                { label:'Daisy Bush',hex:'#FFEB6A' }
            ],
            "rare": [
                { label:'heliotrope',hex:'#DF73FF' },
                { label:'prelude',hex:'#DF8EAA' }
            ],
            "super rare": [
                { label:'electric violet',hex:'#8F00FF' },
                { label:'white',hex:'#FFFFFF' }
            ]
        },
        Buterin: {
            "normal":[
                { label:'picasso',hex:'#7A715C' },
                { label:'Paris Daisy',hex:'#FFE3A3' },
                { label:'gorse',hex:'#FADA5E' },
                { label:'astra',hex:'#F0F8FF' },
                { label:'bright sun',hex:'#FFAA1D' },
                { label:'Lightning yellow',hex:'#F8DE7E' },
                { label:'primrose',hex:'#FDE910' },
                { label:'Manz',hex:'#FFCF48' },
                { label:'wattle',hex:'#D4AF37' },
                { label:'pear',hex:'#D1E231' },
                { label:'earls',hex:'#C49E3F' },
                { label:'ginger',hex:'#B06500' }
            ],
            "rare":[
                { label:'Electric lime',hex:'#CCFF00' },
                { label:'shalamar',hex:'#7C1C05' }
            ],
            "super rare":[
                { label:'golf',hex:'#C0C0A8' },
                { label:'silver',hex:'#C0C0C0' }
            ]
        }
        };
        // 2 Define traits and Attributes per bloodline
        const bloodlineTraits = {
            Nakamoto: ['High start','Nervous','Defensive','Sensitive','Reactive'],
            Szabo:    ['Calm','Focused','Professional'],
            Finney:   ['Determined','Stubborn','Hungry','Defensive'],
            Buterin:  ['Goofy','Playful','Distracted','Restless']
        };

        const bloodlineAttributes = {
            Nakamoto: ['strong start'],
            Szabo:    ['steady'],
            Finney:   ['strong finish'],
            Buterin:  ['unpredictable']
        };
        const forms = [
            { prefix: 'horse',          color:'horse-color',          traits:'horse-traits',           attrs:'horse-attributes' },
            { prefix: 'breeding-horse', color:'breeding-horse-color', traits:'breeding-horse-traits',  attrs:'breeding-horse-attributes' },
            { prefix: 'bred',           color:'bred-color',           traits:'bred-horse-traits',      attrs:'bred-horse-attributes' }
        ];

        // Add event listeners for bloodline changes on all forms
       forms.forEach(f => {
            const el = document.getElementById(`${f.prefix}-bloodline`);
            if (el) {
                el.addEventListener('change', () => onBloodlineChange(
                    `${f.prefix}-bloodline`,
                    f.color, f.traits, f.attrs
                ));
            }
        }); // <-- CLOSE the forEach HERE

        // Initialize color/traits/attributes for all forms
        forms.forEach(f => onBloodlineChange(
            `${f.prefix}-bloodline`,
            f.color, f.traits, f.attrs
        ));
        
        // Foal Prediction Algorithm - Insert after forms array, before onBloodlineChange function

        function calculateStars(sireStars, damStars) {
        // Get values as numbers, defaulting to 0 if not provided
        const sireVal = parseFloat(sireStars) || 0;
        const damVal = parseFloat(damStars) || 0;
        
        // Basic average
        let baseStars = (sireVal + damVal) / 2;
        
        // Add some randomness (-0.4 to +0.6)
        const randomFactor = (Math.random() * 1.0) - 0.4;
        
        // Final prediction (with some limits)
        let predictedStars = baseStars + randomFactor;
        
        // Ensure it's within reasonable bounds
        predictedStars = Math.max(Math.min(predictedStars, Math.max(sireVal, damVal) + 0.5), Math.min(sireVal, damVal) - 0.3);
        
        return predictedStars.toFixed(1);
    }

    function predictFoalBloodline(sire, dam) {
        if (!sire || !dam) return "Unknown";
        
        // 75% chance to inherit from sire, 25% from dam
        return Math.random() < 0.75 ? sire.bloodline : dam.bloodline;
    }

        function predictFoal(sire, dam) {
            if (!sire || !dam) return null;
            
            // Get bloodline first
            const bloodline = predictFoalBloodline(sire, dam);
            
            // Color inheritance (80% from parents, 20% new from bloodline)
            const predictColor = () => {
                if (Math.random() < 0.8) {
                    // Inherit from parent (60% sire, 40% dam)
                    return Math.random() < 0.6 ? sire.color : dam.color;
                } else {
                    // New color from bloodline
                    const rarityRoll = Math.random();
                    let colorPool;
                    
                    if (rarityRoll < 0.05) {
                        colorPool = breedColorOptions[bloodline]["super rare"].map(c => c.hex);
                    } else if (rarityRoll < 0.2) {
                        colorPool = breedColorOptions[bloodline].rare.map(c => c.hex);
                    } else {
                        colorPool = breedColorOptions[bloodline].normal.map(c => c.hex);
                    }
                    
                    return colorPool[Math.floor(Math.random() * colorPool.length)];
                }
            };
            
            // Return prediction result
            return {
                bloodline,
                gender: Math.random() < 0.5 ? 'Male' : 'Female',
                color: predictColor(),
                overallStars: calculateStars(sire.stars, dam.stars),
                speedStars: calculateStars(sire.speedStars, dam.speedStars),
                sprintStars: calculateStars(sire.sprintStars, dam.sprintStars),
                enduranceStars: calculateStars(sire.enduranceStars, dam.enduranceStars)
            };
        }

        // Helper function to show import status
        // Fix 3: Fix the showImportStatus function - this is causing status messages to fail
        function showImportStatus(element, message, isSuccess) {
            if (!element) return;
            
            element.style.display = 'block';
            element.innerHTML = message;
            
            if (isSuccess === true) {
                element.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                element.style.color = '#4CAF50';
                element.style.padding = '8px 12px';
                element.style.borderRadius = '4px';
            } else if (isSuccess === false) {
                element.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
                element.style.color = '#F44336';
                element.style.padding = '8px 12px';
                element.style.borderRadius = '4px';
            } else {
                element.style.backgroundColor = 'rgba(33, 150, 243, 0.2)';
                element.style.color = '#2196F3';
                element.style.padding = '8px 12px';
                element.style.borderRadius = '4px';
            }
        }
                    // --- REPLACE the entire ZED_API and all duplicate fetchHorse/searchHorses definitions with this block ---
            
            const ZED_API = {
                authToken: null,
                tokenExpiry: null,

                setAuthToken(token) {
                    this.authToken = token;
                    localStorage.setItem('zedTrackerAuthToken', token);
                    // Check expiration when setting token
                    this.isTokenExpired();
                    return true;
                },

                loadAuthToken() {
                    const token = localStorage.getItem('zedTrackerAuthToken');
                    if (token) {
                        this.authToken = token;
                        return true;
                    }
                    return false;
                },

                isTokenExpired() {
                    if (!this.authToken) return true;
                    try {
                        const base64Url = this.authToken.split('.')[1];
                        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                        const payload = JSON.parse(window.atob(base64));
                        const expiryTime = payload.exp * 1000;
                        this.tokenExpiry = new Date(expiryTime);
                        return Date.now() >= expiryTime;
                    } catch (e) {
                        console.error("Error checking token expiration:", e);
                        return true;
                    }
                },

                async testConnection() {
                    if (!this.authToken) {
                        return { success: false, message: "No authentication token set" };
                    }
                    if (this.isTokenExpired()) {
                        return { success: false, message: "Authentication token has expired" };
                    }
                    try {
                        const response = await fetch('https://api.zedchampions.com/v1/account', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${this.authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) {
                            return { success: true, message: "Connection successful!" };
                        } else {
                            return { 
                                success: false, 
                                message: `API Error: ${response.status} ${response.statusText}` 
                            };
                        }
                    } catch (error) {
                        return { success: false, message: `Connection error: ${error.message}` };
                    }
                },

                async fetchAllHorses(type = 'racing') {
                    try {
                        if (!this.authToken) {
                            return { success: false, message: "No authentication token set" };
                        }
                        const endpoint = type === 'racing'
                            ? 'https://api.zedchampions.com/v1/stable/racing'
                            : 'https://api.zedchampions.com/v1/stable/breeding';

                        const response = await fetch(endpoint, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${this.authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            return {
                                success: false,
                                message: `API Error: ${response.status} ${response.statusText}`
                            };
                        }

                        const data = await response.json();
                        return { success: true, data: data.horses || [] };
                    } catch (error) {
                        return { success: false, message: `Connection error: ${error.message}` };
                    }
                },

            async fetchHorse(horseId) {
            try {
                // Check if horseId is a full URL and extract just the ID
                if (horseId.includes('zedchampions.com/horse/')) {
                    horseId = horseId.split('/').pop();
                }
                
                const response = await fetch(`https://api.zedchampions.com/v1/horses/${horseId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${this.authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return { success: true, data };
                } else {
                    return { success: false, message: `API Error: ${response.status} ${response.statusText}` };
                }
            } catch (error) {
                return { success: false, message: `Connection error: ${error.message}` };
            }
            },

                async searchHorses(query) {
                    if (!this.authToken) return { success: false, message: "No auth token set" };
                    try {
                        const response = await fetch(`https://api.zedchampions.com/v1/horses/search?q=${encodeURIComponent(query)}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${this.authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            return { success: true, data: data.results || [] };
                        } else {
                            return { success: false, message: `API Error: ${response.status} ${response.statusText}` };
                        }
                    } catch (error) {
                        return { success: false, message: `Connection error: ${error.message}` };
                    }
                }
            };
            window.zedApi = ZED_API; window.zedApi.apiService = window.zedApi;
            // API endpoint configuration (Fix 2 - Part 1)
            const API_CONFIG = {
                // Production endpoints
                production: {
                    baseUrl: "/api/zed", // This will use the server-side proxy in production
                    useProxy: true
                },
                // Development fallbacks with mock data
                development: {
                    useProxy: true,
                    baseUrl: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? "http://localhost:3000/api/zed" 
                    : "/api/zed"
                }
            };

            // Add a function to get the current environment API config
            function getApiConfig() {
                // In production (Vercel deployment)
                if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    return API_CONFIG.production;
                }
                // In development
                return API_CONFIG.development;
            }

            // Then update ZED_API to use the proxy
            // Add this to setupApiFallbacks function
            function updateApiEndpoints() {
                const config = getApiConfig();
                
                // Store original methods
                const originalFetchHorse = ZED_API.fetchHorse;
                const originalFetchAllHorses = ZED_API.fetchAllHorses;
                const originalTestConnection = ZED_API.testConnection;
                
                // Override with proxy-aware versions
                ZED_API.fetchHorse = async function(horseId) {
                    try {
                    if (config.useProxy) {
                        const response = await fetch(`${config.baseUrl}/horses/${horseId}`, {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                        });
                        
                        if (response.ok) {
                        const data = await response.json();
                        return { success: true, data };
                        } else {
                        return { success: false, message: `API Error: ${response.status}` };
                        }
                    } else {
                        return await originalFetchHorse.call(this, horseId);
                    }
                    } catch (error) {
                    console.warn("API connection failed, using fallback");
                    // Use the fallback implementation
                    return {
                        success: true,
                        data: {
                        id: horseId || "sample-12345",
                        name: "Sample Horse",
                        bloodline: "Nakamoto",
                        gender: "colt",
                        color: "#DC143C",
                        overall_rating: 3.5,
                        speed_rating: 3.2,
                        sprint_rating: 3.8,
                        endurance_rating: 3.3
                        }
                    };
                    }
               };
            
                console.log("Updated API endpoints to use proxy:", config.useProxy ? "enabled" : "disabled");
            }

            // Call this function during initialization
            updateApiEndpoints();

            // Call the fallback setup function
            setupApiFallbacks();
            
            // Fix the syntax error by closing the setupApiFallbacks function properly
            
            
            function fixApiConnectionHandling() {
            // If ZED_API doesn't have a testConnection method, add one
            if (!ZED_API.testConnection) {
                ZED_API.testConnection = async function() {
                    if (!this.authToken) {
                        return { success: false, message: "No API token set. Please set your token first." };
                    }
                    
                    if (this.isTokenExpired()) {
                        return { success: false, message: "Your API token has expired. Please get a new token." };
                    }
                    
                    try {
                        const response = await fetch('https://api.zedchampions.com/v1/me', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${this.authToken}`,
                                'Content-Type': 'application/json'
                            },
                            timeout: 10000
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            return { 
                                success: true, 
                                message: `Connected successfully. Welcome, ${data.username || 'racer'}!`,
                                data
                            };
                        } else {
                            return { success: false, message: `API Error: ${response.status} ${response.statusText}` };
                        }
                    } catch (error) {
                        return { success: false, message: `Connection error: ${error.message}` };
                    }
                };
            }
    
    // Better status display function
    ZED_API.showStatus = function(message, isSuccess, statusEl) {
        statusEl = statusEl || document.getElementById('test-api-connection-status');
        if (!statusEl) return;
        
        statusEl.style.display = 'block';
        statusEl.innerHTML = message;
        
        if (isSuccess === true) {
            statusEl.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
            statusEl.style.color = '#4CAF50';
            statusEl.style.padding = '12px';
            statusEl.style.borderRadius = '4px';
        } else if (isSuccess === false) {
            statusEl.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
            statusEl.style.color = '#F44336';
            statusEl.style.padding = '12px';
            statusEl.style.borderRadius = '4px';
        } else {
            statusEl.style.backgroundColor = 'rgba(33, 150, 243, 0.2)';
            statusEl.style.color = '#2196F3';
            statusEl.style.padding = '12px';
            statusEl.style.borderRadius = '4px';
        }
    };
}

            document.addEventListener('DOMContentLoaded', () => {
                // After other initialization...
                fixApiConnectionHandling();
            });
                    
            // Update the showConnectionStatus function to provide more helpful guidance
            window.showConnectionStatus = function(message, isSuccess) {
                const statusEl = document.getElementById('api-connection-status');
                if (!statusEl) return;
                
                statusEl.style.display = 'block';
                
                // Add troubleshooting tips for errors
                if (isSuccess === false && message.includes("Failed to fetch")) {
                    message += `<br><br><strong>Troubleshooting:</strong>
                        <ul>
                            <li>Check your internet connection</li>
                            <li>Make sure you have the latest API token from ZedChampions</li>
                            <li>API tokens expire after 24 hours - you may need a new one</li>
                        </ul>`;
                }
                
                statusEl.innerHTML = message;
                
                if (isSuccess === true) {
                    statusEl.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                    statusEl.style.color = '#4CAF50';
                    statusEl.style.padding = '12px';
                    statusEl.style.borderRadius = '4px';
                } else if (isSuccess === false) {
                    statusEl.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
                    statusEl.style.color = '#F44336';
                    statusEl.style.padding = '12px';
                    statusEl.style.borderRadius = '4px';
                } else {
                    statusEl.style.backgroundColor = 'rgba(33, 150, 243, 0.2)';
                    statusEl.style.color = '#2196F3';
                    statusEl.style.padding = '12px';
                    statusEl.style.borderRadius = '4px';
                }
            };

            // Call this during initialization - add this to your document.addEventListener('DOMContentLoaded') handler
            document.addEventListener('DOMContentLoaded', () => {
                // After other initialization...
                fixApiConnectionHandling();
            });
                
        // Add these functions for importing horses
        // Replace your existing importRacingStable function
        function importRacingStable() {
            const statusElement = document.getElementById('racing-import-status');
            
            // Check API token
            if (!ZED_API.authToken) {
                showImportStatus(statusElement, 'No API token set. Please set your ZedChampions API token first.', false);
                return;
            }
            
            if (ZED_API.isTokenExpired()) {
                showImportStatus(statusElement, 'Your API token has expired. Please get a new token.', false);
                return;
            }
            
            // Show loading status with spinner
            showImportStatus(statusElement, '<div class="spinner"></div> Loading your racing stable... Please wait, this may take a moment.', null);
            
            // Call ZED API to get racing stable
            ZED_API.fetchAllHorses('racing')
                .then(result => {
                if (!result.success) {
                    showImportStatus(statusElement, `Error: ${result.message}`, false);
                    return;
                }
                
                const importedHorses = result.data;
                const importCount = importedHorses.length;
                
                if (importCount === 0) {
                    showImportStatus(statusElement, 'No racing horses found to import.', false);
                    return;
                }
                
                // Process each horse
                let newHorsesCount = 0;
                let updatedHorsesCount = 0;
                
                importedHorses.forEach(horseData => {
                    const existingHorse = horses.find(h => h.zedId === horseData.id);
                    
                    const processedHorse = {
                    id: existingHorse?.id || `horse-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                    name: horseData.name,
                    bloodline: horseData.bloodline,
                    color: horseData.color || '#CCCCCC',
                    gender: horseData.gender,
                    stars: horseData.overall_rating || null,
                    speedStars: horseData.speed_rating || null,
                    sprintStars: horseData.sprint_rating || null,
                    enduranceStars: horseData.endurance_rating || null,
                    initialZedBalance: existingHorse?.initialZedBalance || 0,
                    initialMmRating: existingHorse?.initialMmRating || 1000,
                    status: 'racing',
                    generation: horseData.genotype || 0,
                    importedFromZed: true,
                    zedId: horseData.id,
                    lastUpdated: new Date().toISOString()
                    };
                    
                    if (existingHorse) {
                    Object.assign(existingHorse, processedHorse);
                    updatedHorsesCount++;
                    } else {
                    horses.push(processedHorse);
                    newHorsesCount++;
                    }
                });
                
                // Save and update UI
                saveData();
                renderHorsesTable();
                updateHorseDropdown();
                updateParentDropdowns();
                populateAugmentAnalysisHorseFilter();
                
                const summaryHTML = `
                    <div class="import-summary">
                    <h3>Import Summary</h3>
                    <div class="import-stats">
                        <div class="stat-item">
                        <div class="stat-value">${importCount}</div>
                        <div class="stat-label">Total Horses</div>
                        </div>
                        <div class="stat-item">
                        <div class="stat-value">${newHorsesCount}</div>
                        <div class="stat-label">New Horses</div>
                        </div>
                        <div class="stat-item">
                        <div class="stat-value">${updatedHorsesCount}</div>
                        <div class="stat-label">Updated</div>
                        </div>
                    </div>
                    <p style="margin-top:15px;">All horses have been imported to your Racing stable.</p>
                    <button class="button" onclick="activateTab('racing')">View Racing Stable</button>
                    </div>
                `;
                
                showImportStatus(statusElement, summaryHTML, true);
                })
                .catch(error => {
                console.error("Import error:", error);
                showImportStatus(statusElement, `Error importing horses: ${error.message}`, false);
                });
        }
        
        function importBreedingStable() {
            const statusElement = document.getElementById('breeding-import-status');
            
            // Check API token
            if (!ZED_API.authToken) {
                showImportStatus(statusElement, 'No API token set. Please set your ZedChampions API token first.', false);
                return;
            }
            
            if (ZED_API.isTokenExpired()) {
                showImportStatus(statusElement, 'Your API token has expired. Please get a new token.', false);
                return;
            }
            
            // Show loading status
            showImportStatus(statusElement, 'Loading your breeding stable... This may take some time.', null);
            
            // Call ZED API to get breeding stable
            ZED_API.fetchAllHorses('breeding')
                .then(result => {
                    if (!result.success) {
                        showImportStatus(statusElement, `Error: ${result.message}`, false);
                        return;
                    }
                    
                    const importedHorses = result.data;
                    const importCount = importedHorses.length;
                    
                    if (importCount === 0) {
                        showImportStatus(statusElement, 'No breeding horses found to import.', false);
                        return;
                    }
                    
                    // Process each horse
                    let newHorsesCount = 0;
                    let updatedHorsesCount = 0;
                    
                    importedHorses.forEach(horseData => {
                        const existingHorse = horses.find(h => h.zedId === horseData.id);
                        
                        const processedHorse = {
                            id: existingHorse?.id || `horse-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                            name: horseData.name,
                            bloodline: horseData.bloodline,
                            color: horseData.color || '#CCCCCC', // Default if color missing
                            gender: horseData.gender,
                            stars: horseData.overall_rating || null,
                            speedStars: horseData.speed_rating || null,
                            sprintStars: horseData.sprint_rating || null,
                            enduranceStars: horseData.endurance_rating || null,
                            status: 'breeding',
                            generation: horseData.genotype || 0,
                            importedFromZed: true,
                            zedId: horseData.id,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        if (existingHorse) {
                            // Update existing horse
                            Object.assign(existingHorse, processedHorse);
                            updatedHorsesCount++;
                        } else {
                            // Add new horse
                            horses.push(processedHorse);
                            newHorsesCount++;
                        }
                    });
                    
                    // Save and update UI
                    saveData();
                    renderBreedingHorsesTable();
                    updateParentDropdowns();
                    updateFoalPredictorDropdowns();
                    updateStudAuctionSelect();
                    
                    showImportStatus(
                        statusElement, 
                        `Successfully imported ${importCount} horses (${newHorsesCount} new, ${updatedHorsesCount} updated).`,
                        true
                    );
                    
                    // Switch to Breeding tab to see results
                    activateTab('breeding');
                })
                .catch(error => {
                    console.error("Import error:", error);
                    showImportStatus(statusElement, `Error importing horses: ${error.message}`, false);
                });
        }

        // Replace your existing importSingleHorse function
        function importSingleHorse() {
            const statusElement = document.getElementById('single-import-status');
            const horseId = document.getElementById('zed-horse-id').value.trim();
            const importType = document.getElementById('import-horse-type').value;
            
            // Validate inputs
            if (!horseId) {
                showImportStatus(statusElement, 'Please enter a horse ID or search for a horse first.', false);
                return;
            }
            
            // Check API token
            if (!ZED_API.authToken) {
                showImportStatus(statusElement, 'No API token set. Please set your ZedChampions API token first.', false);
                return;
            }
            
            if (ZED_API.isTokenExpired()) {
                showImportStatus(statusElement, 'Your API token has expired. Please get a new token.', false);
                return;
            }
            
            // Show loading status with spinner
            showImportStatus(statusElement, `<div class="spinner"></div> Importing horse ${horseId}...`, null);
            
            // Fetch the horse data
            ZED_API.fetchHorse(horseId)
                .then(result => {
                if (!result.success) {
                    showImportStatus(statusElement, `Error: ${result.message}`, false);
                    return;
                }
                
                const horseData = result.data;
                const existingHorse = horses.find(h => h.zedId === horseData.id);
                
                const processedHorse = {
                    id: existingHorse?.id || `horse-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                    name: horseData.name || `Horse ${horseData.id.substring(0, 6)}`,
                    bloodline: horseData.bloodline,
                    color: horseData.color || '#CCCCCC', // Default if color missing
                    gender: horseData.gender,
                    stars: horseData.overall_rating || null,
                    speedStars: horseData.speed_rating || null,
                    sprintStars: horseData.sprint_rating || null,
                    enduranceStars: horseData.endurance_rating || null,
                    initialZedBalance: existingHorse?.initialZedBalance || 0,
                    initialMmRating: existingHorse?.initialMmRating || 1000,
                    status: importType,
                    generation: horseData.genotype || 0,
                    importedFromZed: true,
                    zedId: horseData.id,
                    lastUpdated: new Date().toISOString()
                };
                
                let message = '';
                
                if (existingHorse) {
                    // Update existing horse
                    Object.assign(existingHorse, processedHorse);
                    message = `
                    <div class="import-success">
                        <h3>Updated Horse: ${horseData.name}</h3>
                        <div class="horse-preview">
                        <div class="horse-image" style="background-color:${horseData.color || '#CCCCCC'}"></div>
                        <div class="horse-details">
                            <p><strong>Bloodline:</strong> ${horseData.bloodline}</p>
                            <p><strong>Gender:</strong> ${horseData.gender}</p>
                            <p><strong>Generation:</strong> ${horseData.genotype || 'N/A'}</p>
                            <p><strong>Type:</strong> ${importType.charAt(0).toUpperCase() + importType.slice(1)} Horse</p>
                        </div>
                        </div>
                    </div>
                    `;
                } else {
                    // Add new horse
                    horses.push(processedHorse);
                    message = `
                    <div class="import-success">
                        <h3>Imported New Horse: ${horseData.name}</h3>
                        <div class="horse-preview">
                        <div class="horse-image" style="background-color:${horseData.color || '#CCCCCC'}"></div>
                        <div class="horse-details">
                            <p><strong>Bloodline:</strong> ${horseData.bloodline}</p>
                            <p><strong>Gender:</strong> ${horseData.gender}</p>
                            <p><strong>Generation:</strong> ${horseData.genotype || 'N/A'}</p>
                            <p><strong>Type:</strong> ${importType.charAt(0).toUpperCase() + importType.slice(1)} Horse</p>
                        </div>
                        </div>
                    </div>
                    `;
                }
                
                // Save and update UI
                saveData();
                
                if (importType === 'racing') {
                    renderHorsesTable();
                    updateHorseDropdown();
                    // Optionally switch tab
                    setTimeout(() => activateTab('racing'), 1500);
                } else {
                    renderBreedingHorsesTable();
                    updateFoalPredictorDropdowns();
                    updateStudAuctionSelect();
                    // Optionally switch tab
                    setTimeout(() => activateTab('breeding'), 1500);
                }
                
                updateParentDropdowns();
                populateAugmentAnalysisHorseFilter();
                
                // Show success message with styled preview
                showImportStatus(statusElement, message, true);
                
                // Clear input field
                document.getElementById('zed-horse-id').value = '';
                })
                .catch(error => {
                console.error("Import error:", error);
                showImportStatus(statusElement, `Error importing horse: ${error.message}`, false);
                });
        }             
                    
                // Find and enhance the predict button if it exists
                const predictButton = document.getElementById('predict-foal-btn');
                if (predictButton) {
                    predictButton.addEventListener('click', function(event) {
                        event.preventDefault();
                        
                        const sireSelect = document.getElementById('predict-sire');
                        const damSelect = document.getElementById('predict-dam');
                        const resultDiv = document.getElementById('foal-prediction-result');
                        
                        if (!sireSelect || !damSelect || !resultDiv) return;
                        
                        const sireName = sireSelect.value;
                        const damName = damSelect.value;
                        
                        if (!sireName || !damName) {
                            resultDiv.innerHTML = '<p style="color:var(--error-color)">Please select both sire and dam</p>';
                            return;
                        }
                        
                        // Find the horses by name in the horses array
                        const sire = horses.find(h => h.name === sireName && h.gender === 'Male');
                        const dam = horses.find(h => h.name === damName && h.gender === 'Female');
                        
                        if (!sire || !dam) {
                            resultDiv.innerHTML = '<p style="color:var(--error-color)">Selected horses not found</p>';
                            return;
                        }
                        
                        // Get the prediction
                        const prediction = predictFoal(sire, dam);
                        
                        // Display detailed results with styling
                        resultDiv.innerHTML = `
                            <div style="padding: 15px; background-color: var(--section-bg); border-radius: 8px; margin-top: 10px;">
                                <h4 style="margin-top: 0; color: var(--accent-color);">Predicted Foal Attributes</h4>
                                <p><strong>Bloodline:</strong> ${prediction.bloodline}</p>
                                <p><strong>Gender:</strong> ${prediction.gender}</p>
                                <p><strong>Color:</strong> <span class="swatch"></span> <!-- Color label will be inserted by JS --></p>
                                <p><strong>Overall Stars:</strong> ${prediction.overallStars}</p>
                                <p><strong>Speed Stars:</strong> ${prediction.speedStars || 'Unknown'}</p>
                                <p><strong>Sprint Stars:</strong> ${prediction.sprintStars || 'Unknown'}</p>
                                <p><strong>Endurance Stars:</strong> ${prediction.enduranceStars || 'Unknown'}</p>
                                <p style="font-size: 0.9em; color: var(--text-muted-color);">Note: Results are estimates and may vary.</p>
                            </div>
                        `;
                        
                        // Add animation effect
                        resultDiv.style.animation = "fadeIn 0.5s ease-in-out";
                    });
                }
            
    // Fix for bloodline change handler
    window.onBloodlineChange = function(colorId, traitsId, attrsId) {
      const colorEl = document.getElementById(colorId);
      const traitsEl = document.getElementById(traitsId);
      const attrsEl = document.getElementById(attrsId);
      
      // Find the bloodline element
      const bloodId = colorId.replace('color', 'bloodline');
      const bloodEl = document.getElementById(bloodId);
      
      if (!bloodEl || !colorEl) return;
      
      // Get the selected bloodline
      const bloodline = bloodEl.value;
      
      // Update color options
      colorEl.innerHTML = '<option value="">--Select Color--</option>';
      
      if (bloodline && window.breedColorOptions && window.breedColorOptions[bloodline]) {
        ["normal", "rare", "super rare"].forEach(rarity => {
          if (window.breedColorOptions[bloodline][rarity]) {
            window.breedColorOptions[bloodline][rarity].forEach(color => {
              const option = document.createElement('option');
              option.value = color.hex;
              option.textContent = color.label;
              colorEl.appendChild(option);
            });
          }
        });
      }
      
      // Set the first color option as selected
      if (colorEl.options.length > 1) {
        colorEl.selectedIndex = 1;
      }
      
      // Update traits if element exists
      if (traitsEl && bloodline && window.bloodlineTraits && window.bloodlineTraits[bloodline]) {
        traitsEl.innerHTML = '';
        window.bloodlineTraits[bloodline].forEach(trait => {
          const option = document.createElement('option');
          option.value = trait;
          option.textContent = trait;
          traitsEl.appendChild(option);
        });
      }
      
      // Update attributes if element exists
      if (attrsEl && bloodline && window.bloodlineAttributes && window.bloodlineAttributes[bloodline]) {
        attrsEl.innerHTML = '';
        window.bloodlineAttributes[bloodline].forEach(attr => {
          const option = document.createElement('option');
          option.value = attr;
          option.textContent = attr;
          attrsEl.appendChild(option);
        });
      }
    };
        
        // 3 UI update functions // populate `select` with id=colorSelectId based on bloodline in bloodSelectId
        function populateColorOptions(bloodline) {
        const color = document.getElementById('horse-color').value;
        colorSelect.innerHTML = '<option value="">--Select Color--</option>';
        if (!bloodline || !breedColorOptions[bloodline]) return;
        ["normal","rare","super rare"].forEach(rarity => {
            const group = breedColorOptions[bloodline][rarity];
            if (group && group.length) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = rarity.charAt(0).toUpperCase() + rarity.slice(1);
            group.forEach(c => {
                const o = document.createElement('option');
                o.value = c.hex;
                o.textContent = `${c.label} (${c.hex})`;
                o.title = c.hex;
                o.style.backgroundColor = c.hex;
                o.setAttribute('data-rarity', rarity);
                optgroup.appendChild(o);
            });
            colorSelect.appendChild(optgroup);
            }
        });
            if (colorSelect.options.length > 1) colorSelect.selectedIndex = 1;
            }

            function displayTraits() {
            const blood = document.getElementById('horse-bloodline').value;
            const list = document.getElementById('horse-traits');
            list.innerHTML = '';
            (bloodlineTraits[blood] || []).forEach(t => {
                const li = document.createElement('li');
                li.textContent = t;
                list.appendChild(li);
            });
            }
            function displayAttributes() {
            const blood = document.getElementById('horse-bloodline').value;
            const list = document.getElementById('horse-attributes');
            list.innerHTML = '';
            (bloodlineAttributes[blood] || []).forEach(a => {
                const li = document.createElement('li');
                li.textContent = a;
                list.appendChild(li);
            });
            }
            function getColorLabel(bloodline, hex) {
            if (!bloodline || !hex || !breedColorOptions[bloodline]) return hex || '';
            for (const rarity of ["normal","rare","super rare"]) {
                const found = breedColorOptions[bloodline][rarity].find(opt => opt.hex.toLowerCase() === (hex || '').toLowerCase());
                if (found) return `${found.label} (${rarity})`;
            }
            return hex || '';
            }
            // Generalized function for any section
            function populateColorOptionsFor(bloodId, colorId) {
            const bloodEl = document.getElementById(bloodId);
            const sel = document.getElementById(colorId);
            sel.innerHTML = '<option value="">--Select Color--</option>';
            if (!bloodEl) return;
            const blood = bloodEl.value;
            if (!blood || !breedColorOptions[blood]) return;
            ["normal","rare","super rare"].forEach(rarity => {
                const group = breedColorOptions[blood][rarity];
                if (group && group.length) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = rarity.charAt(0).toUpperCase() + rarity.slice(1);
                group.forEach(c => {
                    const o = document.createElement('option');
                    o.value = c.hex;
                    o.textContent = `${c.label} (${c.hex})`;
                    o.title = c.hex;
                    o.style.backgroundColor = c.hex;
                    o.setAttribute('data-rarity', rarity);
                    optgroup.appendChild(o);
                });
                sel.appendChild(optgroup);
                }
            });
            if (sel.options.length > 1) sel.selectedIndex = 1;
            }
        // --- Global State ---
        let horses = []; // Racing horses
        let races = [];
        let breedingHorses = [];
        let bredHorses = [];
        let studAuctions = []; // Stud auction income records
        let transactions = []; // Horse sales and purchases
        // Augment lists - managed dynamically
        let cpuAugments = [];
        let ramAugments = [];
        let hydraulicAugments = [];
        let totalRetirementEarnings = 0; // Will be loaded from localStorage
        let racingHorseSort = { key: 'name', direction: 'asc' }; // Initial sort state
        // Pagination State for Horses Table
        let horseTableCurrentPage = 1;
        let horseTableItemsPerPage = 10; // Default, will be loaded
        // Pagination State for Races Table
        let raceTableCurrentPage = 1;
        let raceTableItemsPerPage = 10; // Default, will be loaded
        // Pagination State for Breeding Horses Table
        let breedingHorseTableCurrentPage = 1;
        let breedingHorseTableItemsPerPage = 10; // Default, will be loaded
        // Pagination State for Bred History Table
        let bredHistoryTableCurrentPage = 1;
        let bredHistoryTableItemsPerPage = 10; // Default, will be loaded
        // Pagination State for Stud Auction Table
        let studAuctionTableCurrentPage = 1;
        let studAuctionTableItemsPerPage = 10; // Default, will be loaded
        // Pagination State for Transactions Table
        let transactionTableCurrentPage = 1;
        let transactionTableItemsPerPage = 10; // Default, will be loaded
        
        // Editing states
        let currentlyEditingHorse = null; // For editing a horse
        let currentlyEditingRace = null;  // For editing a race
        let currentlyEditingStudAuction = null; // For editing a stud auction
        let currentlyEditingTransaction = null; // For editing a transaction

        // Declare modal variables globally (scoped to the script)
        let modal, modalCloseBtn, modalTitle, modalStatsContent, modalAnalysisContent;

        // --- DOM Elements ---
        const addHorseForm = document.getElementById('add-horse-form');
        const horsesTableBody = document.getElementById('horses-table-body');
        const raceHorseSelect = document.getElementById('race-horse');
        const addRaceForm = document.getElementById('add-race-form');
        const racesTableBody = document.getElementById('races-table-body');
        const cpuAugmentSelect = document.getElementById('race-cpu-augment');
        const ramAugmentSelect = document.getElementById('race-ram-augment');
        const hydraulicAugmentSelect = document.getElementById('race-hydraulic-augment');
        const totalRacesSpan = document.getElementById('total-races');
        const totalZedChangeSpan = document.getElementById('total-zed-change');
        // Breeding Horse Elements
        const addBreedingHorseForm = document.getElementById('add-breeding-horse-form');
        const breedingStableTableBody = document.getElementById('breeding-horses-table-body'); // Use distinct name
        // Bred Horse Elements
        const addBredHorseForm = document.getElementById('add-bred-horse-form');
        const bredHorsesTableBody = document.getElementById('bred-horses-table-body');
        const sireSelect = document.getElementById('bred-sire');
        const damSelect = document.getElementById('bred-dam');
        const sireStatsDiv = document.getElementById('sire-stats');
        const damStatsDiv = document.getElementById('dam-stats');
        const useExternalSireCheckbox = document.getElementById('use-external-sire');
        const externalSireFields = document.querySelectorAll('.external-sire-fields');
        const externalSireNameInput = document.getElementById('external-sire-name');
        const externalSireBloodlineSelect = document.getElementById('external-sire-bloodline');
        // Stud Auction Elements
        const addStudAuctionForm = document.getElementById('add-stud-auction-form');
        const studAuctionHorseSelect = document.getElementById('stud-auction-horse');
        const studAuctionPriceInput = document.getElementById('stud-auction-price');
        const studAuctionDateInput = document.getElementById('stud-auction-date');
        const studAuctionCommissionInput = document.getElementById('stud-auction-commission');
        const studAuctionTableBody = document.getElementById('stud-auction-table-body');
        const totalStudAuctionIncomeSpan = document.getElementById('total-stud-auction-income');

        // Tab Elements
        const tabButtonContainer = document.getElementById('tab-buttons');
        const tabContentContainer = document.getElementById('tab-content');
        // const tabButtons = document.querySelectorAll('.tab-button'); // REMOVED duplicate declaration
        // const tabContents = document.querySelectorAll('.tab-content'); // REMOVED duplicate declaration

        // Augment Management Elements
        const addAugmentForm = document.getElementById('add-augment-form');
        const cpuAugmentList = document.getElementById('cpu-augment-list');
        const ramAugmentList = document.getElementById('ram-augment-list');
        const hydraulicAugmentList = document.getElementById('hydraulic-augment-list');

        // Stats Elements
        const totalRetirementEarningsSpan = document.getElementById('total-retirement-earnings');
        const totalStudFeesSpan = document.getElementById('total-stud-fees');

        // Filter/Search Elements
        const horseSearchInput = document.getElementById('horse-search-input');
        const horseFilterBloodline = document.getElementById('horse-filter-bloodline');
        const horseFilterGender = document.getElementById('horse-filter-gender');
        
        // Augment Analysis Filter
        const augmentAnalysisHorseFilter = document.getElementById('augment-analysis-horse-filter');
        
        // Star filter elements
        const horseFilterMinStars = document.getElementById('horse-filter-min-stars');
        const horseFilterMaxStars = document.getElementById('horse-filter-max-stars');
        const horseFilterMinSpeed = document.getElementById('horse-filter-min-speed');
        const horseFilterMaxSpeed = document.getElementById('horse-filter-max-speed');
        const horseFilterMinSprint = document.getElementById('horse-filter-min-sprint');
        const horseFilterMaxSprint = document.getElementById('horse-filter-max-sprint');
        const horseFilterMinEndurance = document.getElementById('horse-filter-min-endurance');
        const horseFilterMaxEndurance = document.getElementById('horse-filter-max-endurance');

        // Pagination Elements for Horses Table
        const horsesItemsPerPageSelect = document.getElementById('horses-items-per-page');
        const horsesPrevPageButton = document.getElementById('horses-prev-page');
        const horsesNextPageButton = document.getElementById('horses-next-page');
        const horsesPageInfoSpan = document.getElementById('horses-page-info');

        // Pagination Elements for Races Table
        const racesItemsPerPageSelect = document.getElementById('races-items-per-page');
        const racesPrevPageButton = document.getElementById('races-prev-page');
        const racesNextPageButton = document.getElementById('races-next-page');
        const racesPageInfoSpan = document.getElementById('races-page-info');

        // Pagination Elements for Breeding Horses Table
        const breedingHorsesItemsPerPageSelect = document.getElementById('breeding-horses-items-per-page');
        const breedingHorsesPrevPageButton = document.getElementById('breeding-horses-prev-page');
        const breedingHorsesNextPageButton = document.getElementById('breeding-horses-next-page');
        const breedingHorsesPageInfoSpan = document.getElementById('breeding-horses-page-info');

        // Pagination Elements for Bred History Table
        const bredHistoryItemsPerPageSelect = document.getElementById('bred-history-items-per-page');
        const bredHistoryPrevPageButton = document.getElementById('bred-history-prev-page');
        const bredHistoryNextPageButton = document.getElementById('bred-history-next-page');
        const bredHistoryPageInfoSpan = document.getElementById('bred-history-page-info');

        // Pagination Elements for Stud Auction Table
        const studAuctionItemsPerPageSelect = document.getElementById('stud-auction-items-per-page');
        const studAuctionPrevPageButton = document.getElementById('stud-auction-prev-page');
        const studAuctionNextPageButton = document.getElementById('stud-auction-next-page');
        const studAuctionPageInfoSpan = document.getElementById('stud-auction-page-info');

        // Pagination Elements for Transactions Table
        const transactionsItemsPerPageSelect = document.getElementById('transactions-items-per-page');
        const transactionsPrevPageButton = document.getElementById('transactions-prev-page');
        const transactionsNextPageButton = document.getElementById('transactions-next-page');
        const transactionsPageInfoSpan = document.getElementById('transactions-page-info');

        // ...existing code...
        // Helper function to display API connection status
       function showConnectionStatus (message, isSuccess) {
            const statusEl = document.getElementById('api-connection-status');
            if (!statusEl) return;
            
            statusEl.style.display = 'block';
            statusEl.textContent = message;
            
            if (isSuccess === true) {
                statusEl.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                statusEl.style.color = '#4CAF50';
            } else if (isSuccess === false) {
                statusEl.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
                statusEl.style.color = '#F44336';
            } else {
                statusEl.style.backgroundColor = 'rgba(33, 150, 243, 0.2)';
                statusEl.style.color = '#2196F3';
            }
        }
       
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Tracker Initializing...");

            // --- Tab Button/Content Fix ---
            window.tabButtons = Array.from(document.querySelectorAll('.tab-button'));
            window.tabContents = Array.from(document.querySelectorAll('.tab-content'));
            
            // If they're not found, create them from your tab-buttons container
            if (!window.tabButtons.length) {
                const buttonContainer = document.getElementById('tab-buttons');
                if (buttonContainer) {
                    // Create tab buttons if they don't exist
                    const tabIds = ['racing', 'breeding', 'transactions', 'augments', 'analysis', 'stats', 'import'];
                    const tabLabels = ['Racing', 'Breeding', 'Transactions', 'Augments', 'Analysis', 'Stats', 'Import'];
                    
                    tabIds.forEach((id, index) => {
                        const button = document.createElement('button');
                        button.className = 'tab-button';
                        button.setAttribute('data-tab', id);
                        button.textContent = tabLabels[index];
                        buttonContainer.appendChild(button);
                });
                
                // Re-query the buttons after creating them
                window.tabButtons = Array.from(document.querySelectorAll('.tab-button'));
            }
        }

        // Re-query tab contents
        window.tabContents = Array.from(document.querySelectorAll('.tab-content'));

        console.log('Tab initialization complete:', 
            {buttons: window.tabButtons.length, contents: window.tabContents.length});

            // Assign modal variables after DOM is loaded
            modal = document.getElementById('horse-details-modal');

            // Assign modal variables after DOM is loaded
            modal = document.getElementById('horse-details-modal');
            modalCloseBtn = document.getElementById('modal-close-button');
            modalTitle = document.getElementById('modal-horse-name');
            modalStatsContent = document.getElementById('modal-stats-content');
            modalAnalysisContent = document.getElementById('modal-analysis-content');

            // Add event listeners for bloodline changes on all forms
            forms.forEach(f => {
                const el = document.getElementById(`${f.prefix}-bloodline`);
                if (el) {
                    el.addEventListener('change', () => onBloodlineChange(
                        `${f.prefix}-bloodline`,
                        f.color, f.traits, f.attrs
                    ));
                }
            }); // <-- This closes the forEach!

            // Initialize color/traits/attributes for all forms
            forms.forEach(f => onBloodlineChange(
                `${f.prefix}-bloodline`,
                f.color, f.traits, f.attrs
            ));

            // Initialize color/traits/attributes for all forms
            forms.forEach(f => onBloodlineChange(
                `${f.prefix}-bloodline`,
                f.color, f.traits, f.attrs
            ));

            // Main initialization
            loadData(); // Load data FIRST
            populateAugmentDropdowns();
            populateAugmentAnalysisHorseFilter();
            initializeTabs();
            renderHorsesTable();
            renderBreedingHorsesTable();
            renderRacesTable();
            renderBredHorsesTable();
            renderStudAuctionTable();
            renderTransactionsTable();
            renderAugmentAnalysis();
            updateHorseDropdown();
            updateParentDropdowns();
            updateFoalPredictorDropdowns();
            updateStudAuctionSelect();
            updateOverallStats();

            setupEventListeners();

            // --- ZedChampions API UI and Import UI ---
            
            ZED_API.loadAuthToken();

            console.log("Tracker Initialized.");
        });
        // --- End Initialization ---
        
        // --- Data Storage (localStorage) ---
        function loadData() {
            // Load main horses list first
            horses = JSON.parse(localStorage.getItem('zedTrackerHorses') || '[]');
            races = JSON.parse(localStorage.getItem('zedTrackerRaces') || '[]');
            bredHorses = JSON.parse(localStorage.getItem('zedTrackerBredHorses') || '[]');
            studAuctions = JSON.parse(localStorage.getItem('zedTrackerStudAuctions') || '[]'); // Load stud auctions
            transactions = JSON.parse(localStorage.getItem('zedTrackerTransactions') || '[]'); // Load transactions
            cpuAugments = JSON.parse(localStorage.getItem('zedTrackerCpuAugments') || '["Void C100", "Crimson C", "GX-Core C", "Darklight 100C", "Midnight 100C"]');
            ramAugments = JSON.parse(localStorage.getItem('zedTrackerRamAugments') || '["Void R100", "Crimson R", "GX-Core R", "Darklight 100R", "Midnight 100R"]');
            hydraulicAugments = JSON.parse(localStorage.getItem('zedTrackerHydraulicAugments') || '["Void H100", "Crimson H", "GX-Core H", "Darklight 100H", "Midnight 100H"]');
            totalRetirementEarnings = parseFloat(localStorage.getItem('zedTrackerRetirementEarnings') || '0');
            // Load items per page preference
            horseTableItemsPerPage = parseInt(localStorage.getItem('horseTableItemsPerPage') || '10', 10);
            raceTableItemsPerPage = parseInt(localStorage.getItem('raceTableItemsPerPage') || '10', 10); // Load races pref
            breedingHorseTableItemsPerPage = parseInt(localStorage.getItem('breedingHorseTableItemsPerPage') || '10', 10); // Load breeding pref
            bredHistoryTableItemsPerPage = parseInt(localStorage.getItem('bredHistoryTableItemsPerPage') || '10', 10); // Load bred history pref
            studAuctionTableItemsPerPage = parseInt(localStorage.getItem('studAuctionTableItemsPerPage') || '10', 10); // Load stud auction pref
            transactionTableItemsPerPage = parseInt(localStorage.getItem('transactionsTableItemsPerPage') || '10', 10); // Load transactions pref
            
            // --- Data Migration: Merge old breedingHorses into horses if exists --- //
            
            console.log(`Loaded ${horses.length} total horses, ${races.length} races, ${bredHorses.length} bred horses, ${studAuctions.length} stud auctions, ${transactions.length} transactions.`);
            console.log(`Loaded ${cpuAugments.length} CPU, ${ramAugments.length} RAM, ${hydraulicAugments.length} Hydraulic augments.`);
        }

        function ensureDataIntegrity() {
            // Ensure all horses have a valid status
            horses = horses.map(h => {
                if (!h.status) h.status = 'racing'; // Default to racing if missing
                if (!h.id) h.id = `horse-${Date.now()}-${Math.random().toString(16).slice(2)}`; // Add ID if missing
                return h;
            });
            
            // Ensure races have valid horseId references
            races = races.filter(r => {
                const hasValidHorse = horses.some(h => h.id === r.horseId);
                if (!hasValidHorse) {
                    console.warn("Removing race with invalid horseId:", r);
                }
                return hasValidHorse;
            });
            
            saveData(); // Save the corrected data
            console.log("Data integrity check completed");
        }
        function saveData() {
            localStorage.setItem('zedTrackerHorses', JSON.stringify(horses)); // Unified list
            localStorage.setItem('zedTrackerRaces', JSON.stringify(races));
            localStorage.setItem('zedTrackerBredHorses', JSON.stringify(bredHorses));
            localStorage.setItem('zedTrackerStudAuctions', JSON.stringify(studAuctions)); // Save stud auctions
            localStorage.setItem('zedTrackerTransactions', JSON.stringify(transactions)); // Save transactions
            localStorage.setItem('zedTrackerCpuAugments', JSON.stringify(cpuAugments));
            localStorage.setItem('zedTrackerRamAugments', JSON.stringify(ramAugments));
            localStorage.setItem('zedTrackerHydraulicAugments', JSON.stringify(hydraulicAugments));
            localStorage.setItem('zedTrackerRetirementEarnings', totalRetirementEarnings.toString());
            localStorage.setItem('horseTableItemsPerPage', horseTableItemsPerPage.toString()); // Save items per page
            localStorage.setItem('raceTableItemsPerPage', raceTableItemsPerPage.toString()); // Save races pref
            localStorage.setItem('breedingHorseTableItemsPerPage', breedingHorseTableItemsPerPage.toString()); // Save breeding pref
            localStorage.setItem('bredHistoryTableItemsPerPage', bredHistoryTableItemsPerPage.toString()); // Save bred history pref
            localStorage.setItem('studAuctionTableItemsPerPage', studAuctionTableItemsPerPage.toString()); // Save stud auction pref
            localStorage.setItem('transactionsTableItemsPerPage', transactionTableItemsPerPage.toString()); // Save transactions pref
             console.log("Data saved to localStorage.");
        }

        // --- Populate UI Elements ---
         function populateAugmentDropdowns() {
            // Clear existing options first (keeping the "None" option)
            clearDropdown(cpuAugmentSelect);
            clearDropdown(ramAugmentSelect);
            clearDropdown(hydraulicAugmentSelect);

            populateDropdown(cpuAugmentSelect, cpuAugments);
            populateDropdown(ramAugmentSelect, ramAugments);
            populateDropdown(hydraulicAugmentSelect, hydraulicAugments);

            // Populate the management lists with delete buttons
            populateManagementList(cpuAugmentList, cpuAugments, 'CPU');
            populateManagementList(ramAugmentList, ramAugments, 'RAM');
            populateManagementList(hydraulicAugmentList, hydraulicAugments, 'Hydraulic');
         }

         function clearDropdown(selectElement) {
            // Clear options except the first one ("None")
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
         }

         function populateDropdown(selectElement, options) {
            // Assumes first option ("None") is already present
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });
        }

         // Modified populateList to create management list with delete buttons
         function populateManagementList(ulElement, items, type) {
            ulElement.innerHTML = ''; // Clear existing items
            items.sort().forEach(itemText => { // Sort alphabetically
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${itemText}</span>
                    <button class="action-button delete-button" onclick="handleDeleteAugment('${itemText}', '${type}')" title="Delete Augment">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                `;
                ulElement.appendChild(li);
            });
         }

        // 1. First, fix the updateHorseDropdown function
        function updateHorseDropdown() {
            console.log("Updating horse dropdown with racing horses:", horses.filter(h => h.status === 'racing').length);
            
            if (!raceHorseSelect) {
                console.error("Race horse select element not found!");
                return;
            }
            
            // Clear existing options
            raceHorseSelect.innerHTML = '<option value="">--Select Racing Horse--</option>';
            
            // Only use active racing horses for the race form dropdown
            const racingHorses = horses.filter(h => h.status === 'racing');
            
            // Sort the racing horses alphabetically by name
            racingHorses.sort((a, b) => a.name.localeCompare(b.name));
            
            console.log("Found racing horses to add to dropdown:", racingHorses.length);
            
            racingHorses.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.id;
                option.textContent = horse.name;
                raceHorseSelect.appendChild(option);
            });
        }

        function updateParentDropdowns() {
            const allHorses = [...horses]; // Use the unified list
            const currentSire = sireSelect.value;
            const currentDam = damSelect.value;

            sireSelect.innerHTML = '<option value="">--Select Male Parent--</option>';
            damSelect.innerHTML = '<option value="">--Select Female Parent--</option>';

            allHorses.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically

            allHorses.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.id;
                option.textContent = horse.name;

                if (horse.gender === 'Male') {
                    sireSelect.appendChild(option);
                } else if (horse.gender === 'Female') {
                    damSelect.appendChild(option);
                }
            });

            // Restore previous selections if possible
             if (allHorses.some(h => h.id === currentSire && h.gender === 'Male')) sireSelect.value = currentSire;
             if (allHorses.some(h => h.id === currentDam && h.gender === 'Female')) damSelect.value = currentDam;

             // Trigger stat display update for potentially restored selections
             displayParentStats(sireSelect.value, 'sire');
             displayParentStats(damSelect.value, 'dam');
        }
             
        function updateFoalPredictorDropdowns() {
            const sireSelect = document.getElementById('predict-sire');
            const damSelect = document.getElementById('predict-dam');
            if (!sireSelect || !damSelect) return;

            // Clear existing options
            sireSelect.innerHTML = '<option value="">--Select--</option>';
            damSelect.innerHTML = '<option value="">--Select--</option>';

            // Filter horses by gender AND status
            const breedingMales = horses.filter(h => h.gender === 'Male' && h.status === 'breeding');
            const breedingFemales = horses.filter(h => h.gender === 'Female' && h.status === 'breeding');

            breedingMales.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.name;
                option.textContent = horse.name;
                sireSelect.appendChild(option);
            });

            breedingFemales.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.name;
                option.textContent = horse.name;
                damSelect.appendChild(option);
            });        
        }
            // Add this function after your data storage definitions
            function debugRacesAndHorses() {
                console.group(" DEBUG INFORMATION");
                
                // Debug races data
                console.log(" Total races:", races.length);
                const racesWithNoHorseId = races.filter(r => !r.horseId);
                console.log(" Races with missing horseId:", racesWithNoHorseId.length);
                if (racesWithNoHorseId.length > 0) {
                    console.log("First 5 problematic races:", racesWithNoHorseId.slice(0, 5));
                }
                
                // Debug horses data
                console.log(" Total horses:", horses.length);
                console.log(" Racing horses:", horses.filter(h => h.status === 'racing').length);
                console.log(" Breeding horses:", horses.filter(h => h.status === 'breeding').length);
                
                // Debug race horse dropdown
                console.log(" Race horse select element exists:", !!raceHorseSelect);
                if (raceHorseSelect) {
                    console.log(" Options in race horse dropdown:", raceHorseSelect.options.length);
                }
                
                // Debug race table
                console.log(" Races table body exists:", !!racesTableBody);
                if (racesTableBody) {
                    console.log(" Current rows in races table:", racesTableBody.children.length);
                }
                
                // Check for table header with Horse column
                const racesTable = document.getElementById('races-table');
                if (racesTable) {
                    const headers = Array.from(racesTable.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    console.log(" Race table headers:", headers);
                    console.log(" Contains 'Horse' column:", headers.includes('Horse'));
                } else {
                    console.log(" Races table not found");
                }
                
                // Examine any recent race rendering issues
                const lastRace = races[races.length - 1];
                if (lastRace) {
                    const horse = horses.find(h => h.id === lastRace.horseId);
                    console.log(" Last race details:", {
                        raceId: lastRace.id,
                        horseId: lastRace.horseId,
                        horseName: horse ? horse.name : 'NOT FOUND',
                        date: lastRace.date
                    });
                }
                
                console.groupEnd();
                
                return "Debug information logged to console. Check the browser console (F12) for details.";
            }
            
        // --- Rendering ---
        function renderHorsesTable() {
            horsesTableBody.innerHTML = '';
            
            // 1. Get the correctly filtered list of horses WITH their stats
            const filteredHorsesWithStats = getFilteredRacingHorses();

            // 2. Sort the filtered list
            const { key, direction } = racingHorseSort;
            // Create a mutable copy for sorting
            let horsesToSort = [...filteredHorsesWithStats];
            horsesToSort.sort((a, b) => {
                let valA, valB;

                // Helper to handle null/undefined for sorting numerical values
                const numA = (prop) => a.calculatedStats?.[prop] ?? (direction === 'asc' ? Infinity : -Infinity);
                const numB = (prop) => b.calculatedStats?.[prop] ?? (direction === 'asc' ? Infinity : -Infinity);

                switch (key) {
                    case 'name':
                    case 'bloodline':
                    case 'gender':
                        valA = a[key] || '';
                        valB = b[key] || '';
                        return valA.localeCompare(valB);
                    case 'stars': // Sort by overall stars
                        valA = Number(a.stars) || 0;
                        valB = Number(b.stars) || 0;
                        return valA - valB;
                    case 'mmr':
                        return numA('currentMmr') - numB('currentMmr');
                    case 'zed':
                        return numA('currentZedBalance') - numB('currentZedBalance');
                    case 'wins': // Sort by WINS part of W-P-S
                        return numA('wins') - numB('wins');
                    case 'netProfit': // Sort by Net Profit
                        return numA('netProfit') - numB('netProfit');
                    case 'winRate':
                        return numA('winRate') - numB('winRate');
                    case 'races':
                        return numA('totalRaces') - numB('totalRaces');
                    case 'avgOdds': // --- NEW SORT CASE ---
                        return numA('avgOdds') - numB('avgOdds');
                    default:
                        return 0;
                }
            });

            if (direction === 'desc') {
                horsesToSort.reverse();
            }

            // 3. Pagination Calculation
            const totalItems = horsesToSort.length;
            const totalPages = Math.ceil(totalItems / horseTableItemsPerPage);
            // Ensure currentPage is valid after filtering/itemsPerPage change
            if (horseTableCurrentPage > totalPages) {
                horseTableCurrentPage = Math.max(totalPages, 1); // Go to last page or 1 if empty
            }
            const startIndex = (horseTableCurrentPage - 1) * horseTableItemsPerPage;
            const endIndex = startIndex + horseTableItemsPerPage;
            const horsesToShow = horsesToSort.slice(startIndex, endIndex);

            // 4. Update header sort indicators
            updateSortIndicators();

            // 5. Render the *sliced* rows
            horsesToShow.forEach(horseData => {
                const horse = horseData; // Original horse data
                const stats = horseData.calculatedStats; // Pre-calculated stats

                console.log("Rendering horse:", horse.name, horse);
                
                const row = horsesTableBody.insertRow();
                const formatStars = (stars) => (stars !== null && stars !== undefined && stars !== '') ? Number(stars).toFixed(1) : '-';
                const formatAvgOdds = (avgOdds) => (avgOdds !== null && avgOdds !== undefined) ? avgOdds.toFixed(1) : 'N/A';
        
                // --- UPDATED INNER HTML with Avg Odds column ---
               row.innerHTML = `
                    <td style="max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 12px;">${horse.name || 'Unknown'}</td>
                    <td>${horse.bloodline}</td>
                    <td>
                        <span class="swatch" style="background:
                        ${horse.color};"></span>${getColorLabel(horse.bloodline, horse.color)}
                    </td>
                    <td>${horse.gender}</td>
                    <td>${formatStars(horse.stars)}</td>
                    <td>${stats.currentMmr}</td>
                    <td style="color: ${stats.currentZedBalance >= horse.initialZedBalance ? 'var(--success-color)' : 'var(--error-color)'};">${Math.round(stats.currentZedBalance)}</td>
                    <td>${stats.wins}-${stats.places}-${stats.shows}</td>
                    <td>${formatAvgOdds(stats.avgOdds)}</td> <!-- New Avg Odds Cell -->
                    <td style="color: ${stats.netProfit >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">
                        ${stats.netProfit >= 0 ? '+' : ''}${Math.round(stats.netProfit)}
                        ${stats.roi !== null ? ` (${stats.roi.toFixed(1)}%)` : ''}
                    </td>
                    <td>${stats.winRate.toFixed(1)}%</td>
                    <td>${stats.totalRaces}</td>
                    <td><div class="action-buttons-container">
                        <!-- Action Buttons -->
                        <button class="action-button edit-button" onclick="editHorse('${horse.id}')" title="Edit Horse"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button class="action-button" onclick="showHorseDetailsModal('${horse.id}')" title="View Details"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                        <button class="action-button retire-button" onclick="handleRetireHorse('${horse.id}')" title="Retire Horse"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 22H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h5"></path><polyline points="17 16 21 12 17 8"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                        <button class="action-button delete-button" onclick="deleteHorse('${horse.id}')" title="Delete Horse"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                    </div></td>
                `;
            });

            // 6. Render Pagination Controls
            renderHorsePaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Horses Table ---
        function renderHorsePaginationControls(totalItems, totalPages) {
            // Get references inside the function to ensure they exist if called early
            const itemsPerPageSelectContainer = horsesItemsPerPageSelect?.parentElement;
            const pageNavContainer = horsesPageInfoSpan?.parentElement;
            const controlsContainer = document.getElementById('horses-pagination-controls');

            if (!horsesPageInfoSpan || !horsesPrevPageButton || !horsesNextPageButton || !controlsContainer || !pageNavContainer || !itemsPerPageSelectContainer) {
                console.warn("Pagination elements not found, skipping control render.");
                return;
            }

            // Always show the main container, even if there are no items
            controlsContainer.style.display = 'flex';

            // Update page info text
            if (totalItems === 0) {
                horsesPageInfoSpan.textContent = 'No horses found';
            } else {
                horsesPageInfoSpan.textContent = `Page ${horseTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }

            // Enable/disable buttons
            horsesPrevPageButton.disabled = horseTableCurrentPage <= 1;
            horsesNextPageButton.disabled = horseTableCurrentPage >= totalPages;

            // Always show the navigation controls
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers ---
        function handleHorsesItemsPerPageChange() {
            const newSize = parseInt(horsesItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                horseTableItemsPerPage = newSize;
                horseTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('horseTableItemsPerPage', horseTableItemsPerPage.toString()); // Save preference
                renderHorsesTable();
            }
        }

        function handleHorsesPrevPage() {
            // No need to recalculate totalPages for prev, just check current page > 1
            if (horseTableCurrentPage > 1) {
                horseTableCurrentPage--;
                renderHorsesTable();
            }
        }

        function handleHorsesNextPage() {
            // Use the helper function to get the length of the currently filtered list
            const filteredHorses = getFilteredRacingHorses();
            const totalItems = filteredHorses.length;
            const totalPages = Math.ceil(totalItems / horseTableItemsPerPage);

            if (horseTableCurrentPage < totalPages) {
                horseTableCurrentPage++;
                renderHorsesTable();
            }
        }

        // 3. Fix the renderRacesTable function to properly display horses
        function renderRacesTable() {
            console.log("Rendering races table with", races.length, "races");
            
            if (!racesTableBody) {
                console.error("Races table body element not found!");
                return;
            }
            
            racesTableBody.innerHTML = '';
            const sortedRaces = [...races].sort((a, b) => new Date(b.date) - new Date(a.date));

            // Pagination Calculation for Races
            const totalItems = sortedRaces.length;
            const totalPages = Math.ceil(totalItems / raceTableItemsPerPage);
            if (raceTableCurrentPage > totalPages) {
                raceTableCurrentPage = Math.max(totalPages, 1);
            }
            const startIndex = (raceTableCurrentPage - 1) * raceTableItemsPerPage;
            const endIndex = startIndex + raceTableItemsPerPage;
            const racesToShow = sortedRaces.slice(startIndex, endIndex);

            // Render the sliced rows
            racesToShow.forEach(race => {
                const horse = horses.find(h => h.id === race.horseId);
                const horseName = horse ? horse.name : 'Unknown Horse';
                
                console.log("Rendering race for horse:", horseName, "with ID:", race.horseId);
                
                const row = racesTableBody.insertRow();
                
                // Updated row structure to include horse name column
                row.innerHTML = `
                    <td>${race.raceDate ? new Date(race.raceDate).toLocaleDateString() : (race.date ? new Date(race.date).toLocaleDateString() : '-')}</td>
                    <td>${race.raceName || '-'}</td>
                    <td>${horseName}</td>
                    <td>${race.position || '-'}</td>
                    <td>${race.odds || '-'}</td>
                    <td>${race.finishTime ? race.finishTime.toFixed(3) : '-'}</td>
                    <td>${race.split1 !== null && race.split1 !== undefined ? race.split1 : '-'}</td>
                    <td>${race.split2 !== null && race.split2 !== undefined ? race.split2 : '-'}</td>
                    <td>${race.split3 !== null && race.split3 !== undefined ? race.split3 : '-'}</td>
                    <td>${race.split4 !== null && race.split4 !== undefined ? race.split4 : '-'}</td>
                    <td style="color: ${race.zedChange >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">${race.zedChange >= 0 ? '+' : ''}${Math.round(race.zedChange)}</td>
                    <td style="color: ${race.ratingChange > 0 ? 'var(--success-color)' : (race.ratingChange < 0 ? 'var(--error-color)' : 'inherit')};">${race.ratingChange > 0 ? '+' : ''}${race.ratingChange !== null ? race.ratingChange : '-'}</td>
                    <td>${race.cpuAugment !== 'None' ? 'C' : '-'}/${race.ramAugment !== 'None' ? 'R' : '-'}/${race.hydraulicAugment !== 'None' ? 'H' : '-'}</td>
                    <td class="actions">
                        <button class="action-button edit-button" onclick="editRace('${race.id}')" title="Edit Race">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-button delete-button" onclick="deleteRace('${race.id}')" title="Delete Race">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </td>
                `;
            });

            // Render Pagination Controls for Races
            renderRacePaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Races Table ---
        function renderRacePaginationControls(totalItems, totalPages) {
            const pageNavContainer = racesPageInfoSpan?.parentElement;
            const controlsContainer = document.getElementById('races-pagination-controls');

            if (!racesPageInfoSpan || !racesPrevPageButton || !racesNextPageButton || !controlsContainer || !pageNavContainer) {
                console.warn("Race pagination elements not found, skipping control render.");
                return;
            }

            controlsContainer.style.display = 'flex';

            if (totalItems === 0) {
                racesPageInfoSpan.textContent = 'No races found';
            } else {
                racesPageInfoSpan.textContent = `Page ${raceTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }

            racesPrevPageButton.disabled = raceTableCurrentPage <= 1;
            racesNextPageButton.disabled = raceTableCurrentPage >= totalPages;
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers for Races ---
        function handleRacesItemsPerPageChange() {
            const newSize = parseInt(racesItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                raceTableItemsPerPage = newSize;
                raceTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('raceTableItemsPerPage', raceTableItemsPerPage.toString()); // Save preference
                renderRacesTable();
            }
        }

        function handleRacesPrevPage() {
            if (raceTableCurrentPage > 1) {
                raceTableCurrentPage--;
                renderRacesTable();
            }
        }

        function handleRacesNextPage() {
            const totalItems = races.length; // Use full race list length
            const totalPages = Math.ceil(totalItems / raceTableItemsPerPage);
            if (raceTableCurrentPage < totalPages) {
                raceTableCurrentPage++;
                renderRacesTable();
            }
        }

        // --- Rendering for Retired Horses ---
        function renderBreedingHorsesTable() { // Renamed function
            breedingStableTableBody.innerHTML = ''; // Use distinct variable name
            const formatStars = (stars) => (stars !== null && stars !== undefined && stars !== '') ? Number(stars).toFixed(1) : '-';
            
            // Filter for breeding horses
            const breedingHorsesFiltered = horses.filter(h => h.status === 'breeding'); // Filter for 'breeding' status
            // TODO: Add sorting if needed later (e.g., by name)
            breedingHorsesFiltered.sort((a, b) => a.name.localeCompare(b.name)); // Sort by name ASC for now

            // Pagination Calculation for Breeding Horses
            const totalItems = breedingHorsesFiltered.length;
            const totalPages = Math.ceil(totalItems / breedingHorseTableItemsPerPage);
            if (breedingHorseTableCurrentPage > totalPages) {
                breedingHorseTableCurrentPage = Math.max(totalPages, 1);
            }
            const startIndex = (breedingHorseTableCurrentPage - 1) * breedingHorseTableItemsPerPage;
            const endIndex = startIndex + breedingHorseTableItemsPerPage;
            const horsesToShow = breedingHorsesFiltered.slice(startIndex, endIndex);

            // Render the sliced rows
            horsesToShow.forEach(horse => {
                const row = breedingStableTableBody.insertRow(); // Use distinct variable name
                const starsCombined = `O:${formatStars(horse.stars)} / Sp:${formatStars(horse.speedStars)} / Sr:${formatStars(horse.sprintStars)} / E:${formatStars(horse.enduranceStars)}`;

             row.innerHTML = `
                <td>${horse.name}</td>
                <td>${horse.bloodline}</td>
                <td>
                    <span class="swatch" style="background:${horse.color};"></span>
                    ${getColorLabel(horse.bloodline, horse.color)}
                </td>
                <td>${horse.gender}</td>
                <td>${starsCombined}</td>
                <td class="actions">
                    <button class="action-button edit-button" onclick="editHorse('${horse.id}')" title="Edit Breeding Horse">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="action-button" onclick="showHorseDetailsModal('${horse.id}')" title="View Details">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    <button class="action-button delete-button" onclick="deleteHorse('${horse.id}')" title="Delete Breeding Horse">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </td>
            `;
            });

            // Render Pagination Controls for Breeding Horses
            renderBreedingHorsePaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Breeding Horses Table ---
        function renderBreedingHorsePaginationControls(totalItems, totalPages) {
            const itemsPerPageSelectContainer = breedingHorsesItemsPerPageSelect?.parentElement;
            const pageNavContainer = breedingHorsesPageInfoSpan?.parentElement; 
            const controlsContainer = document.getElementById('breeding-horses-pagination-controls');

            if (!breedingHorsesPageInfoSpan || !breedingHorsesPrevPageButton || !breedingHorsesNextPageButton || !controlsContainer || !pageNavContainer || !itemsPerPageSelectContainer) {
                console.warn("Breeding horse pagination elements not fully found, skipping control render.");
                return;
            }

            controlsContainer.style.display = 'flex';

            if (totalItems === 0) {
                breedingHorsesPageInfoSpan.textContent = 'No breeding horses found';
            } else {
                breedingHorsesPageInfoSpan.textContent = `Page ${breedingHorseTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }

            breedingHorsesPrevPageButton.disabled = breedingHorseTableCurrentPage <= 1;
            breedingHorsesNextPageButton.disabled = breedingHorseTableCurrentPage >= totalPages;
            
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers for Breeding Horses ---
        function handleBreedingHorsesItemsPerPageChange() {
            const newSize = parseInt(breedingHorsesItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                breedingHorseTableItemsPerPage = newSize;
                breedingHorseTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('breedingHorseTableItemsPerPage', breedingHorseTableItemsPerPage.toString()); // Save preference
                renderBreedingHorsesTable();
            }
        }

        function handleBreedingHorsesPrevPage() {
            if (breedingHorseTableCurrentPage > 1) {
                breedingHorseTableCurrentPage--;
                renderBreedingHorsesTable();
            }
        }

        function handleBreedingHorsesNextPage() {
            // Recalculate totalPages based on current filters (just status='breeding')
            const totalItems = horses.filter(h => h.status === 'breeding').length;
            const totalPages = Math.ceil(totalItems / breedingHorseTableItemsPerPage);
            if (breedingHorseTableCurrentPage < totalPages) {
                breedingHorseTableCurrentPage++;
                renderBreedingHorsesTable();
            }
        }

         // --- Calculations ---
         function calculateHorseStats(horseId) {
             const horse = horses.find(h => h.id === horseId); // Find in unified list
             if (!horse) return { currentMmr: 'N/A', currentZedBalance: 0, wins: 0, places: 0, shows: 0, winRate: 0, totalRaces: 0, avgOdds: null }; // Added avgOdds default

             const relevantRaces = races.filter(r => r.horseId === horseId);
             // Ensure initial values are treated as numbers - crucial for retired horses which might lack these initially
             let currentMmr = Number(horse.initialMmRating !== undefined ? horse.initialMmRating : 1000); // Default if missing
             let currentZedBalance = Number(horse.initialZedBalance !== undefined ? horse.initialZedBalance : 0); // Default if missing
             let wins = 0;
             let places = 0; // 2nd
             let shows = 0; // 3rd
             let oddsSum = 0;
             let racesWithOdds = 0;

             relevantRaces.forEach(race => {
                 // Ensure changes are numbers
                 currentMmr += Number(race.ratingChange || 0); // Default to 0 if null/undefined
                 currentZedBalance += Number(race.zedChange || 0); // Default to 0 if null/undefined
                 const position = Number(race.position);
                 if (position === 1) wins++;
                 else if (position === 2) places++;
                 else if (position === 3) shows++;

                 // Sum odds if they exist and are valid numbers
                 if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                     oddsSum += Number(race.odds);
                     racesWithOdds++;
                 }
             });

             const totalRaces = relevantRaces.length;
             const winRate = totalRaces > 0 ? (wins / totalRaces) * 100 : 0;
             const avgOdds = racesWithOdds > 0 ? (oddsSum / racesWithOdds) : null; // Calculate avg odds

             // Calculate Net Profit and ROI
             const initialBalance = Number(horse.initialZedBalance !== undefined ? horse.initialZedBalance : 0);
             const netProfit = currentZedBalance - initialBalance;
             // Calculate ROI only if initial balance > 0 and netProfit is a valid number
             const roi = (initialBalance > 0 && !isNaN(netProfit)) ? (netProfit / initialBalance) * 100 : null;

             return {
                 currentMmr,
                 currentZedBalance,
                 wins,
                 places,
                 shows,
                 winRate,
                 totalRaces,
                 netProfit, // Add netProfit
                 roi, // Add roi
                 avgOdds // Add avgOdds
             };
         }

        function updateOverallStats() {
            let totalZedChange = 0;
            let totalStudFeesPaid = 0;
            let totalStudAuctionIncome = 0;
            let activeRacersBalance = 0;
            let totalSalesIncome = 0;
            let totalPurchaseExpenses = 0;
            
            // Calculate based on current balances vs initial balances for *active* racing horses
            horses.forEach(horse => {
                if (horse.status === 'racing') { 
                    const stats = calculateHorseStats(horse.id);
                    if (stats && stats.currentZedBalance !== undefined && horse.initialZedBalance !== undefined) {
                        totalZedChange += (stats.currentZedBalance - Number(horse.initialZedBalance));
                        activeRacersBalance += stats.currentZedBalance; // Add current balance of active racer
                    }
                }
            });

            // Calculate total stud fees from bredHorses records
            bredHorses.forEach(bred => {
                if (bred.studFeePaid && !isNaN(bred.studFeePaid)) {
                    totalStudFeesPaid += Number(bred.studFeePaid);
                }
            });
            
            // Calculate total stud auction income
            studAuctions.forEach(auction => {
                if (auction.commission && !isNaN(auction.commission)) {
                    totalStudAuctionIncome += Number(auction.commission);
                }
            });
            
            // Calculate total sales income and purchase expenses
            transactions.forEach(transaction => {
                if (transaction.type === 'sale' && transaction.amount && !isNaN(transaction.amount)) {
                    totalSalesIncome += Number(transaction.amount);
                } else if (transaction.type === 'purchase' && transaction.amount && !isNaN(transaction.amount)) {
                    totalPurchaseExpenses += Number(transaction.amount);
                }
            });

            // Calculate Net Earnings including transactions
            const netEarnings = totalRetirementEarnings + totalStudAuctionIncome - totalStudFeesPaid + 
                               totalSalesIncome - totalPurchaseExpenses;

            // Update Total Races
            totalRacesSpan.textContent = ` ${races.length}`;
            totalRacesSpan.style.color = 'inherit'; // Default color
            
            // Update $ZED Change for Active Racers
            totalZedChangeSpan.textContent = ` ${totalZedChange >= 0 ? '+' : ''}${totalZedChange.toFixed(2)}`;
            totalZedChangeSpan.style.color = totalZedChange >= 0 ? 'var(--success-color)' : 'var(--error-color)';
            
            // Update Current Balance of Active Racers
            const activeRacersBalanceSpan = document.getElementById('active-racers-balance');
            if (activeRacersBalanceSpan) {
                activeRacersBalanceSpan.textContent = ` ${activeRacersBalance.toFixed(2)}`;
                activeRacersBalanceSpan.style.color = activeRacersBalance >= 0 ? 'var(--success-color)' : 'var(--error-color)';
            }

            // Update Total Retirement Earnings
            totalRetirementEarningsSpan.textContent = ` ${totalRetirementEarnings.toFixed(2)}`;
            totalRetirementEarningsSpan.style.color = 'var(--success-color)';
            
            // Update Total Stud Auction Income
            const totalStudAuctionIncomeSpan = document.getElementById('total-stud-auction-income');
            if (totalStudAuctionIncomeSpan) {
                totalStudAuctionIncomeSpan.textContent = ` ${totalStudAuctionIncome.toFixed(2)}`;
                totalStudAuctionIncomeSpan.style.color = 'var(--success-color)';
            }
            
            // Update Total Stud Fees Paid
            totalStudFeesSpan.textContent = ` ${totalStudFeesPaid.toFixed(2)}`;
            totalStudFeesSpan.style.color = 'var(--error-color)';
            
            // Update Sales and Purchase figures
            const totalSalesIncomeSpan = document.getElementById('total-sales-income');
            if (totalSalesIncomeSpan) {
                totalSalesIncomeSpan.textContent = ` ${totalSalesIncome.toFixed(2)}`;
                totalSalesIncomeSpan.style.color = 'var(--success-color)';
            }
            
            const totalPurchaseExpensesSpan = document.getElementById('total-purchase-expenses');
            if (totalPurchaseExpensesSpan) {
                totalPurchaseExpensesSpan.textContent = ` ${totalPurchaseExpenses.toFixed(2)}`;
                totalPurchaseExpensesSpan.style.color = 'var(--error-color)';
            }
            
            // Update Net Earnings
            const netEarningsSpan = document.getElementById('net-earnings');
            if (netEarningsSpan) {
                netEarningsSpan.textContent = ` ${netEarnings >= 0 ? '+' : ''}${netEarnings.toFixed(2)}`;
                netEarningsSpan.style.color = netEarnings >= 0 ? 'var(--success-color)' : 'var(--error-color)';
            }
        }

        // --- Event Handlers ---
        function setupEventListeners() {
            addHorseForm.addEventListener('submit', handleAddHorse);
            addRaceForm.addEventListener('submit', handleAddRace);
            addBredHorseForm.addEventListener('submit', handleAddBredHorse);
            addBreedingHorseForm.addEventListener('submit', handleAddBreedingHorse); // Listener for new form
            // Listen for changes on parent dropdowns
            sireSelect.addEventListener('change', (e) => displayParentStats(e.target.value, 'sire'));
            damSelect.addEventListener('change', (e) => displayParentStats(e.target.value, 'dam'));

        // Add predict foal button listener - ADD THIS CODE HERE
        const predictButton = document.getElementById('predict-foal-btn');
        if (predictButton) {
            predictButton.addEventListener('click', function(event) {
                event.preventDefault();
                
                const sireSelect = document.getElementById('predict-sire');
                const damSelect = document.getElementById('predict-dam');
                const resultDiv = document.getElementById('foal-prediction-result');
                
                if (!sireSelect || !damSelect || !resultDiv) {
                    console.error("Missing required elements for foal prediction");
                    return;
                }
                
                const sireName = sireSelect.value;
                const damName = damSelect.value;
                
                if (!sireName || !damName) {
                    resultDiv.innerHTML = '<p style="color:var(--error-color)">Please select both sire and dam</p>';
                    return;
                }
                
                // Find the horses by name in the horses array
                const sire = horses.find(h => h.name === sireName && h.gender === 'Male');
                const dam = horses.find(h => h.name === damName && h.gender === 'Female');
                
                if (!sire || !dam) {
                    resultDiv.innerHTML = '<p style="color:var(--error-color)">Selected horses not found</p>';
                    return;
                }
                
                // Get the prediction
                const prediction = predictFoal(sire, dam);
                if (!prediction) {
                    resultDiv.innerHTML = '<p style="color:var(--error-color)">Could not generate prediction</p>';
                    return;
                }
                
                // Display detailed results with styling
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background-color: var(--section-bg); border-radius: 8px; margin-top: 10px;">
                        <h4 style="margin-top: 0; color: var(--accent-color);">Predicted Foal Attributes</h4>
                        <p><strong>Bloodline:</strong> ${prediction.bloodline}</p>
                        <p><strong>Gender:</strong> ${prediction.gender}</p>
                        <p><strong>Color:</strong> <span class="swatch" style="background-color:${prediction.color};"></span> ${getColorLabel(prediction.bloodline, prediction.color)}</p>
                        <p><strong>Overall Stars:</strong> ${prediction.overallStars}</p>
                        <p><strong>Speed Stars:</strong> ${prediction.speedStars || 'Unknown'}</p>
                        <p><strong>Sprint Stars:</strong> ${prediction.sprintStars || 'Unknown'}</p>
                        <p><strong>Endurance Stars:</strong> ${prediction.enduranceStars || 'Unknown'}</p>
                        <p style="font-size: 0.9em; color: var(--text-muted-color);">Note: Results are estimates and may vary.</p>
                    </div>
                `;
                
                // Add animation effect
                resultDiv.style.animation = "fadeIn 0.5s ease-in-out";
            });
        }    

            // Add event listener for External Sire Bloodline change
            document.getElementById('external-sire-bloodline').addEventListener('change', function() {
                populateColorOptionsFor('external-sire-bloodline', 'external-sire-color');
            });

            // Transactions form listener
            const addTransactionForm = document.getElementById('add-transaction-form');
            if (addTransactionForm) {
                addTransactionForm.addEventListener('submit', handleAddTransaction);
            }
              // Transactions table listener              
            // Transactions pagination listeners
            const transactionsItemsPerPageSelect = document.getElementById('transactions-items-per-page');
            const transactionsPrevPageButton = document.getElementById('transactions-prev-page');
            const transactionsNextPageButton = document.getElementById('transactions-next-page');
            
            if (transactionsItemsPerPageSelect) {
                transactionsItemsPerPageSelect.value = transactionTableItemsPerPage;
                transactionsItemsPerPageSelect.addEventListener('change', handleTransactionsItemsPerPageChange);
            }
            if (transactionsPrevPageButton) {
                transactionsPrevPageButton.addEventListener('click', handleTransactionsPrevPage);
            }
            if (transactionsNextPageButton) {
                transactionsNextPageButton.addEventListener('click', handleTransactionsNextPage);
            }

            // Stud Auction listeners
            if (addStudAuctionForm) {
                addStudAuctionForm.addEventListener('submit', handleAddStudAuction);
                // Auto-calculate between price and commission when either changes
                if (studAuctionPriceInput) {
                    studAuctionPriceInput.addEventListener('input', handleStudAuctionPriceChange);
                }
                if (studAuctionCommissionInput) {
                    studAuctionCommissionInput.addEventListener('input', handleStudAuctionCommissionChange);
                }
            }

            // Stud Auction pagination listeners
            const studAuctionItemsPerPageSelect = document.getElementById('stud-auction-items-per-page');
            const studAuctionPrevPageButton = document.getElementById('stud-auction-prev-page');
            const studAuctionNextPageButton = document.getElementById('stud-auction-next-page');
            
            if (studAuctionItemsPerPageSelect) {
                studAuctionItemsPerPageSelect.value = studAuctionTableItemsPerPage;
                studAuctionItemsPerPageSelect.addEventListener('change', handleStudAuctionItemsPerPageChange);
            }
            if (studAuctionPrevPageButton) {
                studAuctionPrevPageButton.addEventListener('click', handleStudAuctionPrevPage);
            }
            if (studAuctionNextPageButton) {
                studAuctionNextPageButton.addEventListener('click', handleStudAuctionNextPage);
            }

            // Tab switching listener
            tabButtonContainer.addEventListener('click', handleTabClick);

            // Augment management listener
            addAugmentForm.addEventListener('submit', handleAddAugment);
            
            // Sort listener for horses table
            document.querySelectorAll('#horses-table th[data-sort-key]').forEach(th => {
                th.addEventListener('click', handleSortClick);
            });

            // Listener for External Sire checkbox
            if (useExternalSireCheckbox) {
                useExternalSireCheckbox.addEventListener('change', toggleExternalSireFields);
            }

            // Listener for Export Button
            const exportButton = document.getElementById('export-data-button');
            if (exportButton) {
                exportButton.addEventListener('click', handleExportData);
            }

            // Add listener for analysis refresh button
            const refreshAnalysisButton = document.getElementById('augment-analysis-refresh');
            if (refreshAnalysisButton) {
                refreshAnalysisButton.addEventListener('click', function() {
                    // Explicitly check and set the min races value
                    const minRacesInput = document.getElementById('augment-analysis-min-races');
                    const bloodlineFilter = document.getElementById('augment-analysis-bloodline-filter');
                    
                    // Ensure the min races input has a valid value
                    if (minRacesInput && (!minRacesInput.value || isNaN(parseInt(minRacesInput.value)))) {
                        minRacesInput.value = "2"; // Default to 2 if invalid
                    }
                    
                    console.log("Refresh button clicked with settings - Min races:", 
                               minRacesInput ? minRacesInput.value : "unknown", 
                               "Bloodline:", bloodlineFilter ? bloodlineFilter.value : "unknown");
                    
                    // Force update all tables
                    renderBloodlineAnalysis();
                    renderIndividualAugmentAnalysis();
                    renderAugmentPairAnalysis();
                    renderTripleAugmentAnalysis();
                    
                    console.log("All analysis tables refreshed");
                });
            }
            
            // Add listeners for analysis filters
            const analysisBloodlineFilter = document.getElementById('augment-analysis-bloodline-filter');
            const analysisMinRaces = document.getElementById('augment-analysis-min-races');
            
            if (analysisBloodlineFilter) {
                analysisBloodlineFilter.addEventListener('change', function() {
                    console.log("Bloodline filter changed to:", analysisBloodlineFilter.value);
                    renderBloodlineAnalysis();
                    renderIndividualAugmentAnalysis();
                    renderAugmentPairAnalysis();
                    renderTripleAugmentAnalysis();
                });
            }
            
            if (analysisMinRaces) {
                // Remove any existing event listeners
                analysisMinRaces.removeEventListener('input', function() {});
                
                // Add change event which fires when input loses focus or enter is pressed
                analysisMinRaces.addEventListener('change', function() {
                    // Validate value
                    const minRaces = parseInt(this.value) || 2;
                    this.value = minRaces; // Update input with valid value
                    
                    console.log("Min races changed to:", minRaces);
                    renderBloodlineAnalysis();
                    renderIndividualAugmentAnalysis();
                    renderAugmentPairAnalysis();
                    renderTripleAugmentAnalysis();
                });
            }

            // Listeners for Imported Data
            const importButton = document.getElementById('import-data-button');
            const importFileInput = document.getElementById('import-file-input');
            if (importButton && importFileInput) {
                importButton.addEventListener('click', () => {
                    importFileInput.click(); // Trigger hidden file input
                });
                importFileInput.addEventListener('change', handleImportData);
            }

            // Listeners for Table Filter/Search
            if (horseFilterBloodline) {
                horseFilterBloodline.addEventListener('change', renderHorsesTable);
            }
            
            if (horseFilterGender) {
                horseFilterGender.addEventListener('change', renderHorsesTable);
            }
            
            // Star filters
            [horseFilterMinStars, horseFilterMaxStars, horseFilterMinSpeed, horseFilterMaxSpeed, 
             horseFilterMinSprint, horseFilterMaxSprint, horseFilterMinEndurance, 
             horseFilterMaxEndurance].forEach(input => {
                if (input) {
                    input.addEventListener('input', renderHorsesTable);
                }
            });
            
            // Listener for Augment Analysis Horse Filter
            if (augmentAnalysisHorseFilter) {
                augmentAnalysisHorseFilter.addEventListener('change', renderAugmentAnalysis);
            }

            // Listeners for Horses Table Pagination Controls
            if (horsesItemsPerPageSelect) {
                horsesItemsPerPageSelect.value = horseTableItemsPerPage;
                horsesItemsPerPageSelect.addEventListener('change', handleHorsesItemsPerPageChange);
            }
            if (horsesPrevPageButton) {
                horsesPrevPageButton.addEventListener('click', handleHorsesPrevPage);
            }
            if (horsesNextPageButton) {
                horsesNextPageButton.addEventListener('click', handleHorsesNextPage);
            }

            // Listeners for Breeding Horse Pagination Controls
            if (breedingHorsesItemsPerPageSelect) {
                breedingHorsesItemsPerPageSelect.value = breedingHorseTableItemsPerPage;
                breedingHorsesItemsPerPageSelect.addEventListener('change', handleBreedingHorsesItemsPerPageChange);
            }
            if (breedingHorsesPrevPageButton) {
                breedingHorsesPrevPageButton.addEventListener('click', handleBreedingHorsesPrevPage);
            }
            if (breedingHorsesNextPageButton) {
                breedingHorsesNextPageButton.addEventListener('click', handleBreedingHorsesNextPage);
            }
            
            // Listeners for Race Pagination Controls
            if (racesItemsPerPageSelect) {
                racesItemsPerPageSelect.value = raceTableItemsPerPage;
                racesItemsPerPageSelect.addEventListener('change', handleRacesItemsPerPageChange);
            }
            if (racesPrevPageButton) {
                racesPrevPageButton.addEventListener('click', handleRacesPrevPage);
            }
            if (racesNextPageButton) {
                racesNextPageButton.addEventListener('click', handleRacesNextPage);
            }
            
            // Bred Horse pagination controls
            if (bredHistoryItemsPerPageSelect) {
                bredHistoryItemsPerPageSelect.value = bredHistoryTableItemsPerPage;
                bredHistoryItemsPerPageSelect.addEventListener('change', handleBredHistoryItemsPerPageChange);
            }
            if (bredHistoryPrevPageButton) {
                bredHistoryPrevPageButton.addEventListener('click', handleBredHistoryPrevPage);
            }
            if (bredHistoryNextPageButton) {
                bredHistoryNextPageButton.addEventListener('click', handleBredHistoryNextPage);
            }

            // Manual Stud Fee Update listeners
            const updateStudFeeButton = document.getElementById('update-stud-fee-button');
            if (updateStudFeeButton) {
                updateStudFeeButton.addEventListener('click', handleManualStudFeeUpdate);
                populateManualStudFeeDropdown(); // Populate the dropdown
            }
        }

        function toggleExternalSireFields() {
            const isChecked = useExternalSireCheckbox.checked;
            externalSireFields.forEach(field => {
                field.style.display = isChecked ? 'block' : 'none';
            });
            // Disable internal sire dropdown if external is checked, enable otherwise
            sireSelect.disabled = isChecked;
            if (isChecked) {
                sireSelect.value = ''; // Clear internal selection if switching to external
                displayParentStats(null, 'sire'); // Clear stats display
                externalSireNameInput.required = true; // Make external name required
                externalSireBloodlineSelect.required = true; // Make external bloodline required
                document.getElementById('external-sire-color').required = true; // Make external color required
                
                // Populate color options if bloodline is already selected
                if (externalSireBloodlineSelect.value) {
                    populateColorOptionsFor('external-sire-bloodline', 'external-sire-color');
                }
            } else {
                externalSireNameInput.required = false;
                externalSireBloodlineSelect.required = false;
                document.getElementById('external-sire-color').required = false;
                sireSelect.required = true; // Ensure internal sire is required again
            }
        }

            function handleAddHorse(event) {
                event.preventDefault();
                console.log('[handleAddHorse] Started. currentlyEditingHorse:', currentlyEditingHorse);
                
                // Get form values
                const horseNameInput = document.getElementById('horse-name');
                const bloodlineSelect = document.getElementById('horse-bloodline');
                const colorSelect = document.getElementById('horse-color');
                const genderSelect = document.getElementById('horse-gender');
                const starsInput = document.getElementById('horse-stars');
                const zedBalanceInput = document.getElementById('horse-zed-balance');
                const mmRatingInput = document.getElementById('horse-mm-rating');
                const speedStarsInput = document.getElementById('horse-speed-stars');
                const sprintStarsInput = document.getElementById('horse-sprint-stars');
                const enduranceStarsInput = document.getElementById('horse-endurance-stars');

                const parseFloatOptional = (value) => value ? parseFloat(value) : null;

                // Prepare data object
                const horseData = {
                    name: horseNameInput.value.trim(),
                    bloodline: bloodlineSelect.value,
                    color: colorSelect.value,
                    gender: genderSelect.value,
                    stars: parseFloat(starsInput.value) || 0,
                    initialZedBalance: parseFloat(zedBalanceInput.value) || 0,
                    initialMmRating: parseInt(mmRatingInput.value) || 1000,
                    speedStars: parseFloatOptional(speedStarsInput.value),
                    sprintStars: parseFloatOptional(sprintStarsInput.value),
                    enduranceStars: parseFloatOptional(enduranceStarsInput.value),
                    status: 'racing' // Always racing in this form
                };

                // Validation
                if (!horseData.name) { alert("Horse Name is required."); return; }
                if (!horseData.bloodline) { alert("Please select a Bloodline."); return; }
                if (!horseData.gender) { alert("Please select a Gender."); return; }
                if (isNaN(horseData.stars) || horseData.stars <= 0) { alert("Please enter a valid number for Overall Stars."); return; }

                // Check if updating or adding
                if (currentlyEditingHorse && currentlyEditingHorse.id) {
                    // UPDATE - edit existing horse
                    const index = horses.findIndex(h => h.id === currentlyEditingHorse.id);
                    if (index !== -1) {
                        // Keep the ID and status, update other fields
                        horseData.id = currentlyEditingHorse.id;
                        horses[index] = { ...horses[index], ...horseData };
                        console.log("Racing horse updated:", horses[index]);
                    } else {
                        console.error("Horse not found for update:", currentlyEditingHorse.id);
                    }
                } else {
                    // ADD - create new horse
                    // Check for duplicates
                    if (horses.some(h => h.name.toLowerCase() === horseData.name.toLowerCase())) {
                        alert(`A horse named "${horseData.name}" already exists.`);
                        return;
                    }
                    
                    // Add ID and timestamp
                    horseData.id = `horse-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                    horses.push(horseData);
                    console.log("Racing horse added:", horseData);
                }

                // Save, update UI
                saveData();
                renderHorsesTable();
                updateHorseDropdown(); // Make sure dropdown updates
                updateParentDropdowns();
                populateAugmentAnalysisHorseFilter();

                // Reset form and editing state
                addHorseForm.reset();
                addHorseForm.querySelector('button[type="submit"]').textContent = 'Add Racing Horse';
                currentlyEditingHorse = null;
                
                // Update additional dropdowns
                updateStudAuctionSelect();
                updateFoalPredictorDropdowns();
            }

        // --- Add Breeding Horse Handler (Needs similar refactor) --- //
        function handleAddBreedingHorse(event) {
            event.preventDefault();
            console.log('[handleAddBreedingHorse] Started. currentlyEditingHorse:', currentlyEditingHorse); // Log at start of handleAddBreedingHorse
            
            const nameInput = document.getElementById('breeding-horse-name');
            const bloodlineSelect = document.getElementById('breeding-horse-bloodline');
            const colorSelect = document.getElementById('breeding-horse-color');
            const genderSelect = document.getElementById('breeding-horse-gender');
            const starsInput = document.getElementById('breeding-horse-stars');
            const speedStarsInput = document.getElementById('breeding-horse-speed-stars');
            const sprintStarsInput = document.getElementById('breeding-horse-sprint-stars');
            const enduranceStarsInput = document.getElementById('breeding-horse-endurance-stars');

            const parseFloatOptional = (value) => value ? parseFloat(value) : null;

            const breedingHorseData = {
                id: currentlyEditingHorse ? currentlyEditingHorse.id : null,
                name: nameInput.value.trim(),
                bloodline: bloodlineSelect.value,
                color: colorSelect.value,
                gender: genderSelect.value,
                stars: parseFloatOptional(starsInput.value),
                speedStars: parseFloatOptional(speedStarsInput.value),
                sprintStars: parseFloatOptional(sprintStarsInput.value),
                enduranceStars: parseFloatOptional(enduranceStarsInput.value),
                status: 'breeding' // This form always deals with breeding horses
            };

            // --- Validation --- //
            if (!breedingHorseData.name) { alert("Horse Name is required."); return; }
            if (!breedingHorseData.bloodline) { alert("Please select a Bloodline."); return; }
            if (!breedingHorseData.gender) { alert("Please select a Gender."); return; }
            if ((starsInput.value && isNaN(breedingHorseData.stars)) ||
                (speedStarsInput.value && isNaN(breedingHorseData.speedStars)) ||
                (sprintStarsInput.value && isNaN(breedingHorseData.sprintStars)) ||
                (enduranceStarsInput.value && isNaN(breedingHorseData.enduranceStars))) {
                alert("Please enter valid numbers for Stars, or leave them empty.");
                return;
            }

            // --- Check if Updating or Adding --- //
            if (currentlyEditingHorse && currentlyEditingHorse.status === 'breeding') {
                 // --- UPDATE --- //
                const index = horses.findIndex(h => h.id === currentlyEditingHorse.id);
                if (index !== -1) {
                     // Merge updates, keeping original ID and ensuring status remains 'breeding'
                    horses[index] = { ...horses[index], ...breedingHorseData, status: 'breeding' };
                    console.log("Breeding horse updated:", horses[index]);
                } else {
                    console.error("Could not find breeding horse to update:", currentlyEditingHorse.id);
                    // Reset state even if update failed
                    currentlyEditingHorse = null;
                    updateFoalPredictorDropdowns();
                    addBreedingHorseForm.querySelector('button[type="submit"]').textContent = 'Add Breeding Horse';
                    addBreedingHorseForm.reset();
                    return; // Stop execution
                }
            } else {
                 // --- ADD --- //
                 // Check for duplicate names only when adding
                 if (horses.some(h => h.name.toLowerCase() === breedingHorseData.name.toLowerCase())) {
                    alert(`A horse named "${breedingHorseData.name}" already exists.`);
                    return;
                 }
                 breedingHorseData.id = `horse-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                 horses.push(breedingHorseData);
                 console.log("Breeding horse added:", breedingHorseData);
            }

            // --- Post Add/Update Actions --- //
            saveData();
            renderBreedingHorsesTable();
            updateParentDropdowns();
            addBreedingHorseForm.reset();
            addBreedingHorseForm.querySelector('button[type="submit"]').textContent = 'Add Breeding Horse';
            currentlyEditingHorse = null;
        }
        
            function handleAddRace(event) {
                event.preventDefault();
                // Get elements
                const horseSelect = document.getElementById('race-horse');
                const positionInput = document.getElementById('race-position');
                const oddsInput = document.getElementById('race-odds');
                const timeInput = document.getElementById('race-finish-time');
                const zedChangeInput = document.getElementById('race-zed-change');
                const ratingChangeInput = document.getElementById('race-rating-change');
                const cpuSelect = document.getElementById('race-cpu-augment');
                const ramSelect = document.getElementById('race-ram-augment');
                const hydraulicSelect = document.getElementById('race-hydraulic-augment');
                const raceNameInput = document.getElementById('race-name');
                const raceDateInput = document.getElementById('race-date');
                const split1Input = document.getElementById('race-split-1');
                const split2Input = document.getElementById('race-split-2');
                const split3Input = document.getElementById('race-split-3');
                const split4Input = document.getElementById('race-split-4');

                // Prepare data object
                const raceData = {
                    horseId: horseSelect.value,
                    position: parseInt(positionInput.value),
                    odds: parseFloat(oddsInput.value),
                    finishTime: parseFloat(timeInput.value) || null,
                    zedChange: parseFloat(zedChangeInput.value),
                    ratingChange: ratingChangeInput.value ? parseInt(ratingChangeInput.value) : null,
                    cpuAugment: cpuSelect.value,
                    ramAugment: ramSelect.value,
                    hydraulicAugment: hydraulicSelect.value,
                    raceName: raceNameInput.value.trim(),
                    raceDate: raceDateInput.value || new Date().toISOString().split('T')[0],
                    split1: split1Input.value ? parseFloat(split1Input.value) : null,
                    split2: split2Input.value ? parseFloat(split2Input.value) : null,
                    split3: split3Input.value ? parseFloat(split3Input.value) : null,
                    split4: split4Input.value ? parseFloat(split4Input.value) : null,
                    date: new Date().toISOString()
                };

                // Validation
                if (!horseSelect.value) { alert("Please select a horse."); return; }
                if (isNaN(parseInt(positionInput.value)) || parseInt(positionInput.value) < 1) { alert("Please enter a valid finishing place (1 or higher)."); return; }
                if (isNaN(parseFloat(oddsInput.value)) || parseFloat(oddsInput.value) < 1) { alert("Please enter valid odds (1 or higher)."); return; }
                if (isNaN(parseFloat(zedChangeInput.value))) { alert("Please enter the $ZED Won/Lost."); return; }
                if (ratingChangeInput.value && isNaN(parseInt(ratingChangeInput.value))) { alert("Please enter a valid number for the Matchmaking Rating Change, or leave it empty."); return; }
                
                // Splits validation (optional, but must be positive if filled)
                for (let i = 1; i <= 4; i++) {
                    const splitVal = document.getElementById(`race-split-${i}`).value;
                    if (splitVal && (isNaN(parseFloat(splitVal)) || parseFloat(splitVal) < 0)) {
                        alert(`Please enter a valid positive number for Split ${i}, or leave it empty.`);
                        return;
                    }
                }

                if (!horses.some(h => h.id === raceData.horseId)) {
                    alert("Selected horse not found. Please add the horse first or refresh.");
                    return;
                }

                if (currentlyEditingRace) {
                    // Update existing race
                    const index = races.findIndex(r => r.id === currentlyEditingRace.id);
                    if (index !== -1) {
                        // Preserve the id and date from the original race
                        raceData.id = currentlyEditingRace.id;
                        raceData.date = currentlyEditingRace.date;
                        races[index] = raceData;
                        console.log("Race updated:", raceData);
                    }
                } else {
                    // Add new race
                    raceData.id = `race-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                    raceData.date = new Date().toISOString();
                    races.push(raceData);
                    console.log("Race added:", raceData);
                }

                saveData();
                renderRacesTable();
                renderHorsesTable(); // Re-render horses to update calculated stats
                updateOverallStats();
                renderAugmentAnalysis();
                
                // Reset form and editing state
                addRaceForm.reset();
                horseSelect.value = ""; // Reset dropdown selection
                const submitButton = addRaceForm.querySelector('button[type="submit"]');
                submitButton.textContent = 'Record Race';
                currentlyEditingRace = null;
            }

            // ...existing code...
            function handleAddBredHorse(event) {
                event.preventDefault();

                //  FIX: Define all input/select variables at the start
                const nameInput = document.getElementById('bred-name');
                const bloodlineSelect = document.getElementById('bred-bloodline');
                const colorSelect = document.getElementById('bred-color');
                const genderSelect = document.getElementById('bred-gender');
                const starsInput = document.getElementById('bred-overall-stars');
                const speedStarsInput = document.getElementById('bred-speed-stars');
                const sprintStarsInput = document.getElementById('bred-sprint-stars');
                const enduranceStarsInput = document.getElementById('bred-endurance-stars');
                const dateInput = document.getElementById('bred-date');

                // ...rest of your function unchanged...
            // ...existing code...

            const parseFloatOptional = (value) => value ? parseFloat(value) : null;

            // Initialize variables for both internal and external sire cases
            let sireId = null;
            let externalSireName = null;
            let externalSireBloodline = null;
            let externalSireColor = null;
            let externalSireOverallStars = null;
            let externalSireSpeedStars = null;
            let externalSireSprintStars = null;
            let externalSireEnduranceStars = null;

            // Check if using external sire
            const isExternalSire = useExternalSireCheckbox.checked;

            if (isExternalSire) {
                // External sire - get values from external sire fields
                externalSireName = document.getElementById('external-sire-name').value.trim();
                externalSireBloodline = document.getElementById('external-sire-bloodline').value;
                externalSireColor = document.getElementById('external-sire-color').value;
                externalSireOverallStars = parseFloatOptional(document.getElementById('external-sire-overall-stars').value);
                externalSireSpeedStars = parseFloatOptional(document.getElementById('external-sire-speed-stars').value);
                externalSireSprintStars = parseFloatOptional(document.getElementById('external-sire-sprint-stars').value);
                externalSireEnduranceStars = parseFloatOptional(document.getElementById('external-sire-endurance-stars').value);
            } else {
                // Internal sire - get ID from select
                sireId = sireSelect.value;
            }

            const newBredHorse = {
                id: `bred-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                name: nameInput.value.trim(),
                bloodline: bloodlineSelect.value,
                color: colorSelect.value,
                gender: genderSelect.value,
                sireId: sireId, // Will be null for external sire
                externalSireName: externalSireName,
                externalSireBloodline: externalSireBloodline,
                externalSireColor: externalSireColor,
                externalSireOverallStars: externalSireOverallStars,
                externalSireSpeedStars: externalSireSpeedStars,
                externalSireSprintStars: externalSireSprintStars,
                externalSireEnduranceStars: externalSireEnduranceStars,
                damId: damSelect.value,
                bredDate: dateInput.value || new Date().toISOString().split('T')[0], // Default to today
                studFeePaid: parseFloat(document.getElementById('bred-stud-fee').value) || 0,
                stars: parseFloatOptional(starsInput.value),
                speedStars: parseFloatOptional(speedStarsInput.value),
                sprintStars: parseFloatOptional(sprintStarsInput.value),
                enduranceStars: parseFloatOptional(enduranceStarsInput.value)
            };

            // Validation
            if (!newBredHorse.name) { alert("New Horse Name is required."); return; }
            if (!newBredHorse.bloodline) { alert("Please select a Bloodline for the new horse."); return; }
            if (!newBredHorse.gender) { alert("Please select a Gender for the new horse."); return; }
            if (!newBredHorse.color) { alert("Please select a Color for the new horse."); return; }
            
            // Validation specifically for sire
            if (isExternalSire) {
                if (!newBredHorse.externalSireName) { alert("External Sire Name is required."); return; }
                if (!newBredHorse.externalSireBloodline) { alert("Please select a Bloodline for the External Sire."); return; }
                if (!newBredHorse.externalSireColor) { alert("Please select a Color for the External Sire."); return; }
            } else {
                if (!newBredHorse.sireId) { alert("Please select the Sire (Father)."); return; }
            }
            
            if (!newBredHorse.damId) { alert("Please select the Dam (Mother)."); return; }
            if (isNaN(newBredHorse.studFeePaid)) { alert("Please enter a valid number for Stud Fee Paid (or 0)."); return; }

            // Check for duplicate names
            const allHorseNames = horses.map(h => h.name.toLowerCase());
            if (allHorseNames.includes(newBredHorse.name.toLowerCase())) {
                alert(`A horse named "${newBredHorse.name}" already exists in the racing or breeding stable. Please choose a unique name for the bred horse.`);
                return;
            }

            // Add to bred horses collection
            bredHorses.push(newBredHorse);

            // Add the bred horse to racing horses automatically
            const studFee = parseFloat(document.getElementById('bred-stud-fee').value) || 0;
            const initialBalance = studFee / 2; // Half of the stud fee
            
            const newRacingHorse = {
                id: newBredHorse.id,
                name: newBredHorse.name,
                bloodline: newBredHorse.bloodline,
                color: newBredHorse.color,
                gender: newBredHorse.gender,
                stars: newBredHorse.stars,
                speedStars: newBredHorse.speedStars,
                sprintStars: newBredHorse.sprintStars,
                enduranceStars: newBredHorse.enduranceStars,
                initialZedBalance: initialBalance,
                initialMmRating: 1000,
                status: 'racing',
                dateAcquired: new Date().toISOString().split('T')[0],
                notes: "Bred horse"
            };
            
            horses.push(newRacingHorse);

            // Save changes to localStorage
            saveData();
            
            // Update UI
            renderBredHorsesTable();
            renderHorsesTable();
            updateOverallStats();
            updateHorseDropdown();
            updateParentDropdowns();
            populateAugmentAnalysisHorseFilter();
            
            // Reset form
            addBredHorseForm.reset();
            sireStatsDiv.innerHTML = '';
            damStatsDiv.innerHTML = '';
            
            // Also reset external sire fields display
            externalSireFields.forEach(field => {
                field.style.display = 'none';
            });
            useExternalSireCheckbox.checked = false;
            
            // Inform user the horse was added to racing horses
            alert(`Horse "${newBredHorse.name}" has been recorded and added to your Racing Horses list!`);
        }
         function deleteHorse(horseId) {
            // Find the horse to get its status and name for confirmation
            const horseIndex = horses.findIndex(horse => horse.id === horseId);
            if (horseIndex === -1) {
                console.error("Horse not found for deletion:", horseId);
                return;
            }
            const horseToDelete = horses[horseIndex];
            const originalStatus = horseToDelete.status; // Store status before potential modification

            if (confirm(`Are you sure you want to delete ${horseToDelete.name}? This action cannot be undone.`)) {
                // Filter the IN-MEMORY horses array
                horses = horses.filter(horse => horse.id !== horseId);
                saveData(); // Save the updated in-memory array

                // Re-render the correct table based on the original status
                if (originalStatus === 'racing') {
                    renderHorsesTable();
                } else if (originalStatus === 'breeding') {
                    renderBreedingHorsesTable();
                }
                // Update dropdowns that might contain the deleted horse
             updateHorseDropdown();
                updateParentDropdowns();
                populateAugmentAnalysisHorseFilter(); // Refresh the horse filter dropdown
                updateOverallStats(); // Stats might be affected if it was a racing horse
                renderAugmentAnalysis(); // Re-render analysis
                console.log(`Horse ${horseToDelete.name} (ID: ${horseId}) deleted.`);
                // ...inside deleteHorse, after renderAugmentAnalysis();
                updateStudAuctionSelect();
                updateFoalPredictorDropdowns();
            }
         }

         function deleteRace(raceId) {
            const raceIndex = races.findIndex(r => r.id === raceId);
            if (raceIndex === -1) return; // Should not happen

             if (!confirm(`Are you sure you want to delete this race record from ${new Date(races[raceIndex].date).toLocaleString()}?`)) {
                 return;
             }

             races.splice(raceIndex, 1); // Use splice for efficiency if array gets large

             saveData();
             renderRacesTable();
             renderHorsesTable(); // Stats might change
             renderAugmentAnalysis();
             updateOverallStats();
              console.log("Race deleted:", raceId);
         }

        function deleteBredHorse(recordId) {
             const recordIndex = bredHorses.findIndex(r => r.id === recordId);
             if (recordIndex === -1) return;

             if (!confirm(`Are you sure you want to delete this bred horse record for "${bredHorses[recordIndex].name}"? This only removes the breeding record.`)) {
                  return;
              }

             bredHorses.splice(recordIndex, 1);

             saveData();
             renderBredHorsesTable();
             console.log("Bred horse record deleted:", recordId);
        }

        // --- Parent Stat Display ---
        function displayParentStats(horseId, parentType) {
            const displayDiv = parentType === 'sire' ? sireStatsDiv : damStatsDiv;
            if (!horseId) {
                displayDiv.innerHTML = ''; // Clear if no horse selected
                return;
            }

            const allHorses = [...horses]; // Use unified list
            const parent = allHorses.find(h => h.id === horseId);

            if (parent) {
                const format = (val) => (val !== null && val !== undefined && val !== '') ? Number(val).toFixed(1) : '-';
                displayDiv.innerHTML = `
                    <strong>${parent.bloodline}</strong> | 
                    Overall: ${format(parent.stars)} | 
                    Spd: ${format(parent.speedStars)} | 
                    Spr: ${format(parent.sprintStars)} | 
                    End: ${format(parent.enduranceStars)}
                `;
            } else {
                displayDiv.innerHTML = ''; // Clear if horse not found (shouldn't happen)
            }
        }

        // --- Augment Performance Analysis Rendering ---
        function renderAugmentAnalysis() {
           const container = document.getElementById('augment-analysis-content');
           container.innerHTML = ''; // Clear previous analysis

           if (horses.length === 0) {
               container.innerHTML = '<p>No racing horses available for analysis.</p>';
               return;
           }
           
           // Get the selected horse ID from the filter
           const selectedHorseId = augmentAnalysisHorseFilter ? augmentAnalysisHorseFilter.value : '';
           
           // Filter horses based on selection (or show all if none selected)
           const horsesToAnalyze = selectedHorseId 
               ? horses.filter(h => h.id === selectedHorseId && h.status === 'racing')
               : horses.filter(h => h.status === 'racing');

           horsesToAnalyze.forEach(horse => {
               const horseRaces = races.filter(r => r.horseId === horse.id);

               if (horseRaces.length === 0) {
                   // Optionally skip horses with no races, or show a message
                   // container.innerHTML += `<h3>${horse.name}</h3><p>No races recorded yet.</p>`;
                   return; // Skip for now if no races
               }

               // Sort races by date (oldest first) to properly track MMR progression
               const sortedRaces = [...horseRaces].sort((a, b) => new Date(a.date) - new Date(b.date));
               
               // Group races by augment combination, tracking starting MMR
               const analysis = {};
               let currentMMR = horse.initialMmRating || 1000; // Start with initial MMR
               
               sortedRaces.forEach(race => {
                   const comboKey = `${race.cpuAugment || 'None'} / ${race.ramAugment || 'None'} / ${race.hydraulicAugment || 'None'}`;
                   
                   // Record the starting MMR for this race
                   const startingMMR = currentMMR;
                   
                   // Update MMR for next race
                   if (race.ratingChange !== null && race.ratingChange !== undefined) {
                       currentMMR += Number(race.ratingChange);
                   }
                   
                   if (!analysis[comboKey]) {
                       analysis[comboKey] = {
                           races: 0,
                           wins: 0,
                           placeSum: 0,
                           oddsSum: 0,
                           racesWithOdds: 0,
                           mmrStartSum: 0 // New field to track sum of starting MMRs
                       };
                   }
                   
                   analysis[comboKey].races++;
                   analysis[comboKey].mmrStartSum += startingMMR; // Add starting MMR to sum
                   
                   if (race.position === 1) analysis[comboKey].wins++;
                   analysis[comboKey].placeSum += race.position;
                   
                   // Odds might be null/undefined if not entered, handle carefully
                   if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                       analysis[comboKey].oddsSum += Number(race.odds);
                       analysis[comboKey].racesWithOdds++;
                   }
               });

               // Build HTML for this horse
                const horseDiv = document.createElement('div');
                horseDiv.className = 'horse-analysis'; // Add class for potential future styling
                horseDiv.innerHTML = `<h3>${horse.name}</h3>`;

                const table = document.createElement('table');
                table.style.maxWidth = "900px"; // Make table wider
                table.innerHTML = `
                   <thead>
                       <tr>
                           <th style="min-width: 240px;">Augment Combo (C/R/H)</th>
                           <th>Races</th>
                           <th>Win %</th>
                           <th>Avg Place</th>
                           <th>Avg Odds</th>
                           <th style="width: 80px;">Avg Start MMR</th>
                       </tr>
                   </thead>
                   <tbody>
                   </tbody>
               `;
               const tbody = table.querySelector('tbody');

               Object.entries(analysis).sort(([, statsA], [, statsB]) => {
                     const oddsA = statsA.racesWithOdds > 0 ? statsA.oddsSum / statsA.racesWithOdds : Number.MAX_VALUE;
                     const oddsB = statsB.racesWithOdds > 0 ? statsB.oddsSum / statsB.racesWithOdds : Number.MAX_VALUE;
                     return oddsA - oddsB; // Sort by ascending odds (lower first)
                 }).forEach(([comboKey, stats]) => {
                     const winRate = stats.races > 0 ? (stats.wins / stats.races) * 100 : 0;
                     const avgPlace = stats.races > 0 ? stats.placeSum / stats.races : 0;
                     const avgOdds = stats.racesWithOdds > 0 ? stats.oddsSum / stats.racesWithOdds : 0;
                     const avgStartMMR = stats.races > 0 ? Math.round(stats.mmrStartSum / stats.races) : 'N/A';

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${comboKey}</td>
                        <td>${stats.races}</td>
                        <td>${winRate.toFixed(1)}%</td>
                        <td>${avgPlace.toFixed(2)}</td>
                        <td>${avgOdds > 0 ? avgOdds.toFixed(1) : 'N/A'}</td>
                        <td>${avgStartMMR}</td>
                    `;
                });

                horseDiv.appendChild(table);
                container.appendChild(horseDiv);

           });
           
           // Add Advanced Augment Analysis by Bloodline
           renderAdvancedAugmentAnalysis(container);
        }
        
        // New function for enhanced augment analytics
        function renderAdvancedAugmentAnalysis(container) {
            // Create a section for advanced analytics
            const advancedSection = document.createElement('div');
            advancedSection.className = 'advanced-augment-analysis';
            advancedSection.innerHTML = '<h2>Advanced Augment Analytics</h2>';
            
            // Get all racing horses with races
            const racingHorses = horses.filter(h => h.status === 'racing');
            if (racingHorses.length === 0) {
                advancedSection.innerHTML += '<p>No racing horses available for analysis.</p>';
                container.appendChild(advancedSection);
                return;
            }
            
            // Collect all races for racing horses
            const allRaces = [];
            racingHorses.forEach(horse => {
                const horseRaces = races.filter(r => r.horseId === horse.id);
                // Add horse bloodline to each race for analysis
                horseRaces.forEach(race => {
                    allRaces.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (allRaces.length === 0) {
                advancedSection.innerHTML += '<p>No race data available for analysis.</p>';
                container.appendChild(advancedSection);
                return;
            }
            
            // Create bloodline performance section
            const bloodlineSection = document.createElement('div');
            bloodlineSection.innerHTML = '<h3>Augment Performance by Bloodline</h3>';
            
            // Group races by bloodline
            const bloodlineGroups = {};
            const bloodlines = ['Nakamoto', 'Szabo', 'Finney', 'Buterin'];
            
            bloodlines.forEach(bloodline => {
                bloodlineGroups[bloodline] = allRaces.filter(race => race.bloodline === bloodline);
            });
            
            // Create a table for bloodline performance
            const bloodlineTable = document.createElement('table');
            bloodlineTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Bloodline</th>
                        <th>Color</th>
                        <th>Races</th>
                        <th>Win %</th>
                        <th>Avg Place</th>
                        <th>Avg Odds</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const bloodlineTbody = bloodlineTable.querySelector('tbody');
            
            bloodlines.forEach(bloodline => {
                const bloodlineRaces = bloodlineGroups[bloodline];
                if (bloodlineRaces.length === 0) return;
                
                const wins = bloodlineRaces.filter(r => r.position === 1).length;
                const winRate = (wins / bloodlineRaces.length) * 100;
                const placeSum = bloodlineRaces.reduce((sum, race) => sum + race.position, 0);
                const avgPlace = placeSum / bloodlineRaces.length;
                
                // Calculate average odds (excluding races with missing odds)
                const racesWithOdds = bloodlineRaces.filter(r => r.odds !== null && r.odds !== undefined && !isNaN(r.odds));
                const oddsSum = racesWithOdds.reduce((sum, race) => sum + Number(race.odds), 0);
                const avgOdds = racesWithOdds.length > 0 ? oddsSum / racesWithOdds.length : 0;
                
                const row = bloodlineTbody.insertRow();
                row.innerHTML = `
                    <td>${bloodline}</td>
                    <td>${bloodlineRaces.length}</td>
                    <td>${winRate.toFixed(1)}%</td>
                    <td>${avgPlace.toFixed(2)}</td>
                    <td>${avgOdds !== Number.MAX_VALUE ? avgOdds.toFixed(1) : 'N/A'}</td>
                `;
            });
            
            bloodlineSection.appendChild(bloodlineTable);
            advancedSection.appendChild(bloodlineSection);
            
            // Create individual augment analysis section
            const individualAugmentSection = document.createElement('div');
            individualAugmentSection.innerHTML = '<h3>Individual Augment Performance</h3>';
            
            // Collect data on individual augments
            const augmentStats = {};
            
            allRaces.forEach(race => {
                // Process CPU augment
                if (race.cpuAugment) {
                    if (!augmentStats[race.cpuAugment]) {
                        augmentStats[race.cpuAugment] = { type: 'CPU', races: 0, wins: 0, placeSum: 0, oddsValues: [] };
                    }
                    augmentStats[race.cpuAugment].races++;
                    if (race.position === 1) augmentStats[race.cpuAugment].wins++;
                    augmentStats[race.cpuAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.cpuAugment].oddsValues.push(Number(race.odds));
                    }
                }
                
                // Process RAM augment
                if (race.ramAugment) {
                    if (!augmentStats[race.ramAugment]) {
                        augmentStats[race.ramAugment] = { type: 'RAM', races: 0, wins: 0, placeSum: 0, oddsValues: [] };
                    }
                    augmentStats[race.ramAugment].races++;
                    if (race.position === 1) augmentStats[race.ramAugment].wins++;
                    augmentStats[race.ramAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.ramAugment].oddsValues.push(Number(race.odds));
                    }
                }
                
                // Process Hydraulic augment
                if (race.hydraulicAugment) {
                    if (!augmentStats[race.hydraulicAugment]) {
                        augmentStats[race.hydraulicAugment] = { type: 'Hydraulic', races: 0, wins: 0, placeSum: 0, oddsValues: [] };
                    }
                    augmentStats[race.hydraulicAugment].races++;
                    if (race.position === 1) augmentStats[race.hydraulicAugment].wins++;
                    augmentStats[race.hydraulicAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.hydraulicAugment].oddsValues.push(Number(race.odds));
                    }
                }
            });
            
            // Create a table for individual augment performance
            const augmentTable = document.createElement('table');
            augmentTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Augment</th>
                        <th>Type</th>
                        <th>Races</th>
                        <th>Win %</th>
                        <th>Avg Place</th>
                        <th>Avg Odds</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const augmentTbody = augmentTable.querySelector('tbody');
            
            // Sort augments by win rate (descending)
            Object.entries(augmentStats)
                .sort(([, statsA], [, statsB]) => {
                    const oddsA = statsA.oddsValues.length > 0 
                        ? statsA.oddsValues.reduce((sum, odds) => sum + odds, 0) / statsA.oddsValues.length 
                        : Number.MAX_VALUE;
                    const oddsB = statsB.oddsValues.length > 0 
                        ? statsB.oddsValues.reduce((sum, odds) => sum + odds, 0) / statsB.oddsValues.length 
                        : Number.MAX_VALUE;
                    return oddsA - oddsB; // Sort by ascending odds (lower first)
                })
                .forEach(([augmentName, stats]) => {
                    if (stats.races < 3) return; // Skip augments with too few races
                    
                    const winRate = stats.races > 0 ? (stats.wins / stats.races) * 100 : 0;
                    const avgPlace = stats.races > 0 ? stats.placeSum / stats.races : 0;
                    const avgOdds = stats.oddsValues.length > 0 
                        ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                        : 0;
                    
                    const row = augmentTbody.insertRow();
                    row.innerHTML = `
                        <td>${augmentName}</td>
                        <td>${stats.type}</td>
                        <td>${stats.races}</td>
                        <td>${winRate.toFixed(1)}%</td>
                        <td>${avgPlace.toFixed(2)}</td>
                        <td>${avgOdds > 0 ? avgOdds.toFixed(1) : 'N/A'}</td>
                    `;
                });
            
            individualAugmentSection.appendChild(augmentTable);
            advancedSection.appendChild(individualAugmentSection);
            
            // Create augment combo analysis section
            const comboSection = document.createElement('div');
            comboSection.innerHTML = '<h3>Top Augment Combinations</h3>';
            
            // Group by augment combinations
            const combos = {};
            
            allRaces.forEach(race => {
                const comboKey = `${race.cpuAugment || 'None'} / ${race.ramAugment || 'None'} / ${race.hydraulicAugment || 'None'}`;
                
                if (!combos[comboKey]) {
                    combos[comboKey] = { 
                        races: 0, 
                        wins: 0, 
                        placeSum: 0, 
                        oddsValues: [],
                        byBloodline: {
                            'Nakamoto': { races: 0, wins: 0, placeSum: 0, oddsValues: [] },
                            'Szabo': { races: 0, wins: 0, placeSum: 0, oddsValues: [] },
                            'Finney': { races: 0, wins: 0, placeSum: 0, oddsValues: [] },
                            'Buterin': { races: 0, wins: 0, placeSum: 0, oddsValues: [] }
                        }
                    };
                }
                
                combos[comboKey].races++;
                if (race.position === 1) combos[comboKey].wins++;
                combos[comboKey].placeSum += race.position;
                
                if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                    combos[comboKey].oddsValues.push(Number(race.odds));
                }
                
                // Also track by bloodline
                const bloodlineStats = combos[comboKey].byBloodline[race.bloodline];
                bloodlineStats.races++;
                if (race.position === 1) bloodlineStats.wins++;
                bloodlineStats.placeSum += race.position;
                
                if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                    bloodlineStats.oddsValues.push(Number(race.odds));
                }
            });
            
            // Create a table for top combinations
            const comboTable = document.createElement('table');
            comboTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Combination (C/R/H)</th>
                        <th>Races</th>
                        <th>Win %</th>
                        <th>Avg Place</th>
                        <th>Avg Odds</th>
                        <th>Best Bloodline</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const comboTbody = comboTable.querySelector('tbody');
            
            // Get the top 10 combos by average odds (ascending)
            Object.entries(combos)
                .filter(([, stats]) => stats.races >= 5) // Only show combos with at least 5 races
                .sort(([, statsA], [, statsB]) => {
                    const oddsA = statsA.oddsValues.length > 0 
                        ? statsA.oddsValues.reduce((sum, odds) => sum + odds, 0) / statsA.oddsValues.length 
                        : Number.MAX_VALUE;
                    const oddsB = statsB.oddsValues.length > 0 
                        ? statsB.oddsValues.reduce((sum, odds) => sum + odds, 0) / statsB.oddsValues.length 
                        : Number.MAX_VALUE;
                    return oddsA - oddsB; // Sort by ascending odds (lower first)
                })
                .slice(0, 10) // Take top 10
                .forEach(([comboKey, stats]) => {
                    const winRate = stats.races > 0 ? (stats.wins / stats.races) * 100 : 0;
                    const avgPlace = stats.races > 0 ? stats.placeSum / stats.races : 0;
                    const avgOdds = stats.oddsValues.length > 0 
                        ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                        : 0;
                    
                    // Find best bloodline for this combo
                    let bestBloodline = 'N/A';
                    let bestWinRate = 0;
                    
                    Object.entries(stats.byBloodline).forEach(([bloodline, bloodlineStats]) => {
                        if (bloodlineStats.races < 3) return; // Require at least 3 races
                        
                        const winRate = bloodlineStats.races > 0 ? (bloodlineStats.wins / bloodlineStats.races) * 100 : 0;
                        if (winRate > bestWinRate) {
                            bestWinRate = winRate;
                            bestBloodline = `${bloodline} (${winRate.toFixed(1)}%)`;
                        }
                    });
                    
                    const row = comboTbody.insertRow();
                    row.innerHTML = `
                        <td>${comboKey}</td>
                        <td>${stats.races}</td>
                        <td>${winRate.toFixed(1)}%</td>
                        <td>${avgPlace.toFixed(2)}</td>
                        <td>${avgOdds !== Number.MAX_VALUE ? avgOdds.toFixed(1) : 'N/A'}</td>
                        <td>${bestBloodline}</td>
                    `;
                });
            
            comboSection.appendChild(comboTable);
            advancedSection.appendChild(comboSection);
            
            // Add some styling for the advanced analytics section
            const style = document.createElement('style');
            style.textContent = `
                .advanced-augment-analysis {
                    margin-top: 40px;
                    border-top: 1px solid var(--border-color);
                    padding-top: 20px;
                }
                .advanced-augment-analysis h2 {
                    color: var(--accent-color);
                    margin-bottom: 20px;
                }
                .advanced-augment-analysis h3 {
                    margin-top: 25px;
                    margin-bottom: 10px;
                }
            `;
            
            document.head.appendChild(style);
            container.appendChild(advancedSection);
        }

        // --- Tab Handling --- //
        function initializeTabs() {
             const lastActiveTab = localStorage.getItem('zedTrackerActiveTab') || 'racing'; // Default to racing
             activateTab(lastActiveTab);
        }

        function handleTabClick(event) {
             if (event.target.classList.contains('tab-button')) {
                 const tabId = event.target.dataset.tab;
                 activateTab(tabId);
                 localStorage.setItem('zedTrackerActiveTab', tabId); // Save active tab
                 
                 // Render analysis tables if Analysis tab is selected
                 if (tabId === 'analysis') {
                     renderBloodlineAnalysis();
                     renderIndividualAugmentAnalysis();
                     renderAugmentPairAnalysis();
                     renderTripleAugmentAnalysis();
                 }
             }
        }

                // Fixed activateTab function
        function activateTab(tabId) {
          console.log('Activating tab:', tabId);
          
          // Get all tab buttons and content divs
          const tabButtons = document.querySelectorAll('.tab-button');
          const tabContents = document.querySelectorAll('.tab-content');
          
          // Remove active class from all buttons and content divs
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Add active class to selected button and content div
          const selectedButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
          const selectedContent = document.getElementById(`tab-content-${tabId}`);
          
          if (selectedButton) selectedButton.classList.add('active');
          if (selectedContent) {
            selectedContent.classList.add('active');
            console.log(`Activated tab content: tab-content-${tabId}`);
          } else {
            console.error(`Tab content not found for: ${tabId}`);
          }
          
          // Store active tab in localStorage
          localStorage.setItem('zedTrackerActiveTab', tabId);
          
          // Render analysis tables if Analysis tab is activated
          if (tabId === 'analysis') {
              renderBloodlineAnalysis();
              renderIndividualAugmentAnalysis();
              renderAugmentPairAnalysis();
              renderTripleAugmentAnalysis();
          }
        }
        
        // --- Modal Handling Functions ---
        // Note: Modal element variables are now accessed from the global scope
        function showHorseDetailsModal(horseId) {
            const horse = horses.find(h => h.id === horseId);
            if (!horse) {
                console.error("Horse not found for details modal:", horseId);
                return;
            }

            modalTitle.textContent = horse.name;

            // --- Calculate Basic Racing Stats ---
            const horseRaces = races.filter(r => r.horseId === horse.id);
            let wins = 0;
            let places = 0;
            let shows = 0;
            horseRaces.forEach(race => {
                const position = Number(race.position);
                if (position === 1) wins++;
                else if (position === 2) places++;
                else if (position === 3) shows++;
            });
            const totalRaces = horseRaces.length;
            const winRate = totalRaces > 0 ? (wins / totalRaces) * 100 : 0;

            modalStatsContent.innerHTML = `
                <p><strong>Bloodline:</strong> ${horse.bloodline}</p>
                <p><strong>Gender:</strong> ${horse.gender}</p>
                <p><strong>Status:</strong> ${horse.status}</p>
                <hr style="border-color: var(--border-color); margin: 1em 0;">
                <p><strong>Total Races:</strong> ${totalRaces}</p>
                <p><strong>Record (W-P-S):</strong> ${wins}-${places}-${shows}</p>
                <p><strong>Win Rate:</strong> ${winRate.toFixed(1)}%</p>
            `;

            // --- Calculate Augment Analysis ---
            modalAnalysisContent.innerHTML = ''; // Clear previous
            if (horseRaces.length > 0) {
                const analysis = {};
                horseRaces.forEach(race => {
                    const comboKey = `${race.cpuAugment || 'None'} / ${race.ramAugment || 'None'} / ${race.hydraulicAugment || 'None'}`;
                    if (!analysis[comboKey]) {
                        analysis[comboKey] = { races: 0, wins: 0, placeSum: 0, oddsSum: 0, racesWithOdds: 0 };
                    }
                    analysis[comboKey].races++;
                    if (race.position === 1) analysis[comboKey].wins++;
                    analysis[comboKey].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                         analysis[comboKey].oddsSum += Number(race.odds);
                         analysis[comboKey].racesWithOdds++; // Increment only if odds exist
                    }
                });

                 const table = document.createElement('table');
                 table.style.maxWidth = "900px"; // Make table wider
                 table.innerHTML = `
                    <thead>
                        <tr>
                            <th style="min-width: 240px;">Augment Combo (C/R/H)</th>
                            <th>Races</th>
                            <th>Win %</th>
                            <th>Avg Place</th>
                            <th>Avg Odds</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                 Object.entries(analysis).sort(([, statsA], [, statsB]) => {
                     const oddsA = statsA.racesWithOdds > 0 ? statsA.oddsSum / statsA.racesWithOdds : Number.MAX_VALUE;
                     const oddsB = statsB.racesWithOdds > 0 ? statsB.oddsSum / statsB.racesWithOdds : Number.MAX_VALUE;
                     return oddsA - oddsB; // Sort by ascending odds (lower first)
                 }).forEach(([comboKey, stats]) => {
                     const winRate = stats.races > 0 ? (stats.wins / stats.races) * 100 : 0;
                     const avgPlace = stats.races > 0 ? stats.placeSum / stats.races : 0;
                     const avgOdds = stats.racesWithOdds > 0 ? stats.oddsSum / stats.racesWithOdds : 0;

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${comboKey}</td>
                        <td>${stats.races}</td>
                        <td>${winRate.toFixed(1)}%</td>
                        <td>${avgPlace.toFixed(2)}</td>
                        <td>${avgOdds > 0 ? avgOdds.toFixed(1) : 'N/A'}</td>
                    `;
                });
                modalAnalysisContent.appendChild(table);
            } else {
                modalAnalysisContent.innerHTML = '<p>No race history found for augment analysis.</p>';
            }

            modal.style.display = "block";
        }

        function hideHorseDetailsModal() {
            // Access global modal variable
            if (modal) modal.style.display = "none";
            // Optional: Clear content on close
            if (modalTitle) modalTitle.textContent = '';
            if (modalStatsContent) modalStatsContent.innerHTML = '';
            if (modalAnalysisContent) modalAnalysisContent.innerHTML = '';
        }
        
        function renderBloodlineAnalysis() {
            const tbody = document.getElementById('bloodline-analysis-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get all races for active racing horses with bloodline information
            const racesWithBloodline = [];
            horses.filter(h => h.status === 'racing').forEach(horse => {
                races.filter(r => r.horseId === horse.id).forEach(race => {
                    racesWithBloodline.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (racesWithBloodline.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="6">No race data available</td>';
                return;
            }
            
            // Group by bloodline
            const bloodlineData = {};
            const bloodlines = ['Nakamoto', 'Szabo', 'Finney', 'Buterin'];
            
            bloodlines.forEach(bloodline => {
                const bloodlineRaces = racesWithBloodline.filter(race => race.bloodline === bloodline);
                
                if (bloodlineRaces.length === 0) return;
                
                const wins = bloodlineRaces.filter(r => r.position === 1).length;
                const totalRaces = bloodlineRaces.length;
                const winRate = (wins / totalRaces) * 100;
                
                const placesSum = bloodlineRaces.reduce((sum, race) => sum + race.position, 0);
                const avgPlace = placesSum / totalRaces;
                
                // Calculate average odds (excluding races with missing odds)
                const racesWithOdds = bloodlineRaces.filter(r => r.odds !== null && r.odds !== undefined && !isNaN(r.odds));
                const oddsSum = racesWithOdds.reduce((sum, race) => sum + parseFloat(race.odds), 0);
                const avgOdds = racesWithOdds.length > 0 ? oddsSum / racesWithOdds.length : 0;
                
                // Calculate ROI
                const zedChange = bloodlineRaces.reduce((sum, race) => sum + (parseFloat(race.zedChange) || 0), 0);
                const zedInvested = bloodlineRaces.filter(r => r.zedChange < 0).reduce((sum, race) => sum + Math.abs(parseFloat(race.zedChange) || 0), 0);
                const roi = zedInvested > 0 ? (zedChange / zedInvested) * 100 : 0;
                
                bloodlineData[bloodline] = {
                    races: totalRaces,
                    winRate: winRate,
                    avgPlace: avgPlace,
                    avgOdds: avgOdds,
                    roi: roi
                };
            });
            
            // Sort bloodlines by avgOdds ascending (lower odds first)
            bloodlines
                .filter(bloodline => bloodlineData[bloodline])
                .sort((a, b) => {
                    // Handle cases where avgOdds might be 0 or undefined
                    const oddsA = bloodlineData[a].avgOdds || Number.MAX_VALUE;
                    const oddsB = bloodlineData[b].avgOdds || Number.MAX_VALUE;
                    return oddsA - oddsB; // Ascending order (lower odds first)
                })
                .forEach(bloodline => {
                    const data = bloodlineData[bloodline];
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${bloodline}</td>
                        <td>${data.races}</td>
                        <td>${data.winRate.toFixed(1)}%</td>
                        <td>${data.avgPlace.toFixed(2)}</td>
                        <td>${data.avgOdds > 0 ? data.avgOdds.toFixed(1) : 'N/A'}</td>
                    `;
                });
        }
        
        // Render individual augment analysis
        function renderIndividualAugmentAnalysis() {
            const tbody = document.getElementById('individual-augment-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get filter values
            const minRaces = parseInt(document.getElementById('augment-analysis-min-races').value) || 5;
            const filterBloodline = document.getElementById('augment-analysis-bloodline-filter').value;
            
            // Get all races with augment and bloodline information
            const racesWithData = [];
            horses.filter(h => h.status === 'racing' && (!filterBloodline || h.bloodline === filterBloodline)).forEach(horse => {
                races.filter(r => r.horseId === horse.id).forEach(race => {
                    racesWithData.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (racesWithData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="7">No race data available</td>';
                return;
            }
            
            // Analyze individual augments
            const augmentStats = {};
            
            racesWithData.forEach(race => {
                // Process CPU augment if not None
                if (race.cpuAugment && race.cpuAugment !== 'None') {
                    if (!augmentStats[race.cpuAugment]) {
                        augmentStats[race.cpuAugment] = { type: 'CPU', races: 0, wins: 0, places: 0, shows: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                    }
                    augmentStats[race.cpuAugment].races++;
                    if (race.position === 1) augmentStats[race.cpuAugment].wins++;
                    if (race.position === 2) augmentStats[race.cpuAugment].places++;
                    if (race.position === 3) augmentStats[race.cpuAugment].shows++;
                    augmentStats[race.cpuAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.cpuAugment].oddsValues.push(parseFloat(race.odds));
                    }
                    if (race.zedChange !== null && race.zedChange !== undefined) {
                        augmentStats[race.cpuAugment].zedChange += parseFloat(race.zedChange);
                    }
                }
                
                // Process RAM augment if not None
                if (race.ramAugment && race.ramAugment !== 'None') {
                    if (!augmentStats[race.ramAugment]) {
                        augmentStats[race.ramAugment] = { type: 'RAM', races: 0, wins: 0, places: 0, shows: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                    }
                    augmentStats[race.ramAugment].races++;
                    if (race.position === 1) augmentStats[race.ramAugment].wins++;
                    if (race.position === 2) augmentStats[race.ramAugment].places++;
                    if (race.position === 3) augmentStats[race.ramAugment].shows++;
                    augmentStats[race.ramAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.ramAugment].oddsValues.push(parseFloat(race.odds));
                    }
                    if (race.zedChange !== null && race.zedChange !== undefined) {
                        augmentStats[race.ramAugment].zedChange += parseFloat(race.zedChange);
                    }
                }
                
                // Process Hydraulic augment if not None
                if (race.hydraulicAugment && race.hydraulicAugment !== 'None') {
                    if (!augmentStats[race.hydraulicAugment]) {
                        augmentStats[race.hydraulicAugment] = { type: 'Hydraulic', races: 0, wins: 0, places: 0, shows: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                    }
                    augmentStats[race.hydraulicAugment].races++;
                    if (race.position === 1) augmentStats[race.hydraulicAugment].wins++;
                    if (race.position === 2) augmentStats[race.hydraulicAugment].places++;
                    if (race.position === 3) augmentStats[race.hydraulicAugment].shows++;
                    augmentStats[race.hydraulicAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.hydraulicAugment].oddsValues.push(parseFloat(race.odds));
                    }
                    if (race.zedChange !== null && race.zedChange !== undefined) {
                        augmentStats[race.hydraulicAugment].zedChange += parseFloat(race.zedChange);
                    }
                }
            });
            
            // Filter augments with minimum races and calculate metrics
            const augmentData = [];
            Object.entries(augmentStats).forEach(([name, stats]) => {
                if (stats.races < minRaces) return;
                
                const winRate = (stats.wins / stats.races) * 100;
                const avgPlace = stats.placeSum / stats.races;
                const avgOdds = stats.oddsValues.length > 0 
                    ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                    : Number.MAX_VALUE; // Use MAX_VALUE for sorting purposes if no odds
                    
                // Calculate ROI
                const roi = (stats.zedChange / stats.races) * 100;
                
                augmentData.push({
                    name,
                    type: stats.type,
                    races: stats.races,
                    winRate,
                    avgPlace,
                    avgOdds,
                    roi
                });
            });
            
            // Sort by average odds (ascending - lower is better)
            augmentData.sort((a, b) => a.avgOdds - b.avgOdds);
            
            // Render table
            if (augmentData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="5">No augments with at least ${minRaces} races</td>`;
                return;
            }
            
            augmentData.forEach(data => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${data.name}</td>
                    <td>${data.type}</td>
                    <td>${data.races}</td>
                    <td>${data.winRate.toFixed(1)}%</td>
                    <td>${data.avgPlace.toFixed(2)}</td>
                    <td>${data.avgOdds !== Number.MAX_VALUE ? data.avgOdds.toFixed(1) : 'N/A'}</td>
                `;
            });
        }
        
        // Render augment pair analysis
        function renderAugmentPairAnalysis() {
            const tbody = document.getElementById('augment-pair-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get filter values
            const minRaces = parseInt(document.getElementById('augment-analysis-min-races').value) || 5;
            const filterBloodline = document.getElementById('augment-analysis-bloodline-filter').value;
            
            // Get all races with augment and bloodline information
            const racesWithData = [];
            horses.filter(h => h.status === 'racing' && (!filterBloodline || h.bloodline === filterBloodline)).forEach(horse => {
                races.filter(r => r.horseId === horse.id).forEach(race => {
                    racesWithData.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (racesWithData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5">No race data available</td>';
                return;
            }
            
            // Find all augment pairs used together
            const pairStats = {};
            
            racesWithData.forEach(race => {
                const augments = [
                    race.cpuAugment !== 'None' ? race.cpuAugment : null,
                    race.ramAugment !== 'None' ? race.ramAugment : null,
                    race.hydraulicAugment !== 'None' ? race.hydraulicAugment : null
                ].filter(a => a !== null);
                
                // Only process if 2 or more augments were used
                if (augments.length >= 2) {
                    // Generate all pairs (combinations of 2)
                    for (let i = 0; i < augments.length; i++) {
                        for (let j = i + 1; j < augments.length; j++) {
                            const pair = [augments[i], augments[j]].sort().join(' + ');
                            
                            if (!pairStats[pair]) {
                                pairStats[pair] = { races: 0, wins: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                            }
                            
                            pairStats[pair].races++;
                            if (race.position === 1) pairStats[pair].wins++;
                            pairStats[pair].placeSum += race.position;
                            if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                                pairStats[pair].oddsValues.push(parseFloat(race.odds));
                            }
                            if (race.zedChange !== null && race.zedChange !== undefined) {
                                pairStats[pair].zedChange += parseFloat(race.zedChange);
                            }
                        }
                    }
                }
            });
            
            // Filter pairs with minimum races and calculate metrics
            const pairData = [];
            Object.entries(pairStats).forEach(([pair, stats]) => {
                if (stats.races < minRaces) return;
                
                const winRate = (stats.wins / stats.races) * 100;
                const avgPlace = stats.placeSum / stats.races;
                const avgOdds = stats.oddsValues.length > 0 
                    ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                    : Number.MAX_VALUE; // Use MAX_VALUE for sorting if no odds data
                    
                // Calculate ROI
                const roi = (stats.zedChange / stats.races) * 100;
                
                pairData.push({
                    pair,
                    races: stats.races,
                    winRate,
                    avgPlace,
                    avgOdds,
                    roi
                });
            });
            
            // Sort by average odds (ascending - lower is better)
            pairData.sort((a, b) => a.avgOdds - b.avgOdds);
            
            // Render table
            if (pairData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="5">No augment pairs with at least ${minRaces} races</td>`;
                return;
            }
            
            pairData.forEach(data => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${data.pair}</td>
                    <td>${data.races}</td>
                    <td>${data.winRate.toFixed(1)}%</td>
                    <td>${data.avgPlace.toFixed(2)}</td>
                    <td>${data.avgOdds !== Number.MAX_VALUE ? data.avgOdds.toFixed(1) : 'N/A'}</td>
                `;
            });
        }
        
        // Render triple augment analysis 
        function renderTripleAugmentAnalysis() {
            const tbody = document.getElementById('augment-triple-body');
            if (!tbody) {
                console.error('Triple augment table body not found!');
                return;
            }
            
            console.log("Rendering Triple Augment Analysis");
            tbody.innerHTML = '';
            
            // Get filter values - properly parse as integers with fallback
            const minRacesInput = document.getElementById('augment-analysis-min-races');
            const minRacesValue = minRacesInput ? minRacesInput.value : "5";
            const minRaces = parseInt(minRacesValue) || 2; // Default to 2 if parsing fails
            console.log("Triple Augment Analysis using minRaces:", minRaces);
            
            const filterBloodline = document.getElementById('augment-analysis-bloodline-filter').value;
            console.log("Triple Augment Analysis using bloodline filter:", filterBloodline || "All");
            
            // Get all races with augment and bloodline information
            const racesWithData = [];
            horses.filter(h => h.status === 'racing' && (!filterBloodline || h.bloodline === filterBloodline)).forEach(horse => {
                races.filter(r => r.horseId === horse.id).forEach(race => {
                    racesWithData.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (racesWithData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5">No race data available</td>';
                return;
            }
            
            // Analyze triple augment combinations
            const tripleStats = {};
            
            racesWithData.forEach(race => {
                if (race.cpuAugment !== 'None' && race.ramAugment !== 'None' && race.hydraulicAugment !== 'None') {
                    const combo = `${race.cpuAugment} / ${race.ramAugment} / ${race.hydraulicAugment}`;
                    
                    if (!tripleStats[combo]) {
                        tripleStats[combo] = { races: 0, wins: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                    }
                    
                    tripleStats[combo].races++;
                    if (race.position === 1) tripleStats[combo].wins++;
                    tripleStats[combo].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        tripleStats[combo].oddsValues.push(parseFloat(race.odds));
                    }
                    if (race.zedChange !== null && race.zedChange !== undefined) {
                        tripleStats[combo].zedChange += parseFloat(race.zedChange);
                    }
                }
            });
            
            // Log stats before filtering to help debug
            console.log(`Found ${Object.keys(tripleStats).length} triple augment combinations before filtering`);
            
            // Filter combinations with minimum races and calculate metrics
            const tripleData = [];
            Object.entries(tripleStats).forEach(([combo, stats]) => {
                if (stats.races < minRaces) return;
                
                const winRate = (stats.wins / stats.races) * 100;
                const avgPlace = stats.placeSum / stats.races;
                const avgOdds = stats.oddsValues.length > 0 
                    ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                    : Number.MAX_VALUE; // Use MAX_VALUE for sorting if no odds data
                    
                // Calculate ROI
                const roi = (stats.zedChange / stats.races) * 100;
                
                tripleData.push({
                    combo,
                    races: stats.races,
                    winRate,
                    avgPlace,
                    avgOdds,
                    roi
                });
            });
            
            console.log(`Triple augment combinations after filtering (min ${minRaces} races):`, tripleData.length);
            
            // Sort by average odds (ascending - lower is better)
            tripleData.sort((a, b) => a.avgOdds - b.avgOdds);
            
            // Render table
            if (tripleData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="5">No triple combinations with at least ${minRaces} races</td>`;
                return;
            }
            
            tripleData.forEach(data => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${data.combo}</td>
                    <td>${data.races}</td>
                    <td>${data.winRate.toFixed(1)}%</td>
                    <td>${data.avgPlace.toFixed(2)}</td>
                    <td>${data.avgOdds !== Number.MAX_VALUE ? data.avgOdds.toFixed(1) : 'N/A'}</td>
                `;
            });
            
            console.log("Triple Augment Analysis completed");
        }

        // Function to populate the horse filter dropdown in augment analysis
        function populateAugmentAnalysisHorseFilter() {
            if (!augmentAnalysisHorseFilter) return;
            
            // Clear existing options except the first "All Horses" option
            while (augmentAnalysisHorseFilter.options.length > 1) {
                augmentAnalysisHorseFilter.remove(1);
            }
            
            // Get racing horses only
            const racingHorses = horses.filter(h => h.status === 'racing');
            
            // Sort alphabetically by name
            racingHorses.sort((a, b) => a.name.localeCompare(b.name));
            
            // Add options for each horse
            racingHorses.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.id;
                option.textContent = horse.name;
                augmentAnalysisHorseFilter.appendChild(option);
            });
        }

        // Helper function to get the correctly filtered list of horses WITH their stats
        function getFilteredRacingHorses() {
            const filterBloodline = horseFilterBloodline.value;
            const filterGender = horseFilterGender.value;
            const minStars = parseFloat(horseFilterMinStars.value) || null;
            const maxStars = parseFloat(horseFilterMaxStars.value) || null;
            const minSpeed = parseFloat(horseFilterMinSpeed.value) || null;
            const maxSpeed = parseFloat(horseFilterMaxSpeed.value) || null;
            const minSprint = parseFloat(horseFilterMinSprint.value) || null;
            const maxSprint = parseFloat(horseFilterMaxSprint.value) || null;
            const minEndurance = parseFloat(horseFilterMinEndurance.value) || null;
            const maxEndurance = parseFloat(horseFilterMaxEndurance.value) || null;

            // Helper function to check star ranges (handles null/undefined horse stars)
            const checkStarRange = (horseStars, minFilter, maxFilter) => {
                const stars = (horseStars !== null && horseStars !== undefined && horseStars !== '') ? parseFloat(horseStars) : null;
                // If a filter is active for this star type, but the horse doesn't have the star value, exclude it.
                if ((minFilter !== null || maxFilter !== null) && stars === null) return false;
                // If no filter is active OR the horse has the star, proceed with range check.
                const minMatch = (minFilter === null || (stars !== null && stars >= minFilter));
                const maxMatch = (maxFilter === null || (stars !== null && stars <= maxFilter));
                return minMatch && maxMatch;
            };

            // First, calculate stats for ALL active racing horses (needed for sorting later)
            const allRacingHorsesWithStats = horses
                .filter(h => h.status === 'racing')
                .map(horse => ({ ...horse, calculatedStats: calculateHorseStats(horse.id) }));

            // Then, apply filters to the list with stats
            const filteredHorses = allRacingHorsesWithStats.filter(horseData => {
                const h = horseData; // horse object
                //const stats = horseData.calculatedStats; // We aren't filtering by stats currently

                const bloodlineMatch = !filterBloodline || h.bloodline === filterBloodline;
                const genderMatch = !filterGender || h.gender === filterGender;
                const overallStarsMatch = checkStarRange(h.stars, minStars, maxStars);
                const speedStarsMatch = checkStarRange(h.speedStars, minSpeed, maxSpeed);
                const sprintStarsMatch = checkStarRange(h.sprintStars, minSprint, maxSprint);
                const enduranceStarsMatch = checkStarRange(h.enduranceStars, minEndurance, maxEndurance);

                return bloodlineMatch && genderMatch && overallStarsMatch && speedStarsMatch && sprintStarsMatch && enduranceStarsMatch;
            });
            return filteredHorses;
        }

        // Update the visual sort indicators in the table headers
        function updateSortIndicators() {
            const headers = document.querySelectorAll('#horses-table th[data-sort-key]');
            headers.forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sortKey === racingHorseSort.key) {
                    th.classList.add(racingHorseSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        // --- Rendering for Bred Horses History ---
        function renderBredHorsesTable() {
            bredHorsesTableBody.innerHTML = '';
            const allHorses = [...horses]; // Use unified list to find parent names
            const formatStars = (stars) => (stars !== null && stars !== undefined && stars !== '') ? Number(stars).toFixed(1) : '-';
 
            // Sort by date descending (already done before pagination)
            const sortedBred = [...bredHorses].sort((a,b) => {
                const dateA = a.bredDate ? new Date(a.bredDate) : 0;
                const dateB = b.bredDate ? new Date(b.bredDate) : 0;
                return dateB - dateA; // Descending
            });

            // Pagination Calculation for Bred History
            const totalItems = sortedBred.length;
            const totalPages = Math.ceil(totalItems / bredHistoryTableItemsPerPage);
            if (bredHistoryTableCurrentPage > totalPages) {
                bredHistoryTableCurrentPage = Math.max(totalPages, 1);
            }
            const startIndex = (bredHistoryTableCurrentPage - 1) * bredHistoryTableItemsPerPage;
            const endIndex = startIndex + bredHistoryTableItemsPerPage;
            const bredToShow = sortedBred.slice(startIndex, endIndex);

            // Render the sliced rows
            bredToShow.forEach(bred => {
                // Find parent names (internal or external)
                let sireName = 'N/A';
                if (bred.externalSireName) {
                    // Format external sire name and stars
                    const overall = formatStars(bred.externalSireOverallStars);
                    const speed = formatStars(bred.externalSireSpeedStars);
                    const sprint = formatStars(bred.externalSireSprintStars);
                    const endurance = formatStars(bred.externalSireEnduranceStars);
                    sireName = `${bred.externalSireName} (Ext. O:${overall}/Sp:${speed}/Sr:${sprint}/E:${endurance})`;
                } else if (bred.sireId) {
                    const sire = allHorses.find(h => h.id === bred.sireId);
                    sireName = sire ? sire.name : `(Deleted: ID ${bred.sireId})`;
                }
                let damName = 'N/A';
                if (bred.damId) { // Dams are assumed internal
                    const dam = allHorses.find(h => h.id === bred.damId);
                    damName = dam ? dam.name : `(Deleted: ID ${bred.damId})`;
                }

                const row = bredHorsesTableBody.insertRow();
                row.innerHTML = `
                    <td>${bred.bredDate ? new Date(bred.bredDate).toLocaleDateString() : '-'}</td>
                    <td>${bred.name}</td>
                    <td>${bred.bloodline}</td>
                    <td>
                        <span class="swatch" style="background:${bred.color};"></span>
                        ${getColorLabel(bred.bloodline, bred.color)}
                        </td>
                    <td>${bred.gender}</td>
                    <td>${sireName}</td>
                    <td>${damName}</td>
                    <td>${formatStars(bred.stars)}</td>
                    <td>${formatStars(bred.speedStars)}</td>
                    <td>${formatStars(bred.sprintStars)}</td>
                    <td>${formatStars(bred.enduranceStars)}</td>
                    <td>${bred.studFeePaid ? bred.studFeePaid.toFixed(2) : '0.00'}</td>
                    <td class="actions">
                        <button class="action-button edit-button" onclick="editBredHorse('${bred.id}')" title="Edit Bred Record">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-button delete-button" onclick="deleteBredHorse('${bred.id}')" title="Delete Bred Record">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </td>
                `;
            });

            // Render Pagination Controls for Bred History
            renderBredHistoryPaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Bred History Table ---
        function renderBredHistoryPaginationControls(totalItems, totalPages) {
            const pageNavContainer = bredHistoryPageInfoSpan?.parentElement;
            const controlsContainer = document.getElementById('bred-history-pagination-controls');

            if (!bredHistoryPageInfoSpan || !bredHistoryPrevPageButton || !bredHistoryNextPageButton || !controlsContainer || !pageNavContainer) {
                console.warn("Bred history pagination elements not found, skipping control render.");
                return;
            }

            controlsContainer.style.display = 'flex';

            if (totalItems === 0) {
                bredHistoryPageInfoSpan.textContent = 'No bred records found';
            } else {
                bredHistoryPageInfoSpan.textContent = `Page ${bredHistoryTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }

            bredHistoryPrevPageButton.disabled = bredHistoryTableCurrentPage <= 1;
            bredHistoryNextPageButton.disabled = bredHistoryTableCurrentPage >= totalPages;
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers for Bred History ---
        function handleBredHistoryItemsPerPageChange() {
            const newSize = parseInt(bredHistoryItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                bredHistoryTableItemsPerPage = newSize;
                bredHistoryTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('bredHistoryTableItemsPerPage', bredHistoryTableItemsPerPage.toString()); // Save preference
                renderBredHorsesTable();
            }
        }

        function handleBredHistoryPrevPage() {
            if (bredHistoryTableCurrentPage > 1) {
                bredHistoryTableCurrentPage--;
                renderBredHorsesTable();
            }
        }

        function handleBredHistoryNextPage() {
            const totalItems = bredHorses.length; // Use full bred list length
            const totalPages = Math.ceil(totalItems / bredHistoryTableItemsPerPage);
            if (bredHistoryTableCurrentPage < totalPages) {
                bredHistoryTableCurrentPage++;
                renderBredHorsesTable();
            }
        }

        // --- Render Transactions Table ---
        function renderTransactionsTable() {
            if (!document.getElementById('transactions-table-body')) return;
            
            const tbody = document.getElementById('transactions-table-body');
            tbody.innerHTML = '';
            
            // Sort by date descending
            const sortedTransactions = [...transactions].sort((a, b) => {
                const dateA = a.date ? new Date(a.date) : 0;
                const dateB = b.date ? new Date(b.date) : 0;
                return dateB - dateA; // Descending
            });
            
            // Pagination Calculation for Transactions
            const totalItems = sortedTransactions.length;
            const totalPages = Math.ceil(totalItems / transactionTableItemsPerPage);
            if (transactionTableCurrentPage > totalPages) {
                transactionTableCurrentPage = Math.max(totalPages, 1);
            }
            const startIndex = (transactionTableCurrentPage - 1) * transactionTableItemsPerPage;
            const endIndex = startIndex + transactionTableItemsPerPage;
            const transactionsToShow = sortedTransactions.slice(startIndex, endIndex);
            
            // Render the sliced rows
            transactionsToShow.forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.date ? new Date(transaction.date).toLocaleDateString() : '-'}</td>
                    <td>${transaction.type === 'sale' ? 'Sale' : 'Purchase'}</td>
                    <td>${transaction.horseName || 'Unknown'}</td>
                    <td style="color: ${transaction.type === 'sale' ? 'var(--success-color)' : 'var(--error-color)'};">
                        ${transaction.type === 'sale' ? '+' : '-'}$${transaction.amount.toFixed(2)}
                    </td>
                    <td>${transaction.notes || ''}</td>
                    <td class="actions">
                        <button class="action-button edit-button" onclick="editTransaction('${transaction.id}')" title="Edit Transaction">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-button delete-button" onclick="deleteTransaction('${transaction.id}')" title="Delete Transaction">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </td>
                `;
            });
            
            // Render Pagination Controls
            renderTransactionPaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Transactions Table ---
        function renderTransactionPaginationControls(totalItems, totalPages) {
            const pageNavContainer = transactionsPageInfoSpan?.parentElement;
            const controlsContainer = document.getElementById('transactions-pagination-controls');
            
            if (!transactionsPageInfoSpan || !transactionsPrevPageButton || !transactionsNextPageButton || !controlsContainer || !pageNavContainer) {
                console.warn("Transaction pagination elements not found, skipping control render.");
                return;
            }
            
            controlsContainer.style.display = 'flex';
            
            if (totalItems === 0) {
                transactionsPageInfoSpan.textContent = 'No transactions found';
            } else {
                transactionsPageInfoSpan.textContent = `Page ${transactionTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }
            
            transactionsPrevPageButton.disabled = transactionTableCurrentPage <= 1;
            transactionsNextPageButton.disabled = transactionTableCurrentPage >= totalPages;
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers for Transactions ---
        function handleTransactionsItemsPerPageChange() {
            const newSize = parseInt(transactionsItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                transactionTableItemsPerPage = newSize;
                transactionTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('transactionsTableItemsPerPage', transactionTableItemsPerPage.toString()); // Save preference
                renderTransactionsTable();
            }
        }

        function handleTransactionsPrevPage() {
            if (transactionTableCurrentPage > 1) {
                transactionTableCurrentPage--;
                renderTransactionsTable();
            }
        }

        function handleTransactionsNextPage() {
            const totalItems = transactions.length;
            const totalPages = Math.ceil(totalItems / transactionTableItemsPerPage);
            if (transactionTableCurrentPage < totalPages) {
                transactionTableCurrentPage++;
                renderTransactionsTable();
            }
        }

        // --- Transaction Management Functions ---
        function handleAddTransaction(event) {
            event.preventDefault();
            
            const typeSelect = document.getElementById('transaction-type');
            const horseNameInput = document.getElementById('transaction-horse-name');
            const dateInput = document.getElementById('transaction-date');
            const amountInput = document.getElementById('transaction-amount');
            const notesInput = document.getElementById('transaction-notes');
            
            const transactionData = {
                id: currentlyEditingTransaction ? currentlyEditingTransaction.id : `transaction-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                type: typeSelect.value,
                horseName: horseNameInput.value.trim(),
                date: dateInput.value || new Date().toISOString().split('T')[0], // Today if not specified
                amount: parseFloat(amountInput.value) || 0,
                notes: notesInput.value.trim()
            };
            
            // Validation
            if (!transactionData.type) {
                alert("Please select a transaction type (sale or purchase).");
                return;
            }
            
            if (!transactionData.horseName) {
                alert("Please enter a horse name.");
                return;
            }
            
            if (transactionData.amount <= 0) {
                alert("Please enter a valid positive amount.");
                return;
            }
            
            if (currentlyEditingTransaction) {
                // Update existing transaction
                const index = transactions.findIndex(t => t.id === currentlyEditingTransaction.id);
                if (index !== -1) {
                    transactions[index] = transactionData;
                }
            } else {
                // Add new transaction
                transactions.push(transactionData);
            }
            
            // Save, update UI
            saveData();
            renderTransactionsTable();
            updateOverallStats();
            
            // Reset form and editing state
            document.getElementById('add-transaction-form').reset();
            currentlyEditingTransaction = null;
            const submitButton = document.getElementById('add-transaction-form').querySelector('button[type="submit"]');
            if (submitButton) submitButton.textContent = 'Record Transaction';
        }

        function editTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                console.error("Transaction not found for editing:", transactionId);
                return;
            }
            
            // Store the transaction being edited
            currentlyEditingTransaction = transaction;
            
            // Populate the form
            document.getElementById('transaction-type').value = transaction.type;
            document.getElementById('transaction-horse-name').value = transaction.horseName;
            document.getElementById('transaction-date').value = transaction.date;
            document.getElementById('transaction-amount').value = transaction.amount.toFixed(2);
            document.getElementById('transaction-notes').value = transaction.notes || '';
            
            // Update button text
            const submitButton = document.getElementById('add-transaction-form').querySelector('button[type="submit"]');
            if (submitButton) submitButton.textContent = 'Update Transaction';
            
            // Switch to transactions tab and scroll to form
            if (document.querySelector('.tab-button[data-tab="transactions"]')) {
                activateTab('transactions');
            }
            document.getElementById('transactions-section').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            if (confirm(`Are you sure you want to delete this ${transaction.type} transaction for ${transaction.horseName}?`)) {
                transactions = transactions.filter(t => t.id !== transactionId);
                saveData();
                renderTransactionsTable();
                updateOverallStats();
                console.log("Transaction deleted:", transactionId);
            }
        }

        // --- Augment Management Handlers ---
        function handleAddAugment(event) {
            event.preventDefault();
            
            const augmentNameInput = document.getElementById('augment-name');
            const augmentTypeSelect = document.getElementById('augment-type');
            
            const augmentName = augmentNameInput.value.trim();
            const augmentType = augmentTypeSelect.value;
            
            // Validation
            if (!augmentName) {
                alert("Please enter an augment name.");
                return;
            }
            
            if (!augmentType) {
                alert("Please select an augment type (CPU, RAM, or Hydraulic).");
                return;
            }
            
            // Check which list to add to based on type
            let targetList;
            switch (augmentType) {
                case 'CPU':
                    targetList = cpuAugments;
                    break;
                case 'RAM':
                    targetList = ramAugments;
                    break;
                case 'Hydraulic':
                    targetList = hydraulicAugments;
                    break;
                default:
                    alert("Invalid augment type selected.");
                    return;
            }
            
            // Check for duplicates in the target list
            if (targetList.includes(augmentName)) {
                alert(`An augment named "${augmentName}" already exists in the ${augmentType} list.`);
                return;
            }
            
            // Add to the appropriate list
            targetList.push(augmentName);
            
            // Update UI
            populateAugmentDropdowns();
            saveData(); // Save to localStorage
            
            // Reset form
            augmentNameInput.value = '';
            augmentTypeSelect.value = '';
            
            console.log(`Added ${augmentName} to ${augmentType} augments list.`);
        }
        
        function handleDeleteAugment(augmentName, type) {
            if (!confirm(`Are you sure you want to delete the ${type} augment "${augmentName}"?`)) {
                return;
            }
            
            let targetList;
            switch (type) {
                case 'CPU':
                    targetList = cpuAugments;
                    break;
                case 'RAM':
                    targetList = ramAugments;
                    break;
                case 'Hydraulic':
                    targetList = hydraulicAugments;
                    break;
                default:
                    alert("Invalid augment type.");
                    return;
            }
            
            // Remove the augment from the list
            const index = targetList.indexOf(augmentName);
            if (index !== -1) {
                targetList.splice(index, 1);
                
                // Update UI
                populateAugmentDropdowns();
                saveData(); // Save to localStorage
                
                console.log(`Deleted ${augmentName} from ${type} augments list.`);
            } else {
                console.error(`Could not find augment "${augmentName}" in ${type} list.`);
            }
        }

        // --- Table Sorting Handler ---
        function handleSortClick(event) {
            const clickedHeader = event.currentTarget;
            const newSortKey = clickedHeader.dataset.sortKey;
            
            // If clicking the same column, toggle direction, otherwise set to asc
            if (newSortKey === racingHorseSort.key) {
                // Toggle direction
                racingHorseSort.direction = racingHorseSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, start with ascending
                racingHorseSort.key = newSortKey;
                racingHorseSort.direction = 'asc';
            }
            
            // Re-render table with new sort
            renderHorsesTable();
            
            // Visual indicators already updated in renderHorsesTable -> updateSortIndicators
            console.log(`Sorted by ${racingHorseSort.key} (${racingHorseSort.direction})`);
        }

        // --- Data Export/Import Handlers ---
        function handleExportData() {
            // Prepare the data to export
            const dataToExport = {
                horses: horses,
                races: races,
                bredHorses: bredHorses,
                studAuctions: studAuctions, // Include stud auctions
                cpuAugments: cpuAugments,
                ramAugments: ramAugments,
                hydraulicAugments: hydraulicAugments,
                retirementEarnings: totalRetirementEarnings,
                version: '1.0', // Add version info for future compatibility
                exportDate: new Date().toISOString()
            };
            
            // Convert to JSON string
            const jsonData = JSON.stringify(dataToExport, null, 2); // Pretty-print with 2 spaces
            
            // Create a Blob and URL
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create a temporary download link
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            
            // Generate filename with date
            const date = new Date();
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            downloadLink.download = `zed_tracker_backup_${dateStr}.json`;
            
            // Append to document, click, and clean up
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            
            console.log("Data exported successfully");
        }
        
        function handleImportData(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            
            if (!file) {
                console.log("No file selected");
                return;
            }
            
            // Check if it's a JSON file
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                alert("Please select a valid JSON backup file.");
                fileInput.value = ''; // Clear the input
                return;
            }
            
            if (!confirm("WARNING: Importing data will replace all current horses, races, and settings. This cannot be undone. Continue?")) {
                fileInput.value = ''; // Clear the input
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Basic validation - check for required data
                    if (!importedData.horses || !Array.isArray(importedData.horses) ||
                        !importedData.races || !Array.isArray(importedData.races)) {
                        throw new Error("Invalid backup file: Missing required data");
                    }
                    
                    // Import data
                    horses = importedData.horses || [];
                    races = importedData.races || [];
                    bredHorses = importedData.bredHorses || [];
                    studAuctions = importedData.studAuctions || []; // Import stud auctions
                    cpuAugments = importedData.cpuAugments || [...cpuAugments]; // Fallback to current if missing
                    ramAugments = importedData.ramAugments || [...ramAugments];
                    hydraulicAugments = importedData.hydraulicAugments || [...hydraulicAugments];
                    totalRetirementEarnings = importedData.retirementEarnings || 0;
                    
                    // Save and refresh
                    saveData();
                    location.reload(); // Refresh the page to update everything
                    
                    alert("Data imported successfully!");
                } catch (error) {
                    console.error("Error importing data:", error);
                    alert("Error importing data. Please ensure you selected a valid Zed Tracker backup file.");
                }
                fileInput.value = ''; // Clear the input
            };
            
            reader.onerror = function() {
                alert("Error reading file. Please try again.");
                fileInput.value = ''; // Clear the input
            };
            
            reader.readAsText(file);
        }

        function editRace(raceId) {
            const race = races.find(r => r.id === raceId);
            if (!race) {
                console.error("Race not found for editing:", raceId);
                return;
            }
            
            // Store the race being edited
            currentlyEditingRace = race;
            
            // Populate the race form with the race data
            const raceHorseSelect = document.getElementById('race-horse');
            const positionInput = document.getElementById('race-position');
            const oddsInput = document.getElementById('race-odds');
            const timeInput = document.getElementById('race-finish-time');
            const zedChangeInput = document.getElementById('race-zed-change');
            const ratingChangeInput = document.getElementById('race-rating-change');
            const cpuSelect = document.getElementById('race-cpu-augment');
            const ramSelect = document.getElementById('race-ram-augment');
            const hydraulicSelect = document.getElementById('race-hydraulic-augment');
            // ...inside editRace...
            document.getElementById('race-name').value = race.raceName || '';
            document.getElementById('race-date').value = race.raceDate || '';
            document.getElementById('race-split-1').value = race.split1 !== null && race.split1 !== undefined ? race.split1 : '';
            document.getElementById('race-split-2').value = race.split2 !== null && race.split2 !== undefined ? race.split2 : '';
            document.getElementById('race-split-3').value = race.split3 !== null && race.split3 !== undefined ? race.split3 : '';
            document.getElementById('race-split-4').value = race.split4 !== null && race.split4 !== undefined ? race.split4 : '';
            
            // Set form values
            raceHorseSelect.value = race.horseId;
            positionInput.value = race.position;
            oddsInput.value = race.odds;
            timeInput.value = race.finishTime || '';
            zedChangeInput.value = race.zedChange;
            ratingChangeInput.value = race.ratingChange !== null ? race.ratingChange : '';
            cpuSelect.value = race.cpuAugment;
            ramSelect.value = race.ramAugment;
            hydraulicSelect.value = race.hydraulicAugment;
            
            // Update button text to indicate editing
            const submitButton = document.getElementById('add-race-form').querySelector('button[type="submit"]');
            submitButton.textContent = 'Update Race';
            
            // Scroll to the form
            document.getElementById('races-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Function to handle retiring a horse from racing to breeding
        function handleRetireHorse(horseId) {
            const horse = horses.find(h => h.id === horseId);
            if (!horse) {
                console.error("Horse not found for retirement:", horseId);
                return;
            }

            // Only racing horses can be retired
            if (horse.status !== 'racing') {
                alert(`${horse.name} is not currently racing and cannot be retired.`);
                return;
            }

            // Calculate current balance from races
            const stats = calculateHorseStats(horseId);
            const currentBalance = stats.currentZedBalance;
            const initialBalance = Number(horse.initialZedBalance || 0);
            const earningsFromRacing = currentBalance - initialBalance;

            // Confirm retirement with the user
            if (!confirm(`Are you sure you want to retire ${horse.name} to the breeding stable?\n\nCurrent $ZED Balance: ${currentBalance.toFixed(2)}\nEarnings from Racing: ${earningsFromRacing.toFixed(2)}`)) {
                return;
            }

            // Add the entire current balance to retirement earnings
            totalRetirementEarnings += currentBalance;

            // Change status from racing to breeding
            horse.status = 'breeding';

            // Save data and update UI
            saveData();
            renderHorsesTable(); // Update racing table (horse will be removed)
            renderBreedingHorsesTable(); // Update breeding table (horse will be added)
            updateHorseDropdown(); // Update race form dropdown
            updateParentDropdowns(); // Update parent dropdowns for breeding
            populateAugmentAnalysisHorseFilter(); // Update horse filter in analysis
            updateOverallStats(); // Update stats to reflect retirement
            // ...inside handleRetireHorse, after updateOverallStats();
            updateStudAuctionSelect();
            updateFoalPredictorDropdowns();
            console.log(`Horse ${horse.name} retired with earnings of ${earningsFromRacing.toFixed(2)}`);
        }

        // --- Update Stud Auction Dropdown ---
        function updateStudAuctionSelect() {
            // Skip if element doesn't exist yet
            if (!studAuctionHorseSelect) return;
            
            studAuctionHorseSelect.innerHTML = '<option value="">--Select Male Breeding Horse--</option>';
            
            // Filter for male breeding horses only
            const maleBreedingHorses = horses.filter(h => h.status === 'breeding' && h.gender === 'Male');
            
            // Sort alphabetically by name
            maleBreedingHorses.sort((a, b) => a.name.localeCompare(b.name));
            
            // Add options for each horse
            maleBreedingHorses.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.id;
                option.textContent = horse.name;
                studAuctionHorseSelect.appendChild(option);
            });
        }

        // --- Handle Stud Auction Price Change ---
        function handleStudAuctionPriceChange() {
            const price = parseFloat(studAuctionPriceInput.value) || 0;
            const commission = price * 0.05; // 5% commission
            
            // Only update if not being edited by user (prevent circular updates)
            if (!studAuctionCommissionInput.matches(':focus')) {
                studAuctionCommissionInput.value = commission.toFixed(2);
            }
        }
        
        // --- Handle Stud Auction Commission Change ---
        function handleStudAuctionCommissionChange() {
            const commission = parseFloat(studAuctionCommissionInput.value) || 0;
            const price = commission * 20; // Commission is 5% of price, so price = commission * 20
            
            // Only update if not being edited by user (prevent circular updates)
            if (!studAuctionPriceInput.matches(':focus')) {
                studAuctionPriceInput.value = price.toFixed(2);
            }
        }

        // --- Handle Add Stud Auction ---
        function handleAddStudAuction(event) {
            event.preventDefault();
            
            const horseId = studAuctionHorseSelect.value;
            
            // Make sure we parse as floats and handle cases where values might be empty
            let auctionPrice = parseFloat(studAuctionPriceInput.value) || 0;
            let commission = parseFloat(studAuctionCommissionInput.value) || 0;
            const auctionDate = studAuctionDateInput.value || new Date().toISOString().split('T')[0]; // Today if not specified
            
            // Validation
            if (!horseId) {
                alert("Please select a breeding stud.");
                return;
            }
            
            // Ensure both price and commission are valid and consistent
            if (auctionPrice <= 0 && commission <= 0) {
                alert("Please enter either a valid auction price or commission amount.");
                return;
            }
            
            // If user entered commission directly but not price, calculate price
            if (commission > 0 && auctionPrice <= 0) {
                auctionPrice = commission * 20;
                studAuctionPriceInput.value = auctionPrice.toFixed(2);
            } 
            // If user entered price but not commission, calculate commission
            else if (auctionPrice > 0 && commission <= 0) {
                commission = auctionPrice * 0.05;
                studAuctionCommissionInput.value = commission.toFixed(2);
            }
            
            const horse = horses.find(h => h.id === horseId);
            if (!horse) {
                alert("Selected horse not found. Please refresh and try again.");
                return;
            }
            
            // Create new auction record or update existing
            if (currentlyEditingStudAuction) {
                // Update existing record
                const index = studAuctions.findIndex(sa => sa.id === currentlyEditingStudAuction.id);
                if (index !== -1) {
                    studAuctions[index] = {
                        ...currentlyEditingStudAuction,
                        horseId: horseId,
                        horseName: horse.name,
                        auctionPrice: auctionPrice,
                        commission: commission,
                        date: auctionDate
                    };
                }
            } else {
                // Create new record
                const newRecord = {
                    id: `stud-auction-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                    horseId: horseId,
                    horseName: horse.name,
                    auctionPrice: auctionPrice,
                    commission: commission,
                    date: auctionDate
                };
                
                studAuctions.push(newRecord);
            }
            
            // Update totals, save data, and refresh UI
            saveData();
            renderStudAuctionTable();
            updateOverallStats();
            
            // Reset form and editing state
            addStudAuctionForm.reset();
            currentlyEditingStudAuction = null;
            const submitButton = addStudAuctionForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Record Income';
            
            console.log("Stud auction income recorded successfully");
        }

        // --- Render Stud Auction Table ---
        function renderStudAuctionTable() {
            if (!studAuctionTableBody) return;
            
            studAuctionTableBody.innerHTML = '';
            
            // Sort by date descending
            const sortedAuctions = [...studAuctions].sort((a, b) => {
                const dateA = a.date ? new Date(a.date) : 0;
                const dateB = b.date ? new Date(b.date) : 0;
                return dateB - dateA; // Descending
            });
            
            // Pagination calculation
            const totalItems = sortedAuctions.length;
            const totalPages = Math.ceil(totalItems / studAuctionTableItemsPerPage);
            
            if (studAuctionTableCurrentPage > totalPages) {
                studAuctionTableCurrentPage = Math.max(totalPages, 1);
            }
            
            const startIndex = (studAuctionTableCurrentPage - 1) * studAuctionTableItemsPerPage;
            const endIndex = startIndex + studAuctionTableItemsPerPage;
            const auctionsToShow = sortedAuctions.slice(startIndex, endIndex);
            
            // Render the sliced rows
            auctionsToShow.forEach(auction => {
                const row = studAuctionTableBody.insertRow();
                
                row.innerHTML = `
                    <td>${auction.date ? new Date(auction.date).toLocaleDateString() : '-'}</td>
                    <td>${auction.horseName || 'Unknown'}</td>
                    <td>${auction.auctionPrice.toFixed(2)}</td>
                    <td style="color: var(--success-color);">${auction.commission.toFixed(2)}</td>
                    <td class="actions">
                        <button class="action-button edit-button" onclick="editStudAuction('${auction.id}')" title="Edit Auction Record">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-button delete-button" onclick="deleteStudAuction('${auction.id}')" title="Delete Auction Record">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </td>
                `;
            });
            
            // Render pagination controls
            renderStudAuctionPaginationControls(totalItems, totalPages);
        }

        // --- Pagination controls for stud auction table ---
        function renderStudAuctionPaginationControls(totalItems, totalPages) {
            const itemsPerPageSelectContainer = document.getElementById('stud-auction-items-per-page')?.parentElement;
            const pageNavContainer = document.getElementById('stud-auction-page-info')?.parentElement;
            const controlsContainer = document.getElementById('stud-auction-pagination-controls');
            const pageInfoSpan = document.getElementById('stud-auction-page-info');
            const prevPageButton = document.getElementById('stud-auction-prev-page');
            const nextPageButton = document.getElementById('stud-auction-next-page');
            
            if (!pageInfoSpan || !prevPageButton || !nextPageButton || !controlsContainer || !pageNavContainer) {
                console.warn("Stud auction pagination elements not found, skipping control render.");
                return;
            }
            
            controlsContainer.style.display = 'flex';
            
            if (totalItems === 0) {
                pageInfoSpan.textContent = 'No auction records found';
            } else {
                pageInfoSpan.textContent = `Page ${studAuctionTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }
            
            prevPageButton.disabled = studAuctionTableCurrentPage <= 1;
            nextPageButton.disabled = studAuctionTableCurrentPage >= totalPages;
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers for Stud Auction ---
        function handleStudAuctionItemsPerPageChange() {
            const itemsPerPageSelect = document.getElementById('stud-auction-items-per-page');
            const newSize = parseInt(itemsPerPageSelect.value, 10);
            
            if (!isNaN(newSize) && newSize > 0) {
                studAuctionTableItemsPerPage = newSize;
                studAuctionTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('studAuctionTableItemsPerPage', studAuctionTableItemsPerPage.toString()); // Save preference
                renderStudAuctionTable();
            }
        }

        function handleStudAuctionPrevPage() {
            if (studAuctionTableCurrentPage > 1) {
                studAuctionTableCurrentPage--;
                renderStudAuctionTable();
            }
        }

        function handleStudAuctionNextPage() {
            const totalItems = studAuctions.length;
            const totalPages = Math.ceil(totalItems / studAuctionTableItemsPerPage);
            
            if (studAuctionTableCurrentPage < totalPages) {
                studAuctionTableCurrentPage++;
                renderStudAuctionTable();
            }
        }

        // --- Edit, Delete Stud Auction ---
        function editStudAuction(auctionId) {
            const auction = studAuctions.find(a => a.id === auctionId);
            if (!auction) {
                console.error("Stud auction record not found for editing:", auctionId);
                return;
            }
            
            // Store the record being edited
            currentlyEditingStudAuction = auction;
            
            // Populate the form
            studAuctionHorseSelect.value = auction.horseId;
            studAuctionPriceInput.value = auction.auctionPrice.toFixed(2);
            studAuctionCommissionInput.value = auction.commission.toFixed(2);
            studAuctionDateInput.value = auction.date;
            
            // Update button text
            const submitButton = addStudAuctionForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Update Income';
            
            // Scroll to the form
            document.getElementById('stud-auction-section').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteStudAuction(auctionId) {
            const auction = studAuctions.find(a => a.id === auctionId);
            if (!auction) return;
            
            if (confirm(`Are you sure you want to delete this stud auction record for ${auction.horseName}?`)) {
                studAuctions = studAuctions.filter(a => a.id !== auctionId);
                saveData();
                renderStudAuctionTable();
                updateOverallStats();
                console.log("Stud auction record deleted:", auctionId);
            }
        }

        // --- Functions for manually updating stud fees ---
        function populateManualStudFeeDropdown() {
            const dropdown = document.getElementById('manual-stud-fee-bred-horse');
            if (!dropdown) return;
            
            // Clear existing options except first one
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }
            
            // Sort bred horses by date (newest first)
            const sortedBredHorses = [...bredHorses].sort((a, b) => {
                const dateA = a.bredDate ? new Date(a.bredDate) : new Date(0);
                const dateB = b.bredDate ? new Date(b.bredDate) : new Date(0);
                return dateB - dateA; // Descending (newest first)
            });
            
            // Add each bred horse to the dropdown
            sortedBredHorses.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.id;
                
                // Include stud fee in the display
                const studFee = horse.studFeePaid ? `($${horse.studFeePaid.toFixed(2)})` : '(No fee)';
                option.textContent = `${horse.name} - ${studFee}`;
                
                dropdown.appendChild(option);
            });
        }
        
        function handleManualStudFeeUpdate() {
            const dropdown = document.getElementById('manual-stud-fee-bred-horse');
            const feeInput = document.getElementById('manual-stud-fee-amount');
            
            const bredHorseId = dropdown.value;
            const newFee = parseFloat(feeInput.value);
            
            // Validation
            if (!bredHorseId) {
                alert("Please select a bred horse.");
                return;
            }
            
            if (isNaN(newFee) || newFee < 0) {
                alert("Please enter a valid stud fee amount (0 or greater).");
                return;
            }
            
            // Find the bred horse
            const bredHorseIndex = bredHorses.findIndex(h => h.id === bredHorseId);
            if (bredHorseIndex === -1) {
                alert("Selected bred horse not found.");
                return;
            }
            
            // Store the old fee for confirmation
            const oldFee = bredHorses[bredHorseIndex].studFeePaid || 0;
            
            // Confirm the update
            if (!confirm(`Update stud fee for ${bredHorses[bredHorseIndex].name} from $${oldFee.toFixed(2)} to $${newFee.toFixed(2)}?`)) {
                return;
            }
            
            // Update the fee
            bredHorses[bredHorseIndex].studFeePaid = newFee;
            
            // Save data and update UI
            saveData();
            updateOverallStats();
            renderBredHorsesTable();
            populateManualStudFeeDropdown(); // Refresh the dropdown
            
            // Clear the input
            feeInput.value = '';
            
            alert(`Stud fee for ${bredHorses[bredHorseIndex].name} updated to $${newFee.toFixed(2)}.`);
        }

        // --- Function to edit horses (racing or breeding) ---
      function editHorse(horseId) {
            const horse = horses.find(h => h.id === horseId);
            if (!horse) {
                console.error("Horse not found for editing:", horseId);
                return;
            }
            
            // Store the horse being edited
            currentlyEditingHorse = horse;
            
            // Determine which form to use based on horse status
            if (horse.status === 'racing') {
                // Populate racing horse form
                document.getElementById('horse-name').value = horse.name;
                document.getElementById('horse-bloodline').value = horse.bloodline;
                document.getElementById('horse-gender').value = horse.gender;
                document.getElementById('horse-stars').value = horse.stars;
                document.getElementById('horse-zed-balance').value = horse.initialZedBalance;
                document.getElementById('horse-mm-rating').value = horse.initialMmRating;
                
                if (horse.color) {
                    document.getElementById('horse-color').value = horse.color;
                }
                
                // Optional star values
                if (horse.speedStars !== null && horse.speedStars !== undefined) {
                    document.getElementById('horse-speed-stars').value = horse.speedStars;
                } else {
                    document.getElementById('horse-speed-stars').value = '';
                }
                
                if (horse.sprintStars !== null && horse.sprintStars !== undefined) {
                    document.getElementById('horse-sprint-stars').value = horse.sprintStars;
                } else {
                    document.getElementById('horse-sprint-stars').value = '';
                }
                
                if (horse.enduranceStars !== null && horse.enduranceStars !== undefined) {
                    document.getElementById('horse-endurance-stars').value = horse.enduranceStars;
                } else {
                    document.getElementById('horse-endurance-stars').value = '';
                }
                
                // Update button text
                addHorseForm.querySelector('button[type="submit"]').textContent = 'Update Racing Horse';
                
                // Scroll to the form
                document.getElementById('horses-section').scrollIntoView({ behavior: 'smooth' });
                
            } else if (horse.status === 'breeding') {
                // Populate breeding horse form
                document.getElementById('breeding-horse-name').value = horse.name;
                document.getElementById('breeding-horse-bloodline').value = horse.bloodline;
                document.getElementById('breeding-horse-gender').value = horse.gender;
                
                if (horse.color) {
                    document.getElementById('breeding-horse-color').value = horse.color;
                }
                
                // Optional star values
                if (horse.stars !== null && horse.stars !== undefined) {
                    document.getElementById('breeding-horse-stars').value = horse.stars;
                } else {
                    document.getElementById('breeding-horse-stars').value = '';
                }
                
                if (horse.speedStars !== null && horse.speedStars !== undefined) {
                    document.getElementById('breeding-horse-speed-stars').value = horse.speedStars;
                } else {
                    document.getElementById('breeding-horse-speed-stars').value = '';
                }
                
                if (horse.sprintStars !== null && horse.sprintStars !== undefined) {
                    document.getElementById('breeding-horse-sprint-stars').value = horse.sprintStars;
                } else {
                    document.getElementById('breeding-horse-sprint-stars').value = '';
                }
                
                if (horse.enduranceStars !== null && horse.enduranceStars !== undefined) {
                    document.getElementById('breeding-horse-endurance-stars').value = horse.enduranceStars;
                } else {
                    document.getElementById('breeding-horse-endurance-stars').value = '';
                }
                
                // Update button text
                addBreedingHorseForm.querySelector('button[type="submit"]').textContent = 'Update Breeding Horse';
                
                // Scroll to the form and switch to breeding tab if needed
                if (document.querySelector('.tab-button[data-tab="breeding"]') && !document.querySelector('.tab-button[data-tab="breeding"]').classList.contains('active')) {
                    activateTab('breeding');
                }
                document.getElementById('breeding-horses-section').scrollIntoView({ behavior: 'smooth' });
            }
            
            console.log(`Editing horse: ${horse.name} (${horse.status})`);
        }
        </script>
        
        <!-- Horse Details Modal Structure -->
    <div id="horse-details-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" id="modal-close-button">&times;</span>
                <h3 id="modal-horse-name">Horse Details</h3>
                <div id="modal-stats-content" class="modal-stats">
                    <!-- Basic stats loaded here -->
                </div>
                <h4>Augment Performance</h4>
                <div id="modal-analysis-content">
                    <!-- Augment analysis table loaded here -->
                </div>
            </div>
        </div>
        <script>
            // expose your inpage API client to the UI
            window.zedApi = ZED_API;
        </script>
        
        <button id="emergency-reset-btn" style="position: fixed; bottom: 20px; right: 20px; padding: 10px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; z-index: 1000;">
          Reset Application
        </button>
        
        <script>
          document.getElementById('emergency-reset-btn').addEventListener('click', function() {
            if (confirm('This will reset the application state. Continue?')) {
              window.location.reload();
            }
          });
        </script>
        <!-- Old script tags to REMOVE -->
        <!-- <script src="tabs-fix.js"></script>
        <script src="zed-auth.js"></script>
        <script src="zed-api.js"></script>
        <script src="zed-auth-ui.js"></script>
        <script src="app-fix.js"></script> -->

        <!-- Replace with these consolidated scripts -->
        <script src="scripts.js"></script>
        <script src="tabs-fix.js"></script>

        <!-- Emergency reset button -->
        <button id="emergency-reset-btn" style="position: fixed; bottom: 20px; right: 20px; padding: 10px; background: #ff5722; color: white; border: none; border-radius: 4px; cursor: pointer; z-index: 1000;">
          Reset App
        </button>

        <script>
          document.getElementById('emergency-reset-btn').addEventListener('click', function() {
            if (confirm('This will reset the application state. Continue?')) {
              window.location.reload();
            }
          });
        </script>
        <!-- Add this right before the closing </body> tag -->
        <script src="import-init.js"></script>
    </body>
    </html>