<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ§  ZED Champions AI Racing Intelligence - StableFields</title>
    <link rel="icon" href="data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20stroke%3D%22%2303dac6%22%20stroke-width%3D%222%22%3E%3Cpolyline%20points%3D%222%2C14%206%2C8%2010%2C10%2014%2C4%22%2F%3E%3C%2Fsvg%3E">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        :root {
            --primary-color: #2e86c1;
            --secondary-color: #3498db;
            --accent-color: #0EB3E3;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --error-color: #F44336;
            --background-color: #1a1a1a;
            --surface-color: #2d3748;
            --card-bg: rgba(45, 52, 54, 0.9);
            --text-color: #f0f0f0;
            --text-muted: #8e9ea9;
            --border-color: #444;
            --glow-color: rgba(14, 179, 227, 0.3);
            
            /* Bloodline Colors */
            --nakamoto-color: #FFD700;
            --szabo-color: #4169E1;
            --finney-color: #DC143C;
            --buterin-color: #9932CC;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d3748 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.8rem;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 20px var(--glow-color);
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            opacity: 0.8;
        }

        .racing-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }

        .racing-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .horse-profile {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 25px;
            margin-bottom: 25px;
            align-items: start;
        }

        .horse-avatar {
            width: 80px; height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            font-weight: bold;
            border: 3px solid rgba(255,255,255,0.2);
        }

        .horse-details h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            margin-bottom: 8px;
        }

        .horse-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bloodline-traits {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        .traits-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent-color);
        }

        .traits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .trait-tag {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .prediction-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s ease;
        }

        .prediction-card:hover {
            transform: translateY(-2px);
        }

        .prediction-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .prediction-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kit-recommendation {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .kit-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .augment-kit {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .augment-slot {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .augment-type {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .augment-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .augment-effect {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .breeding-section {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .breeding-prediction {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .breeding-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .partner-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .foal-prediction {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .stats-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-group {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 20px;
        }

        .stat-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .star-rating {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .star {
            color: #ffd700;
            font-size: 0.8rem;
        }

        .half-star {
            color: #ffd700;
            position: relative;
        }

        .race-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .insight-card {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid var(--accent-color);
        }

        .insight-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent-color);
        }

        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-link {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            color: var(--text-color);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .horse-profile { grid-template-columns: 1fr; text-align: center; }
            .predictions-grid { grid-template-columns: 1fr 1fr; }
            .augment-kit { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-brain"></i> AI Racing Intelligence</h1>
            <p>Advanced ZED Champions predictive analytics & breeding optimization</p>
            <div class="subtitle">Optimize augment kits â€¢ Predict breeding outcomes â€¢ Maximize racing performance</div>
        </div>

        <div class="navigation">
            <a href="/public/stablefields-tracker.html" class="nav-link">
                <i class="fas fa-arrow-left"></i> Back to Tracker
            </a>
            <a href="/public/search-import.html" class="nav-link">
                <i class="fas fa-download"></i> Import Horses
            </a>
            <a href="/public/quick-access.html" class="nav-link">
                <i class="fas fa-home"></i> Quick Access
            </a>
        </div>

        <div id="racing-cards-container">
            <!-- Racing cards will be populated by JavaScript -->
        </div>

        <div id="no-data" class="no-data" style="display: none;">
            <i class="fas fa-chart-line" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;"></i>
            <h3>No Racing Data Available</h3>
            <p>Import horses and record race results to unlock AI predictions</p>
            <div style="margin-top: 20px;">
                <a href="/public/search-import.html" class="nav-link">
                    <i class="fas fa-download"></i> Import Horses
                </a>
            </div>
        </div>
    </div>

    <script>
        // Enhanced ZED Champions AI Racing Intelligence Engine
        class ZEDChampionsAI {
            constructor() {
                this.horses = [];
                this.races = [];
                this.augments = this.getZEDAugments();
                this.bloodlines = this.getBloodlineData();
                this.breeding = this.getBreedingData();
            }

            // Real ZED Champions Augment System with trigger mechanics
            getZEDAugments() {
                return {
                    CPU: {
                        'None': { 
                            effect: 'No effect', 
                            condition: 'Always', 
                            strength: 0, 
                            trigger: 'automatic' 
                        },
                        'Void C100': { 
                            effect: 'Boost of 0.04 throughout the race', 
                            condition: 'Entire race', 
                            strength: 0.04, 
                            trigger: 'automatic' 
                        },
                        'Crimson C': { 
                            effect: 'Significant Speed boost in the final sprint', 
                            condition: 'Final sprint', 
                            strength: 0.08, 
                            trigger: 'conditional' 
                        },
                        'GX-Core C': { 
                            effect: 'Major Speed boost when 20M behind the leader', 
                            condition: '20M behind leader', 
                            strength: 0.12, 
                            trigger: 'conditional' 
                        },
                        'Darklight 100C': { 
                            effect: 'Strong Speed boost at the start of the race', 
                            condition: 'Race start', 
                            strength: 0.10, 
                            trigger: 'automatic' 
                        },
                        'Midnight 100C': { 
                            effect: 'Strong Speed boost in the second quarter of the race', 
                            condition: 'Second quarter', 
                            strength: 0.10, 
                            trigger: 'automatic' 
                        }
                    },
                    RAM: {
                        'None': { 
                            effect: 'No effect', 
                            condition: 'Always', 
                            strength: 0, 
                            trigger: 'automatic' 
                        },
                        'Void R100': { 
                            effect: 'Minor Speed boost for the entire race', 
                            condition: 'Entire race', 
                            strength: 0.02, 
                            trigger: 'automatic' 
                        },
                        'Crimson R': { 
                            effect: 'Major Speed boost when 7m in front of both adjacent racehorses', 
                            condition: '7m ahead of adjacent horses', 
                            strength: 0.12, 
                            trigger: 'conditional' 
                        },
                        'GX-Core R': { 
                            effect: 'Significant Speed boost when passed by an adjacent racehorse', 
                            condition: 'When passed by adjacent horse', 
                            strength: 0.08, 
                            trigger: 'conditional' 
                        },
                        'Darklight 100R': { 
                            effect: 'Strong Speed boost in the first quarter of the race', 
                            condition: 'First quarter', 
                            strength: 0.10, 
                            trigger: 'automatic' 
                        },
                        'Midnight 100R': { 
                            effect: 'Strong Speed boost in the final quarter of the race', 
                            condition: 'Final quarter', 
                            strength: 0.10, 
                            trigger: 'automatic' 
                        }
                    },
                    Hydraulic: {
                        'None': { 
                            effect: 'No effect', 
                            condition: 'Always', 
                            strength: 0, 
                            trigger: 'automatic' 
                        },
                        'Void H100': { 
                            effect: 'Minor Speed boost for the entire race', 
                            condition: 'Entire race', 
                            strength: 0.02, 
                            trigger: 'automatic' 
                        },
                        'Crimson H': { 
                            effect: 'Moderate Speed boost in the Last half of the race', 
                            condition: 'Last half', 
                            strength: 0.06, 
                            trigger: 'automatic' 
                        },
                        'GX-Core H': { 
                            effect: 'Significant Speed boost in the final sprint for 5 seconds', 
                            condition: 'Final sprint (5s)', 
                            strength: 0.08, 
                            trigger: 'conditional' 
                        },
                        'Darklight 100H': { 
                            effect: 'Moderate Speed boost in the First half of the race', 
                            condition: 'First half', 
                            strength: 0.06, 
                            trigger: 'automatic' 
                        },
                        'Midnight 100H': { 
                            effect: 'Massive Speed boost when 6m behind both adjacent racehorses', 
                            condition: '6m behind adjacent horses', 
                            strength: 0.15, 
                            trigger: 'conditional' 
                        }
                    }
                };
            }

            // ZED Champions Bloodline System
            getBloodlineData() {
                return {
                    'Nakamoto': {
                        primaryAttribute: 'Strong start',
                        traits: ['High strung', 'Nervous', 'Defensive', 'Sensitive', 'Reactive'],
                        colors: ['#FFD700', '#FFA500', '#FF8C00', '#FF6347'],
                        strengths: ['Early speed', 'Gate break'],
                        weaknesses: ['Stamina', 'Late pace'],
                        modifier: 1.1
                    },
                    'Szabo': {
                        primaryAttribute: 'Steady',
                        traits: ['Calm', 'Focused', 'Professional'],
                        colors: ['#4169E1', '#0000CD', '#191970', '#4682B4'],
                        strengths: ['Consistency', 'Pace management'],
                        weaknesses: ['Explosive speed', 'Sprint finish'],
                        modifier: 1.05
                    },
                    'Finney': {
                        primaryAttribute: 'Strong finish',
                        traits: ['Determined', 'Stubborn', 'Hungry', 'Defensive'],
                        colors: ['#8B0000', '#DC143C', '#FF0000', '#B22222'],
                        strengths: ['Late pace', 'Closing kick'],
                        weaknesses: ['Early speed', 'Gate break'],
                        modifier: 0.95
                    },
                    'Buterin': {
                        primaryAttribute: 'Unpredictable',
                        traits: ['Goofy', 'Fun', 'Playful', 'Distracted', 'Restless', 'Wildcard'],
                        colors: ['#9932CC', '#8A2BE2', '#4B0082', '#6A5ACD'],
                        strengths: ['Versatility', 'Surprise factor'],
                        weaknesses: ['Consistency', 'Predictability'],
                        modifier: 1.0
                    }
                };
            }

            // ZED Champions Breeding System
            getBreedingData() {
                return {
                    generations: {
                        1: { breedingCost: 15, inheritanceBonus: 0.95, maxOffspring: 3 },
                        2: { breedingCost: 12, inheritanceBonus: 0.90, maxOffspring: 3 },
                        3: { breedingCost: 10, inheritanceBonus: 0.85, maxOffspring: 4 },
                        4: { breedingCost: 8, inheritanceBonus: 0.80, maxOffspring: 4 },
                        5: { breedingCost: 6, inheritanceBonus: 0.75, maxOffspring: 5 },
                        6: { breedingCost: 4, inheritanceBonus: 0.70, maxOffspring: 5 },
                        7: { breedingCost: 2, inheritanceBonus: 0.65, maxOffspring: 6 },
                        8: { breedingCost: 1, inheritanceBonus: 0.60, maxOffspring: 6 }
                    },
                    starInheritance: {
                        baseInheritance: 0.7,
                        variance: 0.3,
                        maxStars: 5,
                        minStars: 0.5
                    },
                    compatibilityMatrix: {
                        'Nakamoto': { 'Nakamoto': 0.95, 'Szabo': 0.85, 'Finney': 0.90, 'Buterin': 0.80 },
                        'Szabo': { 'Nakamoto': 0.85, 'Szabo': 0.95, 'Finney': 0.85, 'Buterin': 0.90 },
                        'Finney': { 'Nakamoto': 0.90, 'Szabo': 0.85, 'Finney': 0.95, 'Buterin': 0.75 },
                        'Buterin': { 'Nakamoto': 0.80, 'Szabo': 0.90, 'Finney': 0.75, 'Buterin': 0.95 }
                    }
                };
            }

            loadData() {
                try {
                    this.horses = JSON.parse(localStorage.getItem('horses') || '[]');
                    this.races = JSON.parse(localStorage.getItem('races') || '[]');
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.horses = [];
                    this.races = [];
                }
            }

            // Calculate comprehensive horse statistics
            calculateHorseStats(horseId) {
                const horse = this.horses.find(h => h.id === horseId);
                if (!horse) return null;

                const relevantRaces = this.races.filter(r => r.horseId === horseId);
                if (relevantRaces.length === 0) return null;

                // Calculate basic statistics
                const totalRaces = relevantRaces.length;
                const wins = relevantRaces.filter(r => r.position === 1).length;
                const places = relevantRaces.filter(r => r.position === 2).length;
                const shows = relevantRaces.filter(r => r.position === 3).length;
                
                const winRate = (wins / totalRaces) * 100;
                const placeRate = (places / totalRaces) * 100;
                const showRate = (shows / totalRaces) * 100;
                const itm = ((wins + places + shows) / totalRaces) * 100;

                // Calculate financial metrics
                const zedChange = relevantRaces.reduce((sum, r) => sum + (parseFloat(r.zedChange) || 0), 0);
                const initialBalance = parseFloat(horse.initialZedBalance) || 0;
                const currentBalance = initialBalance + zedChange;
                const roi = initialBalance > 0 ? (zedChange / initialBalance) * 100 : null;

                // Recent form analysis
                const recentRaces = relevantRaces
                    .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                    .slice(0, 5);
                const recentForm = recentRaces.map(r => r.position);

                return {
                    horse,
                    totalRaces,
                    wins,
                    places,
                    shows,
                    winRate,
                    placeRate,
                    showRate,
                    itm,
                    zedChange,
                    currentBalance,
                    roi,
                    recentForm,
                    avgPosition: relevantRaces.reduce((sum, r) => sum + r.position, 0) / totalRaces
                };
            }

            // Predict optimal augment kit for fastest race times
            predictOptimalAugmentKit(horse, stats) {
                if (!stats || stats.totalRaces < 2) {
                    return {
                        CPU: 'None',
                        RAM: 'None',
                        Hydraulic: 'None',
                        confidence: 60,
                        reasoning: 'Insufficient race data for advanced predictions',
                        expectedImprovement: 'N/A'
                    };
                }

                // Analyze horse's racing patterns
                const horseRaces = this.races.filter(r => r.horseId === horse.id);
                const racePatterns = this.analyzeRacePatterns(horseRaces);
                
                // Select optimal augments based on patterns and bloodline
                const optimalKit = this.selectOptimalAugmentKit(horse, racePatterns, stats);
                
                return optimalKit;
            }

            // Analyze race patterns to determine racing style
            analyzeRacePatterns(races) {
                const patterns = {
                    avgPosition: races.reduce((sum, r) => sum + r.position, 0) / races.length,
                    earlySpeed: 0,
                    closingSpeed: 0,
                    consistency: 0,
                    struggleRate: races.filter(r => r.position > 6).length / races.length
                };

                // Analyze splits if available
                const racesWithSplits = races.filter(r => r.split1 && r.finishTime);
                if (racesWithSplits.length > 0) {
                    racesWithSplits.forEach(race => {
                        const split1 = parseFloat(race.split1);
                        const finishTime = parseFloat(race.finishTime);
                        const secondHalf = finishTime - split1;
                        
                        if (split1 < secondHalf) patterns.earlySpeed++;
                        else patterns.closingSpeed++;
                    });
                }

                return patterns;
            }

            // Select optimal augment kit based on analysis
            selectOptimalAugmentKit(horse, patterns, stats) {
                const bloodlineData = this.bloodlines[horse.bloodline];
                let cpuChoice = 'None';
                let ramChoice = 'None';
                let hydraulicChoice = 'None';
                let confidence = 70;
                let reasoning = '';

                // CPU selection based on racing style and bloodline
                if (bloodlineData?.primaryAttribute === 'Strong start' || patterns.earlySpeed > patterns.closingSpeed) {
                    cpuChoice = 'Darklight 100C'; // Strong start boost
                    reasoning += 'Early speed advantage detected. ';
                } else if (bloodlineData?.primaryAttribute === 'Strong finish' || patterns.closingSpeed > patterns.earlySpeed) {
                    cpuChoice = 'Crimson C'; // Final sprint boost
                    reasoning += 'Closing speed advantage detected. ';
                } else if (patterns.struggleRate > 0.4) {
                    cpuChoice = 'GX-Core C'; // Catchup when behind
                    reasoning += 'Recovery strategy for challenging positions. ';
                } else {
                    cpuChoice = 'Void C100'; // Consistent throughout
                    reasoning += 'Consistent performance enhancement. ';
                }

                // RAM selection
                if (patterns.avgPosition <= 3) {
                    ramChoice = 'Crimson R'; // When ahead
                    reasoning += 'Front-runner optimization. ';
                } else if (patterns.struggleRate > 0.3) {
                    ramChoice = 'GX-Core R'; // When passed
                    reasoning += 'Mid-pack recovery boost. ';
                } else {
                    ramChoice = 'Midnight 100R'; // Final quarter
                    reasoning += 'Late-race positioning. ';
                }

                // Hydraulic selection
                if (bloodlineData?.primaryAttribute === 'Strong finish') {
                    hydraulicChoice = 'GX-Core H'; // Final sprint
                } else if (patterns.struggleRate > 0.4) {
                    hydraulicChoice = 'Midnight 100H'; // When behind
                } else {
                    hydraulicChoice = 'Darklight 100H'; // First half
                }

                // Calculate expected improvement
                const totalBoost = this.augments.CPU[cpuChoice].strength + 
                                 this.augments.RAM[ramChoice].strength + 
                                 this.augments.Hydraulic[hydraulicChoice].strength;
                const expectedImprovement = `${(totalBoost * 100).toFixed(1)}% speed boost`;

                confidence = Math.min(95, 60 + (stats.totalRaces * 3));

                return {
                    CPU: cpuChoice,
                    RAM: ramChoice,
                    Hydraulic: hydraulicChoice,
                    confidence,
                    reasoning: reasoning.trim(),
                    expectedImprovement,
                    totalBoost
                };
            }

            // Predict optimal breeding pairs for 5-star foals
            predictOptimalBreeding(targetHorse) {
                const availablePartners = this.horses.filter(h => 
                    h.id !== targetHorse.id && 
                    h.gender !== targetHorse.gender &&
                    (h.status === 'breeding' || !h.status)
                );

                if (availablePartners.length === 0) {
                    return {
                        bestPartners: [],
                        recommendation: 'No suitable breeding partners available'
                    };
                }

                // Calculate breeding potential
                const breedingAnalysis = availablePartners.map(partner => {
                    const foalPrediction = this.predictFoalQualities(targetHorse, partner);
                    return { partner, foalPrediction };
                }).sort((a, b) => b.foalPrediction.starPotential - a.foalPrediction.starPotential);

                return {
                    bestPartners: breedingAnalysis.slice(0, 3),
                    recommendation: this.generateBreedingRecommendation(targetHorse, breedingAnalysis[0])
                };
            }

            // Predict foal qualities from breeding pair
            predictFoalQualities(dam, sire) {
                const damStars = parseFloat(dam.stars) || 2.5;
                const sireStars = parseFloat(sire.stars) || 2.5;
                const speedStars = ((parseFloat(dam.speed_rating) || 2.5) + (parseFloat(sire.speed_rating) || 2.5)) / 2;
                const sprintStars = ((parseFloat(dam.sprint_rating) || 2.5) + (parseFloat(sire.sprint_rating) || 2.5)) / 2;
                const enduranceStars = ((parseFloat(dam.endurance_rating) || 2.5) + (parseFloat(sire.endurance_rating) || 2.5)) / 2;

                // Calculate breeding compatibility
                const compatibility = this.breeding.compatibilityMatrix[dam.bloodline]?.[sire.bloodline] || 0.7;
                
                // Predict foal stats with variance
                const starPotential = Math.min(5, (damStars + sireStars) / 2 * compatibility + Math.random() * 0.5);
                const speedPotential = Math.min(5, speedStars * compatibility + Math.random() * 0.3);
                const sprintPotential = Math.min(5, sprintStars * compatibility + Math.random() * 0.3);
                const endurancePotential = Math.min(5, enduranceStars * compatibility + Math.random() * 0.3);

                // Calculate costs and ROI
                const avgGen = Math.ceil(((dam.generation || 5) + (sire.generation || 5)) / 2);
                const breedingCost = this.breeding.generations[avgGen]?.breedingCost || 6;
                
                // Predict ROI based on parent performance
                const damStats = this.calculateHorseStats(dam.id);
                const sireStats = this.calculateHorseStats(sire.id);
                let expectedROI = 100;
                if (damStats && sireStats) {
                    expectedROI = ((damStats.roi || 0) + (sireStats.roi || 0)) / 2 * 0.8;
                }

                return {
                    starPotential,
                    speedPotential,
                    sprintPotential,
                    endurancePotential,
                    breedingCost,
                    expectedROI,
                    compatibility,
                    foalGeneration: Math.max(dam.generation || 5, sire.generation || 5) + 1
                };
            }

            // Generate breeding recommendation text
            generateBreedingRecommendation(horse, bestMatch) {
                if (!bestMatch) return 'No suitable breeding partners found.';
                
                const partner = bestMatch.partner;
                const foal = bestMatch.foalPrediction;
                
                return `Best match: ${partner.name} (${partner.bloodline}). Expected ${foal.starPotential.toFixed(1)}â˜… foal with ${foal.expectedROI.toFixed(0)}% ROI. Cost: ${foal.breedingCost} ZED.`;
            }

            // Render star rating display
            renderStarRating(rating) {
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 >= 0.5;
                let html = '';
                
                for (let i = 0; i < fullStars; i++) {
                    html += '<i class="fas fa-star star"></i>';
                }
                if (hasHalfStar) {
                    html += '<i class="fas fa-star-half-alt half-star"></i>';
                }
                for (let i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++) {
                    html += '<i class="far fa-star star" style="opacity: 0.3;"></i>';
                }
                
                return html;
            }

            // Generate comprehensive racing card
            generateRacingCard(horse) {
                const stats = this.calculateHorseStats(horse.id);
                const kitRecommendation = this.predictOptimalAugmentKit(horse, stats);
                const breedingPrediction = this.predictOptimalBreeding(horse);
                const bloodlineData = this.bloodlines[horse.bloodline] || {};

                return this.renderEnhancedRacingCard({
                    horse,
                    stats,
                    kitRecommendation,
                    breedingPrediction,
                    bloodlineData
                });
            }

            // Render enhanced racing card with all requested features
            renderEnhancedRacingCard(data) {
                const { horse, stats, kitRecommendation, breedingPrediction, bloodlineData } = data;
                
                const formatNumber = (num, decimals = 1) => {
                    if (num === null || num === undefined) return 'N/A';
                    return Number(num).toFixed(decimals);
                };

                const getBloodlineColor = (bloodline) => {
                    const colors = {
                        'Nakamoto': '#FFD700',
                        'Szabo': '#4169E1', 
                        'Finney': '#DC143C',
                        'Buterin': '#9932CC'
                    };
                    return colors[bloodline] || '#2e86c1';
                };

                return `
                    <div class="racing-card">
                        <div class="horse-profile">
                            <div class="horse-avatar" style="background: linear-gradient(45deg, ${getBloodlineColor(horse.bloodline)}, ${horse.color || '#3498db'})">
                                ${horse.name.split(' ').map(w => w[0]).join('').substring(0, 2)}
                            </div>
                            
                            <div class="horse-details">
                                <h3>${horse.name}</h3>
                                <div class="horse-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-dna"></i>
                                        <span><strong>${horse.bloodline}</strong> - ${bloodlineData.primaryAttribute || 'Unknown'}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-star"></i>
                                        <span>${this.renderStarRating(parseFloat(horse.stars) || 2.5)} (${formatNumber(horse.stars || 2.5)})</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-venus-mars"></i>
                                        <span>${horse.gender || 'Unknown'}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-palette"></i>
                                        <span style="color: ${horse.color || '#ffffff'}">${horse.color || 'Unknown'}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-layer-group"></i>
                                        <span>Gen ${horse.generation || 'Unknown'}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-flag-checkered"></i>
                                        <span>${stats ? stats.totalRaces : 0} races</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bloodline-traits">
                                <div class="traits-title">${horse.bloodline} Traits</div>
                                <div class="traits-list">
                                    ${(bloodlineData.traits || []).map(trait => 
                                        `<span class="trait-tag">${trait}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="predictions-grid">
                            <div class="prediction-card">
                                <div class="prediction-value" style="color: var(--success-color)">${formatNumber(stats?.winRate || 15)}%</div>
                                <div class="prediction-label">Win Rate</div>
                            </div>
                            <div class="prediction-card">
                                <div class="prediction-value" style="color: var(--warning-color)">${stats?.roi ? (stats.roi > 0 ? '+' : '') + formatNumber(stats.roi) : 'N/A'}%</div>
                                <div class="prediction-label">ROI</div>
                            </div>
                            <div class="prediction-card">
                                <div class="prediction-value" style="color: var(--accent-color)">${formatNumber(stats?.avgPosition || 6)}</div>
                                <div class="prediction-label">Avg Position</div>
                            </div>
                            <div class="prediction-card">
                                <div class="prediction-value" style="color: var(--text-color)">${formatNumber(stats?.currentBalance || horse.initialZedBalance || 0)}</div>
                                <div class="prediction-label">ZED Balance</div>
                            </div>
                        </div>

                        <div class="kit-recommendation">
                            <div class="kit-title">
                                <i class="fas fa-cogs"></i>
                                Optimal Augment Kit for Fastest Times
                            </div>
                            <div class="augment-kit">
                                <div class="augment-slot">
                                    <div class="augment-type">CPU</div>
                                    <div class="augment-name">${kitRecommendation.CPU}</div>
                                    <div class="augment-effect">${this.augments.CPU[kitRecommendation.CPU]?.effect || ''}</div>
                                </div>
                                <div class="augment-slot">
                                    <div class="augment-type">RAM</div>
                                    <div class="augment-name">${kitRecommendation.RAM}</div>
                                    <div class="augment-effect">${this.augments.RAM[kitRecommendation.RAM]?.effect || ''}</div>
                                </div>
                                <div class="augment-slot">
                                    <div class="augment-type">Hydraulic</div>
                                    <div class="augment-name">${kitRecommendation.Hydraulic}</div>
                                    <div class="augment-effect">${this.augments.Hydraulic[kitRecommendation.Hydraulic]?.effect || ''}</div>
                                </div>
                            </div>
                            <div style="text-align: center; color: var(--text-muted); margin-top: 10px;">
                                <strong>Expected Improvement:</strong> ${kitRecommendation.expectedImprovement} | 
                                <strong>Confidence:</strong> ${kitRecommendation.confidence}%
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; text-align: center;">
                                ${kitRecommendation.reasoning}
                            </div>
                        </div>

                        <div class="breeding-section">
                            <div class="kit-title">
                                <i class="fas fa-heart"></i>
                                Best Breeding Pairs for 5-Star Championship Foals
                            </div>
                            ${breedingPrediction.bestPartners.length > 0 ? `
                                <div class="breeding-prediction">
                                    ${breedingPrediction.bestPartners.slice(0, 2).map(match => `
                                        <div class="breeding-card">
                                            <div class="partner-name">${match.partner.name} (${match.partner.bloodline})</div>
                                            <div class="foal-prediction">
                                                Expected: ${this.renderStarRating(match.foalPrediction.starPotential)} Overall<br>
                                                Speed: ${this.renderStarRating(match.foalPrediction.speedPotential)} | 
                                                Sprint: ${this.renderStarRating(match.foalPrediction.sprintPotential)} | 
                                                Endurance: ${this.renderStarRating(match.foalPrediction.endurancePotential)}<br>
                                                <strong>Cost:</strong> ${match.foalPrediction.breedingCost} ZED | 
                                                <strong>ROI:</strong> ${formatNumber(match.foalPrediction.expectedROI)}%
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    No suitable breeding partners available
                                </div>
                            `}
                            <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px; text-align: center;">
                                ${breedingPrediction.recommendation}
                            </div>
                        </div>

                        <div class="stats-breakdown">
                            <div class="stat-group">
                                <div class="stat-title">Performance Stats</div>
                                <div class="stat-item">
                                    <span>Win Rate:</span>
                                    <span>${formatNumber(stats?.winRate || 0)}%</span>
                                </div>
                                <div class="stat-item">
                                    <span>Place Rate:</span>
                                    <span>${formatNumber(stats?.placeRate || 0)}%</span>
                                </div>
                                <div class="stat-item">
                                    <span>Show Rate:</span>
                                    <span>${formatNumber(stats?.showRate || 0)}%</span>
                                </div>
                                <div class="stat-item">
                                    <span>In The Money:</span>
                                    <span>${formatNumber(stats?.itm || 0)}%</span>
                                </div>
                            </div>

                            <div class="stat-group">
                                <div class="stat-title">Racing Attributes</div>
                                <div class="stat-item">
                                    <span>Speed:</span>
                                    <span>${this.renderStarRating(parseFloat(horse.speed_rating) || 2.5)}</span>
                                </div>
                                <div class="stat-item">
                                    <span>Sprint:</span>
                                    <span>${this.renderStarRating(parseFloat(horse.sprint_rating) || 2.5)}</span>
                                </div>
                                <div class="stat-item">
                                    <span>Endurance:</span>
                                    <span>${this.renderStarRating(parseFloat(horse.endurance_rating) || 2.5)}</span>
                                </div>
                                <div class="stat-item">
                                    <span>Overall:</span>
                                    <span>${this.renderStarRating(parseFloat(horse.stars) || 2.5)}</span>
                                </div>
                            </div>

                            <div class="stat-group">
                                <div class="stat-title">Financial Metrics</div>
                                <div class="stat-item">
                                    <span>Starting Balance:</span>
                                    <span>${formatNumber(horse.initialZedBalance || 0)} ZED</span>
                                </div>
                                <div class="stat-item">
                                    <span>Current Balance:</span>
                                    <span>${formatNumber(stats?.currentBalance || horse.initialZedBalance || 0)} ZED</span>
                                </div>
                                <div class="stat-item">
                                    <span>Total ZED Change:</span>
                                    <span style="color: ${(stats?.zedChange || 0) >= 0 ? 'var(--success-color)' : 'var(--error-color)'}">${(stats?.zedChange || 0) >= 0 ? '+' : ''}${formatNumber(stats?.zedChange || 0)}</span>
                                </div>
                                <div class="stat-item">
                                    <span>ROI on Starting Balance:</span>
                                    <span style="color: ${(stats?.roi || 0) >= 0 ? 'var(--success-color)' : 'var(--error-color)'}">${stats?.roi ? (stats.roi >= 0 ? '+' : '') + formatNumber(stats.roi) + '%' : 'N/A'}</span>
                                </div>
                            </div>
                        </div>

                        ${stats && stats.recentForm.length > 0 ? `
                            <div class="race-insights">
                                <div class="insight-card">
                                    <div class="insight-title">Recent Form</div>
                                    <div class="insight-text">
                                        Last 5 races: ${stats.recentForm.join('-')}
                                        ${stats.recentForm.filter(p => p <= 3).length >= 3 ? ' - Strong recent performance!' : ''}
                                    </div>
                                </div>
                                <div class="insight-card">
                                    <div class="insight-title">Bloodline Advantage</div>
                                    <div class="insight-text">
                                        ${bloodlineData.primaryAttribute}: ${(bloodlineData.strengths || []).join(', ')}
                                    </div>
                                </div>
                                <div class="insight-card">
                                    <div class="insight-title">Kit Strategy</div>
                                    <div class="insight-text">
                                        ${kitRecommendation.reasoning}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Render all racing cards
            renderAllRacingCards() {
                const container = document.getElementById('racing-cards-container');
                const noDataDiv = document.getElementById('no-data');

                if (!this.horses || this.horses.length === 0) {
                    container.innerHTML = '';
                    noDataDiv.style.display = 'block';
                    return;
                }

                const racingHorses = this.horses.filter(h => h.status === 'racing' || !h.status);

                if (racingHorses.length === 0) {
                    container.innerHTML = '<div class="no-data"><h3>No Racing Horses Found</h3><p>Add horses with "racing" status to see AI predictions.</p></div>';
                    noDataDiv.style.display = 'none';
                    return;
                }

                const cards = racingHorses.map(horse => this.generateRacingCard(horse)).join('');
                container.innerHTML = cards;
                noDataDiv.style.display = 'none';
            }

            init() {
                this.loadData();
                this.renderAllRacingCards();
            }
        }

        // Initialize the enhanced AI system
        document.addEventListener('DOMContentLoaded', () => {
            const aiEngine = new ZEDChampionsAI();
            aiEngine.init();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (!document.hidden) {
                    aiEngine.loadData();
                    aiEngine.renderAllRacingCards();
                }
            }, 30000);
        });
    </script>
</body>
</html>
